"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}var HtmlMarkupReplacer=function(_CrowdinComponent){_inherits(HtmlMarkupReplacer,_CrowdinComponent);var _super=_createSuper(HtmlMarkupReplacer);function HtmlMarkupReplacer(text){var _this;var translation=arguments.length>1&&arguments[1]!==undefined?arguments[1]:undefined;_classCallCheck(this,HtmlMarkupReplacer);_this=_super.call(this);_this.regexp=/(&lt;[a-z0-9\/]+[\s\S]*?&gt;)|(&amp;lt;[a-z0-9\/]+[\s\S]*?&amp;gt;)/gim;_this.number=0;_this.tags=[];_this.translation=translation;_this.text=text.replace(/\r\n/g,"\n");if(!text){return _possibleConstructorReturn(_this)}_this.parse();return _this}_createClass(HtmlMarkupReplacer,[{key:"is_dummy",value:function is_dummy(){return!this.text}},{key:"get_tag_type",value:function get_tag_type(tag){var is_encoded=tag.substring(0,5)==="&amp;",start_index=is_encoded?8:4,end_index=is_encoded?9:5;if(tag.charAt(start_index)=="/"||tag.substring(start_index,start_index+8).toLowerCase()=="![endif]"){return"end"}if(tag.charAt(tag.length-end_index)=="/"){return"single"}return"start"}},{key:"get_tag_name",value:function get_tag_name(tag){var match=/^(&lt;|&amp;lt;)\/?([a-z:]+)/i.exec(tag);if(match&&match[2]){return match[2]}return""}},{key:"get_tag_number",value:function get_tag_number(name,type,length,find_identical){var start_tags=[];for(var i=0;i<length;i++){if(this.tags[i].name!=name){continue}if(this.tags[i].type=="start"){start_tags.push(this.tags[i])}if(this.tags[i].type=="end"&&start_tags.length>0){start_tags.pop()}if(find_identical&&this.tags[i].tag==this.tags[length].tag&&type!="end"){return this.tags[i].number}}if(type=="end"&&start_tags.length>0){return start_tags[start_tags.length-1].number}return this.number++}},{key:"get_mask",value:function get_mask(tag,encoded){if(encoded){return(tag.type==="end"?"&lt;/":"&lt;")+tag.number+(tag.type==="single"?"/&gt;":"&gt;")}else{return(tag.type==="end"?"</":"<")+tag.number+(tag.type==="single"?"/>":">")}}},{key:"parse",value:function parse(){var type,name,tags,pos,last_pos;last_pos=-1;tags=this.text.match(this.regexp);if(tags===null){return}for(var i=0;i<tags.length;i++){type=this.get_tag_type(tags[i]);name=this.get_tag_name(tags[i]).toLowerCase();pos=this.text.indexOf(tags[i],last_pos+1);last_pos=pos;this.tags.push({tag:tags[i],type:type,name:name,pos:pos,number:this.get_tag_number(name,type,i,false)})}this.combine_paired_tags();this.fix_tag_numbers()}},{key:"combine_paired_tags",value:function combine_paired_tags(){for(var i=1;i<this.tags.length;i++){if(this.tags[i].type!=="start"){continue}if(this.tags[i-1].pos+this.tags[i-1].tag.length===this.tags[i].pos){if(this.combine_paired_end_tags(this.tags[i].number,this.tags[i-1].number)){this.tags[i-1].tag+=this.tags[i].tag;this.tags[i-1].name+=", "+this.tags[i].name;this.tags.splice(i,1);this.combine_paired_tags();return}}}}},{key:"combine_paired_end_tags",value:function combine_paired_end_tags(first_num,second_num){for(var i=1;i<this.tags.length;i++){if(this.tags[i].type!="end"){continue}if(this.tags[i-1].pos+this.tags[i-1].tag.length==this.tags[i].pos){if(this.tags[i-1].number==first_num&&this.tags[i].number==second_num){this.tags[i].tag=this.tags[i-1].tag+this.tags[i].tag;this.tags[i].name=this.tags[i].name+", "+this.tags[i-1].name;this.tags[i].pos=this.tags[i-1].pos;this.tags.splice(i-1,1);return true}}}return false}},{key:"fix_tag_numbers",value:function fix_tag_numbers(){this.number=0;for(var i=0;i<this.tags.length;i++){this.tags[i].number=this.get_tag_number(this.tags[i].name,this.tags[i].type,i,true)}}},{key:"mask",value:function mask(text,encoded){var index,currentOpenTag,currentCloseTag,replaceOpenTagRegexp,replaceCloseTagRegexp;if(!text){return""}text=text.replace(/\r\n/g,"\n");for(var i=0;i<this.tags.length;i++){currentOpenTag=encoded?this.tags[i].tag:htmlspecialchars_decode(this.tags[i].tag);index=text.indexOf(currentOpenTag);currentOpenTag=currentOpenTag.replace(/&#039;/g,"'");replaceOpenTagRegexp=(this.translation||{}).is_icu?new RegExp(escapeRegExp(currentOpenTag),"g"):currentOpenTag;text=text.replace(replaceOpenTagRegexp,this.get_mask(this.tags[i],encoded));if(this.tags[i+1]&&index!==-1&&this.tags[i].type==="start"&&this.tags[i+1].type==="end"&&this.tags[i].name===this.tags[i+1].name&&this.tags[i].number===this.tags[i+1].number){currentCloseTag=encoded?this.tags[i+1].tag:htmlspecialchars_decode(this.tags[i+1].tag);index=text.indexOf(currentOpenTag,index);if(index!==-1){replaceCloseTagRegexp=(this.translation||{}).is_icu?new RegExp(escapeRegExp(currentCloseTag),"g"):currentCloseTag;text=text.replace(replaceCloseTagRegexp,this.get_mask(this.tags[i+1],encoded));i++}}}return text}},{key:"unmask",value:function unmask(text){for(var i=0;i<this.tags.length;i++){var currentTag=this.get_mask(this.tags[i],false);var replaceTagRegexp=(this.translation||{}).is_icu?new RegExp(currentTag,"g"):currentTag;text=text.replace(replaceTagRegexp,htmlspecialchars_decode(this.tags[i].tag))}return text}}]);return HtmlMarkupReplacer}(CrowdinComponent);
