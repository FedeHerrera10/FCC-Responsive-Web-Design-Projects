"use strict";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}));keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach((function(key){_defineProperty(target,key,source[key])}))}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source))}else{ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}}return target}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}var Apps=function(){function Apps(appModules){var _this=this;_classCallCheck(this,Apps);this._modules={};this._tokensStore={};if(window.host){window.host.defineGlobals({getContext:function getContext(res){if(!res._context.extension||!res._context.extension.key){return}res(_this.getContext())},getJwtToken:function getJwtToken(res){if(!res._context.extension||!res._context.extension.key){return}_this.getJwtToken(_this._modules[res._context.extension.key],res)}});window.host.defineModule("editor",{getString:function getString(res){if(!res._context.extension||!res._context.extension.key){return}res(_this.getString())},getTranslations:function getTranslations(res){if(!res._context.extension||!res._context.extension.key){return}res(_this.getTranslations())},getTopTranslation:function getTopTranslation(res){if(!res._context.extension||!res._context.extension.key){return}res(_this.getTopTranslation())}})}for(var _i2=0;_i2<appModules.length;_i2++){var appModule=appModules[_i2];this._modules[this.getId(appModule)]=appModule}}_createClass(Apps,[{key:"getRightPanelTabTpl",value:function getRightPanelTabTpl(){var modules=[];for(var appModuleKey in this._modules){var appModule=this._modules[appModuleKey];if(this.isAllowed(appModule,"editor-panels")){modules.push(appModule)}}if(!modules.length){return null}var title=_l("apps.extensions");if(modules.length===1){title=modules[0].data.name}return["li.pull-right",["a.text-overflow",{id:"crowdin_apps_tab_header",tabIndex:-1,"data-toggle":"tab",href:"#crowdin_apps_tab",title:title},["i.static-icon-widgets"]]]}},{key:"getRightPanelTabContentTpl",value:function getRightPanelTabContentTpl(){var modules=[];for(var appModuleKey in this._modules){if(this.isAllowed(this._modules[appModuleKey],"editor-panels")){modules.push(this._modules[appModuleKey])}}return[AppsPanel,{modules:modules,apps:this}]}},{key:"getId",value:function getId(appModule){return this.generateId(appModule.identifier,appModule.key)}},{key:"generateId",value:function generateId(appIdentifier,appModuleKey){return appIdentifier+"Â¦"+appModuleKey}},{key:"isAllowed",value:function isAllowed(appModule,allowedType){return appModule.type===allowedType&&appModule.modes.indexOf(crowdin.editor.mode)!==-1}},{key:"getJwtToken",value:function getJwtToken(appModule,callback){var _this2=this;if(appModule.authenticationType!=="authorization_code"){callback(null);return}if(this._tokensStore[appModule.identifier]&&!this.isJwtExpired(this._tokensStore[appModule.identifier])){callback(this._tokensStore[appModule.identifier]);return}$.ajax({type:"POST",dataType:"json",url:"/api/v2/front/applications/"+appModule.identifier+"/token",contentType:"application/json",data:JSON.stringify({type:appModule.type,projectId:crowdin.editor.project.id,context:this.getContext()}),complete:function complete(xhr){var response=JSON.parse(xhr.responseText);if(!response.error){_this2._tokensStore[appModule.identifier]=response.data.token}callback(_this2._tokensStore[appModule.identifier])}})}},{key:"parseJwtClaims",value:function parseJwtClaims(jwt){if(null===jwt||""===jwt){throw"Invalid JWT: must be neither null nor empty-string."}var firstPeriodIndex=jwt.indexOf(".");var secondPeriodIndex=jwt.indexOf(".",firstPeriodIndex+1);if(firstPeriodIndex<0||secondPeriodIndex<=firstPeriodIndex){throw'Invalid JWT: must contain 2 period (".") characters.'}var encodedClaims=jwt.substring(firstPeriodIndex+1,secondPeriodIndex);if(null===encodedClaims||""===encodedClaims){throw"Invalid JWT: encoded claims must be neither null nor empty-string."}return JSON.parse(atob(encodedClaims))}},{key:"isJwtExpired",value:function isJwtExpired(jwtString){var claims=this.parseJwtClaims(jwtString);var expires=0;var now=Math.floor(Date.now()/1e3);var skew=60;if(claims&&claims.exp){expires=claims.exp}return expires-skew<now}},{key:"getContext",value:function getContext(){return{project_id:crowdin.editor.project.id,organization_id:crowdin.editor.project.organization_id,editor:_objectSpread({mode:crowdin.editor.mode,theme:crowdin.user.settings.editor_color_theme==="default"?"light":crowdin.user.settings.editor_color_theme,source_language_id:crowdin.editor.source_language?crowdin.editor.source_language.code:null,target_language_id:crowdin.editor.target_language?crowdin.editor.target_language.code:null,file:crowdin.editor.file?crowdin.editor.file.id==="all"?crowdin.editor.file.id:+crowdin.editor.file.id:null},crowdin.editor.workflow_step.id?{workflow_step:{id:+crowdin.editor.workflow_step.id,title:crowdin.editor.workflow_step.title,type:crowdin.editor.workflow_step.type}}:{})}}},{key:"getString",value:function getString(){if(!crowdin.translation||crowdin.editor.modeAssets()){return null}var translation=crowdin.translation.get_translation();var additionalData={};if(translation.has_plurals){var pluralNames=crowdin.editor.source_language.plural_names;additionalData.plurals={};additionalData.plurals[pluralNames[1]]=translation.text;for(var i in translation.plurals){additionalData.plurals[pluralNames[i]]=translation.plurals[i]}}return _objectSpread(_objectSpread({id:+translation.id,text:translation.text,context:translation.context,max_length:+translation.max_length},additionalData),{},{file:{id:+translation.file_id,name:translation.file_name}})}},{key:"getTranslation",value:function getTranslation(suggestionId,translationId,pluralId){if(!crowdin.suggestions||crowdin.editor.modeAssets()){return null}var suggestions=crowdin.suggestions.get_suggestions(translationId,pluralId);return this.formatTranslationResponse(suggestions.length?crowdin.suggestions.get_suggestion(suggestionId,suggestions):crowdin.suggestions.get_suggestion(suggestionId))}},{key:"getTranslations",value:function getTranslations(){if(!crowdin.suggestions||crowdin.editor.modeAssets()){return null}return crowdin.suggestions.get_suggestions().map(this.formatTranslationResponse)}},{key:"getTopTranslation",value:function getTopTranslation(){if(!crowdin.suggestions||crowdin.editor.modeAssets()){return null}var suggestions=crowdin.suggestions.get_suggestions();if(suggestions.length){return this.formatTranslationResponse(suggestions[0])}return null}},{key:"formatTranslationResponse",value:function formatTranslationResponse(suggestion){var approved_at,approver,plural_form;var approved=false;var translation=crowdin.translation.get_translation(suggestion.translation_id);var workflowStepId=crowdin.editor.workflow_step.id||crowdin.user.get_workflow_proofread_step_id();if(translation.has_plurals){plural_form=crowdin.editor.target_language.plural_names[crowdin.translation.plural_id]}if(suggestion.validations[workflowStepId]&&suggestion.validations[workflowStepId].approved){approved=true;approved_at=suggestion.validations[workflowStepId].approved_date_iso;approver={id:+suggestion.validations[workflowStepId].approver.id,login:suggestion.validations[workflowStepId].approver.login,name:suggestion.validations[workflowStepId].approver.name,avatar_url:suggestion.validations[workflowStepId].approver.avatar_url}}return{id:+suggestion.id,string_id:translation.id,text:suggestion.text,votes_rating:suggestion.rating,plural_form:plural_form,approved:approved,author:{id:suggestion.user.id,login:suggestion.user.login,name:suggestion.user.name,avatar_url:suggestion.user.avatar_url},approver:approver,created_at:suggestion.date_iso,approved_at:approved_at}}}]);return Apps}();
