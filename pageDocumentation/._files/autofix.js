"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}var autofix=function(_CrowdinComponent){_inherits(autofix,_CrowdinComponent);var _super=_createSuper(autofix);_createClass(autofix,[{key:"autofix_notification_tpl",value:function autofix_notification_tpl(notification){return'<div class="autofix-notification-wrapper" validation_id="'+notification.validation_id+'">'+(notification.count>1?'<p class="notification-header text-small">'+notification.header+"</p>":"")+'<p class="notification-body">'+notification.body+"</p>"+'<div class="notification-actions clearfix">'+'<div class="pull-left btn-toolbar no-margin">'+(!notification.is_icu?'<button class="btn btn-small autofix-notification">'+_l("generic.autofix")+"</button>":"")+(notification.hasNext?'<button class="btn btn-small skip-notification">'+_l("editor.skip")+"</button>":"")+"</div>"+'<div class="pull-right btn-toolbar no-margin">'+'<button class="btn btn-small confirm-notification">'+_l("editor.saveAnyway")+"</button>"+'<button class="btn btn-small cancel-notification">'+_l("generic.cancel")+"</button>"+"</div>"+"</div>"+"</div>"}},{key:"warning_notification_tpl",value:function warning_notification_tpl(notification){var messages="<ul>";for(var i=0;i<notification.items.length;i++){messages+="<li>"+notification.items[i].message+"</li>"}messages+="</ul>";return'<div class="warning-notification-wrapper">'+(notification.count>1?'<p class="notification-header text-small">'+notification.header+"</p>":"")+messages+'<div class="notification-actions btn-toolbar no-margin">'+(!notification.hasBlocked?'<button class="btn btn-small confirm-notification">'+_l("editor.saveAnyway")+"</button>":"")+'<button class="btn btn-small cancel-notification">'+_l("generic.cancel")+"</button>"+"</div>"+"</div>"}}]);function autofix(global_scope){var _this;_classCallCheck(this,autofix);_this=_super.call(this);_this.global_scope=global_scope;_this.bind_events();return _this}_createClass(autofix,[{key:"bind_events",value:function bind_events(){var self=this;$(document).on("click",".autofix-notification",(function(e){var validation_id=$(e.target).closest(".autofix-notification-wrapper").attr("validation_id");var notification=$(this).closest(".jGrowl-notification");var validation=self.validations[validation_id];self.fix_translation(validation.fixes);notification.remove();self.remove_untouchable_validation();self.show_fix_notification(validation);self.focus();return false}));$(document).on("click",".skip-notification",(function(e){var validation_id=$(e.target).closest(".autofix-notification-wrapper").attr("validation_id");$(this).closest(".jGrowl-notification").remove();for(var i=0;i<self.validations[validation_id].fixes.length;i++){self.validations[validation_id].fixes[i].skiped=true}self.show_fix_notification(self.validations[validation_id]);self.focus();return false}));$(document).on("click",".confirm-notification",(function(){self.global_scope.save_suggestion(true);$(this).closest(".jGrowl-notification").remove();self.focus();return false}));$(document).on("click",".cancel-notification",(function(){$(this).closest(".jGrowl-notification").remove();self.focus();return false}));$(document).keyup((function(e){if(e.keyCode===27){var $jGrowl_popup=$(".autofix-notification-wrapper, .warning-notification-wrapper","#jGrowl");if($jGrowl_popup.length){$jGrowl_popup.closest(".jGrowl-notification").remove();self.focus()}}}))}},{key:"remove_untouchable_validation",value:function remove_untouchable_validation(){for(var i=0;i<this.validations.length;i++){if(this.validations[i].actual_before_changes===true){this.validations.splice(i,1);i--}}}},{key:"fix_translation",value:function fix_translation(fixes){var translation=this.global_scope.getValue();for(var i=0;i<fixes.length;i++){var fix=fixes[i];translation=unicodeSubstring(translation,0,fix.from_pos)+fix.replacement+unicodeSubstring(translation,fix.to_pos);this.update_validation_info(fix.from_pos,fix.to_pos,fix.replacement);fix.fixed=true}this.global_scope.setValue(translation,{show_jgrowl:true})}},{key:"update_validation_info",value:function update_validation_info(from_pos,to_pos,replacement){var delta=-1*(to_pos-from_pos-strlen_utf8_bytes(replacement));var is_removement=to_pos-from_pos==-1*delta;var is_insertion=to_pos-from_pos==0;for(var i=0;i<this.suggestion_fixes.length;i++){var fix=this.suggestion_fixes[i];if(fix.to_pos==-1&&fix.to_pos==-1||fix.to_pos<from_pos||fix.to_pos<=from_pos&&fix.from_pos!=fix.to_pos){continue}else if(is_insertion&&fix.to_pos-fix.from_pos==0&&fix.from_pos==to_pos&&fix.replacement.trim().length!=0){continue}else if(fix.from_pos>=to_pos){fix.from_pos+=delta;fix.to_pos+=delta}else if(fix.from_pos==from_pos&&fix.from_pos==fix.to_pos&&is_removement){continue}else if(fix.from_pos>=from_pos&&fix.to_pos<=to_pos){this.disable_fix(i)}else if(is_removement&&!fix.replacement.length){if(from_pos<=fix.from_pos&&to_pos<=fix.to_pos){this.suggestion_fixes[i].from_pos+=from_pos-fix.from_pos;this.suggestion_fixes[i].to_pos+=from_pos-to_pos}else if(fix.from_pos<=from_pos&&fix.to_pos>=from_pos){this.suggestion_fixes[i].to_pos+=from_pos-fix.to_pos}else{fix.to_pos+=delta}}else{this.disable_fix(i)}}}},{key:"disable_fix",value:function disable_fix(id){this.suggestion_fixes[id].from_pos=-1;this.suggestion_fixes[id].to_pos=-1}},{key:"show_validation_notifications",value:function show_validation_notifications(){if(this.has_blocked_validations()){this.show_blocked_notifications();return}else if(crowdin.user.settings.disable_non_blocked_validators){this.global_scope.save_suggestion(true);return}var fix_obj=null;for(var i=0;i<this.validations.length;i++){if(this.validations[i].fixes.length){fix_obj=this.validations[i];break}}if(fix_obj){this.show_fix_notification()}else{this.show_warning_notifications()}}},{key:"show_fix_notification",value:function show_fix_notification(current){var notification=this.get_next_fix_notification(current);if(notification){jGrowl_close_all();var unresolved_notifications_count=this.unresolved_notifications_count();var autofix_notifications_count=this.autofix_notifications_count(current);var header=_l("editor.nUnresolvedIssuesBold",{count:unresolved_notifications_count});var message=this.autofix_notification_tpl({header:header,body:notification.message,validation_id:$.inArray(notification,this.validations),hasNext:autofix_notifications_count>1||autofix_notifications_count!=unresolved_notifications_count,count:unresolved_notifications_count,is_icu:notification.is_icu||false});crowdin.notify(message,{sticky:true,afterOpen:function afterOpen(e){$(".notification-actions button:first").focus()}})}else{this.show_warning_notifications()}}},{key:"show_warning_notifications",value:function show_warning_notifications(){var items=[],hasBlocked=false;for(var i=0;i<this.validations.length;i++){var validation=this.validations[i];if(this.is_fix_unresolved(validation.fixes)&&(!validation.fixes.length||this.is_fix_active(validation.fixes))){items.push(validation);if(validation.block){hasBlocked=true}}}if(items.length){jGrowl_close_all();var header=_l("editor.nUnresolvedIssuesBold",{count:items.length});var message=this.warning_notification_tpl({header:header,items:items,hasBlocked:hasBlocked});crowdin.notify(message,{sticky:true,afterOpen:function afterOpen(e){$(".notification-actions button:first").focus()}})}}},{key:"show_blocked_notifications",value:function show_blocked_notifications(){var items=[];for(var i=0;i<this.validations.length;i++){if(this.validations[i].block){items.push(this.validations[i])}}if(items.length){jGrowl_close_all();var header=_l("editor.nUnresolvedIssuesBold",{count:items.length});var message=this.warning_notification_tpl({header:header,items:items,hasBlocked:true});crowdin.notify(message,{sticky:true,afterOpen:function afterOpen(e){$(".notification-actions button:first").focus()}})}}},{key:"get_next_fix_notification",value:function get_next_fix_notification(current){var return_next=false;for(var i=0;i<this.validations.length;i++){if(this.validations[i].fixes&&this.is_fix_active(this.validations[i].fixes)&&(!current||return_next)){return this.validations[i]}else if(this.validations[i].fixes&&current==this.validations[i]){return_next=true}}return null}},{key:"is_fix_active",value:function is_fix_active(fixes){var is_active=false;for(var i=0;i<fixes.length;i++){if(fixes[i].from_pos!=-1||fixes[i].to_pos!=-1){is_active=true}}return is_active}},{key:"is_fix_unresolved",value:function is_fix_unresolved(fixes){if(fixes.length==0){return true}var is_unresolved=false;for(var i=0;i<fixes.length;i++){if(!fixes[i].fixed&&!fixes[i].skiped){is_unresolved=true}}return is_unresolved}},{key:"autofix_notifications_count",value:function autofix_notifications_count(current){var count=0,need_add=false;for(var i=0;i<this.validations.length;i++){if(this.validations[i].fixes.length&&(!current||need_add)){count++}else if(current&&current==this.validations[i]){need_add=true}}return count}},{key:"unresolved_notifications_count",value:function unresolved_notifications_count(){var count=0;for(var i=0;i<this.validations.length;i++){var validation=this.validations[i];if(this.is_fix_unresolved(validation.fixes)){count++}}return count}},{key:"has_blocked_validations",value:function has_blocked_validations(){var has_blocked=false;for(var i=0;i<this.validations.length;i++){if(this.validations[i].block){has_blocked=true;break}}return has_blocked}},{key:"save_validations",value:function save_validations(validations){this.validations=validations;this.suggestion_fixes=[];for(var i=0;i<validations.length;i++){for(var j=0;j<validations[i].fixes.length;j++){this.suggestion_fixes.push(validations[i].fixes[j])}}}},{key:"focus",value:function focus(){if(this.global_scope.focus){this.global_scope.focus()}}}]);return autofix}(CrowdinComponent);
