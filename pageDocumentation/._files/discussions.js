"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}));keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach((function(key){_defineProperty(target,key,source[key])}))}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source))}else{ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}}return target}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}function _iterableToArrayLimit(arr,i){if(typeof Symbol==="undefined"||!(Symbol.iterator in Object(arr)))return;var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"]!=null)_i["return"]()}finally{if(_d)throw _e}}return _arr}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}var DiscussionsView=function(_React$Component){_inherits(DiscussionsView,_React$Component);var _super=_createSuper(DiscussionsView);function DiscussionsView(){_classCallCheck(this,DiscussionsView);return _super.apply(this,arguments)}_createClass(DiscussionsView,[{key:"componentDidMount",value:function componentDidMount(){crowdin.models.phrases.on("changed.discussions",this.phrasesChanged)}},{key:"componentWillUnmount",value:function componentWillUnmount(){crowdin.models.phrases.off("changed.discussions",this.phrasesChanged)}},{key:"componentDidUpdate",value:function componentDidUpdate(){$(ReactDOM.findDOMNode(this)).find(".message_date").momentlive()}},{key:"phrasesChanged",value:function phrasesChanged(id){if(crowdin.translation.translation_id===id){crowdin.panel.refresh()}}},{key:"getIssueMessageByType",value:function getIssueMessageByType(type){var constants=Object.entries(crowdin.editor.translation_discussions["constants"]).reduce((function(obj,_ref){var _ref2=_slicedToArray(_ref,2),key=_ref2[0],value=_ref2[1];return _objectSpread(_objectSpread({},obj),{},_defineProperty({},value,key))}),{});var issueTypeConst=constants[type];return crowdin.editor.translation_discussions["type_name"][issueTypeConst]}},{key:"render",value:function render(){var self=this;var messages=[];if(this.props.messages.length===0){return ReactCompile(["div#discussions_messages",this.noMessagesTpl()])}messages=this.props.messages.map((function(message){if(_typeof(message.user)!=="object"){message.user={id:message.user_id,name:message.user,login:message.login,avatar_url:message.avatar_url}}if(message.deleted){return self.deletedMessageTpl(message)}else{return self.messageTpl(message)}}));return ReactCompile(["div#discussions_messages",["ul",messages]])}},{key:"noMessagesTpl",value:function noMessagesTpl(){return["div.no-comments muted",_l("editor.noCommentsYes")]}},{key:"deletedMessageTpl",value:function deletedMessageTpl(message){return["li",{key:message.id,id:"discussion"+message.id},["div.media comment",["div.media-body deleted-comment muted",_l("editor.commentHasBeenDeleted")+" ",["a",{href:"#","data-id":message.id,"data-activity-id":message.activity_id,onClick:this.restoreComment},_l("generic.undo")]]]]}},{key:"messageTpl",value:function messageTpl(message){var messageLanguage={code:crowdin.language.get_item_property(message.lang_id,"code"),name:crowdin.language.get_item_property(message.lang_id,"name"),organization_id:crowdin.language.get_item_property(message.lang_id,"organization_id")};return["li",{key:message.id,id:"discussion"+message.id,className:message.issue&&!message.issue_resolved?"unresolved_issue":""},["div.media comment",this.messageAuthorAvatarTpl(message),["div.message_content media-body",["div.message_head clearfix",this.messageAuthorTpl(message)],["div.message_body selectable",{innerHTML:this.prepareText(message)}],["div.message_footer text-overflow",message.issue&&message.issue_type!==null?["div",["span",_l("editor.discussion.issue",{issue:this.getIssueMessageByType(+message.issue_type)})],message.issue_resolved?["span",{style:{marginLeft:3}},"(".concat(_l("editor.discussion.resolvedIssueLabel"),")")]:null]:null,["span.message_date",{"data-datetime":message.created_iso,"data-timeformat":TIME_AM_PM?"hh:mm A":"HH:mm"}],["span.message_actions",!IS_MOBILE&&message.id>0?this.messageActionsTpl(message):null],message.lang_id&&+crowdin.editor.project.review_language_id!==+message.lang_id?["span"+(IS_MOBILE?".message_language_mobile":".message_language"),messageLanguage.name]:null]]]]}},{key:"messageAuthorAvatarTpl",value:function messageAuthorAvatarTpl(message){var userAvatar=["img.img-rounded-2 user-avatar",{src:message.user.avatar_url,style:{width:"34px",height:"34px"}}];return["div.pull-left media-object",this.generateLink(message,userAvatar)]}},{key:"messageAuthorTpl",value:function messageAuthorTpl(message){var userName=["span",message.user.name];return["div.selectable",this.generateLink(message,userName),message.user.name!==message.user.login?["span.muted"," ("+message.user.login+")"]:null,message.step_id>1?["span.static-icon verified-user user-role",{title:message.step}]:null]}},{key:"generateLink",value:function generateLink(message,userData){if(message.user.login===REMOVED_USER_LOGIN){return userData}return["a.user-info",{href:"#","data-id":message.user.id},userData]}},{key:"findMention",value:function findMention(text,mentions){var mentionMask="crwd~>@<~crwd";for(var key in mentions){var mention=mentions[key];var string='<a class="user-info" href="#" data-id="'+mention.id+'">'+mentionMask+mention.login+"</a>";text=text.replace(new RegExp("@("+mention.login+")","g"),string)}return text.replace(new RegExp(mentionMask,"g"),"@")}},{key:"messageActionsTpl",value:function messageActionsTpl(message){var actions=[];if(message.user.id===crowdin.user.id){actions.push(["a",{onClick:this.editComment},_l("generic.edit")])}else{actions.push(["a",{"data-user":message.user.login,"data-notification-id":message.notification_id,onClick:this.replyComment},_l("generic.reply")])}if(message.issue&&!message.issue_resolved&&(crowdin.user.is_leader||message.user.id===crowdin.user.id)){actions.push(["a",{onClick:this.resolveComment},_l("generic.resolve")])}if(crowdin.user.hasManagerAccessToProject()||message.user.id===crowdin.user.id){actions.push(["a",{onClick:this.deleteComment},_l("generic.delete")])}else{var actionName=_l("editor.commentsReport"),actionAttrs={title:_l("editor.reportAbuse")};if(!message.abuse){$.extend(actionAttrs,{"data-user":message.user.login,"data-notification-id":message.notification_id,onClick:this.abuseComment})}actions.push([!message.abuse?"a":"span.muted",actionAttrs,actionName])}for(var i in actions){actions[i][1]["key"]=i;if(actions[i][0]==="a"){actions[i][1]["href"]="#";actions[i][1]["tabIndex"]=-1;actions[i][1]["data-id"]=message.id}}return actions}},{key:"editComment",value:function editComment(e){crowdin.panel.show_discussion_edit_control($(e.target).data("id"));e.preventDefault()}},{key:"replyComment",value:function replyComment(e){crowdin.panel.discussion_reply($(e.target).data("user"),$(e.target).parent().data("notification-id"));e.preventDefault()}},{key:"resolveComment",value:function resolveComment(e){crowdin.panel.discussion_resolve($(e.target).data("id"));e.preventDefault()}},{key:"deleteComment",value:function deleteComment(e){crowdin.panel.discussion_remove($(e.target).data("id"));e.preventDefault()}},{key:"restoreComment",value:function restoreComment(e){crowdin.panel.discussion_restore($(e.target).data("id"),$(e.target).data("activity-id"));e.preventDefault()}},{key:"abuseComment",value:function abuseComment(e){crowdin.panel.abuse_discussion($(e.target).data("id"));e.preventDefault()}},{key:"prepareText",value:function prepareText(message){var text=message.text;var url_pattern=/((<a href=("|'))|(<a(.*)href=("|')))?(((http|ftp|https):\/\/)[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&amp;:\/~\+#]*[\w\-\@?^=%&amp;\/~\+#])?((\([\w+\-]*\))*([\w\-\.,@?^=%&amp;:\/~\+#]*[\w\-\@?^=%&amp;\/~\+#])?)*)/gi;text=text.replace(url_pattern,(function($0,$1){return $1?$0:'<a href="'+$0+'">'+$0+"</a>"}));text=text.replace(/(^|[^\/\/])(www\.([\w\-\.,@?^=%&amp;:\/~\+#]*[\w\-\@?^=%&amp;\/~\+#])?)/gim,'<a href="http://$2">$2</a>');if(message.mentions){var mentions=Object.keys(message.mentions).map((function(i){return message.mentions[i]})).sort((function(a,b){return b.login.length-a.login.length}));text=this.findMention(text,mentions)}var span=$("<span>").html(text);span.find("a").each((function(){if($(this).attr("href")!=="#"){$(this).attr("target","_blank");$(this).attr("rel","noreferrer nofollow")}}));return span.html()}}]);return DiscussionsView}(React.Component);
