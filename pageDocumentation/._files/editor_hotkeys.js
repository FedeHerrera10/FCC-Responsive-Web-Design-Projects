"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}var crowdin_editor_hotkeys=function(_crowdin_plugin){_inherits(crowdin_editor_hotkeys,_crowdin_plugin);var _super=_createSuper(crowdin_editor_hotkeys);function crowdin_editor_hotkeys(){var _this;_classCallCheck(this,crowdin_editor_hotkeys);_this=_super.call(this,{buttonId:"#action_editor_hotkeys",hotkey:false});_this.adjustModalSize=_this.adjustModalSize.bind(_assertThisInitialized(_this));return _this}_createClass(crowdin_editor_hotkeys,[{key:"setup",value:function setup(){this.maxWidth=540;this.maxColumnItemsLength=20;this.numberOfColumns=1;if($("#editor_hotkeys_settings").length===0){$("body").append(this.getHotkeysDialog())}this.initDialog();this.initContent();this.bindEvents()}},{key:"run",value:function run(){$("#editor_hotkeys_settings").dialog("open");$("#autocomplete").closest("tr")[crowdin.user.settings.enable_autocomplete?"show":"hide"]()}},{key:"close",value:function close(){$("#editor_hotkeys_settings").dialog("close")}},{key:"bindEvents",value:function bindEvents(){var _this2=this;var onInputHotkey=function onInputHotkey(event){if((event.target||event.srcElement).tagName==="INPUT"){event.preventDefault();var hotkeyBeforeModify=crowdin.hotkeys.getHotkeyString(event);if(event.target.classList.contains("input-with-modifier")){var onlyModifiersHotkeysString=crowdin.hotkeys.allowModifiersOnly(hotkeyBeforeModify);if(!onlyModifiersHotkeysString)return;var hotkey=is_mac?crowdin.hotkeys.convertToMacView(onlyModifiersHotkeysString):onlyModifiersHotkeysString;if(hotkey){event.target.classList.remove("input-empty")}event.target.value=hotkey}else{if(crowdin.hotkeys.isDisabledHotkeys(hotkeyBeforeModify))return false;var _hotkey=is_mac?crowdin.hotkeys.convertToMacView(crowdin.hotkeys.getHotkeyString(event)):crowdin.hotkeys.getHotkeyString(event);if(_hotkey){event.target.classList.remove("input-empty")}if(_this2.checkHotkeysDublicate(_hotkey)){return false}setTimeout((function(){event.target.value=_hotkey}),0)}_this2.checkHotkeysDefault();_this2.adjustInputHelpers()}};hotkeys("*",{scope:crowdin.hotkeys.scopes.EDIT_DIALOG},onInputHotkey)}},{key:"getNextSibling",value:function getNextSibling(elem,selector){var sibling=elem.nextElementSibling;if(!selector)return sibling;while(sibling){if(sibling.matches(selector))return sibling;sibling=sibling.nextElementSibling}}},{key:"startModalResize",value:function startModalResize(){$(window).resize(this.adjustModalSize)}},{key:"endModalResize",value:function endModalResize(){$(window).off("resize",this.adjustModalSize)}},{key:"checkHotkeysDefault",value:function checkHotkeysDefault(){var editedHotkeys=this.getEditedKeys();var isDefault=true;for(var key in editedHotkeys){var _crowdin$hotkeys=crowdin.hotkeys,hotkeyHasNumberModifier=_crowdin$hotkeys.hotkeyHasNumberModifier,getModifiersPartFromHotkey=_crowdin$hotkeys.getModifiersPartFromHotkey;var defaultHotkeyBeforeModify=crowdin.hotkeys.default_hotkeys[key];var defaultHotkey=hotkeyHasNumberModifier(defaultHotkeyBeforeModify)?getModifiersPartFromHotkey(defaultHotkeyBeforeModify):defaultHotkeyBeforeModify;defaultHotkey=defaultHotkey.replace(/\+$/,"");var hotkey=is_mac?crowdin.hotkeys.convertToMacView(defaultHotkey):defaultHotkey;if(editedHotkeys[key]!==hotkey){isDefault=false;break}}$("#editor_hotkeys_settings").closest(".ui-dialog").find(".ui-button.set-default-hotkeys").button(isDefault?"disable":"enable")}},{key:"checkHotkeysDublicate",value:function checkHotkeysDublicate(hotkey){var editedHotkeys=this.getEditedKeys();for(var key in editedHotkeys){if(editedHotkeys[key]===hotkey){var _ret=function(){var dublicate_key=$("#"+key);if(dublicate_key.is(":focus")){return"continue"}dublicate_key=dublicate_key.add(dublicate_key.closest("tr"));dublicate_key.css("color","red");setTimeout((function(){dublicate_key.css("color","")}),1e3);return{v:true}}();if(_ret==="continue")continue;if(_typeof(_ret)==="object")return _ret.v}}return false}},{key:"getModalWidth",value:function getModalWidth(){var displayWidth=crowdin.editor.layout.getDocumentWidth();this.maxWidth=this.numberOfColumns*540;return displayWidth>this.maxWidth?this.maxWidth:displayWidth*.9}},{key:"adjustModalSize",value:function adjustModalSize(){$("#editor_hotkeys_settings").dialog({width:this.getModalWidth()});var dialog=$("#editor_hotkeys_settings").closest(".ui-dialog")[0];dialog.style.left="calc(50% - ".concat($(dialog).width()/2,"px)")}},{key:"adjustInputHelpers",value:function adjustInputHelpers(){var _this3=this;var inputsWithModifiers=document.querySelectorAll(".input-with-modifier");var arrOfInputsWithModifiers=[].slice.call(inputsWithModifiers,0);arrOfInputsWithModifiers.forEach((function(item){var textWidthHelper=_this3.getNextSibling(item,".text-width-helper");var modifierHelper=_this3.getNextSibling(item,".modifier-helper");textWidthHelper.innerText=item.value;if(!is_mac){modifierHelper.style.left=textWidthHelper.offsetWidth+15+"px"}else{item.style.boxSizing="border-box";item.style.paddingRight="22px";modifierHelper.style.paddingRight="8px"}}))}},{key:"initDialog",value:function initDialog(){var _this4=this;$("#editor_hotkeys_settings").dialog({autoOpen:false,width:this.getModalWidth(),resizable:false,draggable:false,modal:true,buttons:this._getButtons(),open:function open(e,ui){if(crowdin.editor.jipt_mode){$("#editor_hotkeys_settings").css({top:"0px"}).siblings(".ui-dialog-titlebar").hide()}crowdin.editor.fit_dialog($(this))}});$("#editor_hotkeys_settings").closest(".ui-dialog").find(".ui-button").eq(2).addClass("set-default-hotkeys");$("#editor_hotkeys_settings").on("dialogopen",(function(){_this4.adjustModalSize();_this4.adjustInputHelpers();_this4.startModalResize();crowdin.hotkeys.allowOnlyInputHotkey(true);hotkeys.setScope(crowdin.hotkeys.scopes.EDIT_DIALOG);$("#action_editor_hotkeys").addClass("active");_this4.checkHotkeysDefault()}));$("#editor_hotkeys_settings").on("dialogclose",(function(){_this4.endModalResize();crowdin.hotkeys.allowOnlyInputHotkey(false);hotkeys.setScope(crowdin.hotkeys.scopes.DOCUMENT);$("#action_editor_hotkeys").removeClass("active");var editedHotkeys=_this4.getEditedKeys();for(var key in editedHotkeys){var _crowdin$hotkeys2=crowdin.hotkeys,convertToMacView=_crowdin$hotkeys2.convertToMacView,hotkeyHasNumberModifier=_crowdin$hotkeys2.hotkeyHasNumberModifier,getModifiersPartFromHotkey=_crowdin$hotkeys2.getModifiersPartFromHotkey;var hotkeyBeforeModify=is_mac?crowdin.hotkeys.hotkeys_mac[key]:crowdin.hotkeys.hotkeys_other[key];var hotkeyAfterModify=hotkeyHasNumberModifier(hotkeyBeforeModify)?getModifiersPartFromHotkey(hotkeyBeforeModify):hotkeyBeforeModify;hotkeyAfterModify=hotkeyAfterModify.replace(/\+$/,"");var hotkey=is_mac?convertToMacView(hotkeyAfterModify):hotkeyAfterModify;$("#"+key).val(hotkey)}crowdin.editor.jipt_mode&&crowdin.jipt.sendMessage({msg_type:"close_hotkeys_settings"})}))}},{key:"getNumberOfColumns",value:function getNumberOfColumns(hotkeysLength){return Math.ceil(hotkeysLength/this.maxColumnItemsLength)}},{key:"renderTableRow",value:function renderTableRow(hotkey){var _crowdin$hotkeys3=crowdin.hotkeys,convertToMacView=_crowdin$hotkeys3.convertToMacView,getLastNumberFromHotkey=_crowdin$hotkeys3.getLastNumberFromHotkey,getFirstNumberFromHotkey=_crowdin$hotkeys3.getFirstNumberFromHotkey,getModifiersPartFromHotkey=_crowdin$hotkeys3.getModifiersPartFromHotkey;var row='<tr class="category-'+hotkey.category+'">';row+='<td class="no-border-top">'+(hotkey.icon?'<i class="static-icon-'+hotkey.icon+'"></i>':"")+"</td>";row+='<td class="full-width"><label for="'+hotkey.key+'">'+hotkey.label+"</label></td>";row+='<td class="editable_name '.concat(hotkey.withModifier?"with-modifier-wrapper":"",'">');var value=is_mac?convertToMacView(hotkey.value):hotkey.value;if(!hotkey.withModifier){row+='<input\n              class="input-medium '.concat(!hotkey.value?"input-empty":"",'"\n              ').concat(!hotkey.isBlocked?' onclick="this.select()"':" disabled",'\n              type="text"\n              id="').concat(hotkey.key,'"\n              onpaste="return false;"\n              value="').concat(value,'"\n              placeholder="').concat(_l("editor.emptyInputPlaceholder"),'"\n              onblur="this.placeholder = \'').concat(_l("editor.emptyInputPlaceholder"),"'\"\n              onfocus=\"this.placeholder = ''\"/>")}else{var valueWithoutNumber=getModifiersPartFromHotkey(value);valueWithoutNumber=valueWithoutNumber.replace(/\+$/,"");var firstNumber=getFirstNumberFromHotkey(value);var lastNumber=getLastNumberFromHotkey(value);row+='<input\n              class="input-medium input-with-modifier '.concat(!hotkey.value?"input-empty":"",'"\n              ').concat(!hotkey.isBlocked?' onclick="this.select()"':" disabled",'\n              type="text"\n              id="').concat(hotkey.key,'"\n              onpaste="return false;"\n              value="').concat(valueWithoutNumber,'"\n              data-modifier="{').concat(firstNumber+"-"+lastNumber,'}"\n              placeholder="').concat(_l("editor.emptyInputPlaceholder"),'"\n              onblur="this.placeholder = \'').concat(_l("editor.emptyInputPlaceholder"),"'\"\n              onfocus=\"this.placeholder = ''\"/>");row+='<span class="text-width-helper" style="position:absolute;left:-100%;visibility:hidden;">'.concat(valueWithoutNumber,"</span>");row+='<span class="modifier-helper">'.concat(!is_mac?"+":"","[").concat(firstNumber,"-").concat(lastNumber,"]</span>")}row+="</td>";row+="</tr>";return row}},{key:"initContent",value:function initContent(){var _this5=this;var content=null;var hotkeys=crowdin.hotkeys.getAvailableHotkeys();this.numberOfColumns=this.getNumberOfColumns(hotkeys.length);if(this.numberOfColumns===1){$("#editor_hotkeys_settings").dialog({width:540})}this.savedHotkeys={};if(this.numberOfColumns===1){content='<table class="table thead table-condensed no-margin" id="editor-hotkeys-table">';for(var i=0;i<hotkeys.length;i++){this.savedHotkeys[hotkeys[i].key]=hotkeys[i].value;content+=this.renderTableRow(hotkeys[i])}content+="</table>"}else if(this.numberOfColumns===2){content='<div class="two-columns-table">';content+='<table class="table thead table-condensed no-margin two-columns-table-column">';for(var j=0;j<this.maxColumnItemsLength;j++){this.savedHotkeys[hotkeys[j].key]=hotkeys[j].value;content+=this.renderTableRow(hotkeys[j])}content+="</table>";content+='<table class="table thead table-condensed two-columns-table-column">';for(var k=this.maxColumnItemsLength;k<hotkeys.length;k++){this.savedHotkeys[hotkeys[k].key]=hotkeys[k].value;content+=this.renderTableRow(hotkeys[k])}content+="</table>";content+="</div>"}if(is_mac){Object.keys(this.savedHotkeys).forEach((function(key){_this5.savedHotkeys[key]=crowdin.hotkeys.convertToMacView(_this5.savedHotkeys[key])}))}$("#editor_hotkeys_settings").html(content);this.customizeTableView(".table")}},{key:"customizeTableView",value:function customizeTableView(selector){var table=$(selector);var divider='<tr class="divider"></tr>';Object.keys(crowdin.hotkeys.categories).forEach((function(key){var categoryClassName=".category-"+crowdin.hotkeys.categories[key];table.find(categoryClassName).first().addClass("first-row");if(crowdin.hotkeys.categories[key]===1){var content='<tr class="category-1">';content+='<td class="no-border-top"></td>';content+='<td class="full-width"><label style="cursor: default">'+(crowdin.editor.modeReview()?_l("editor.switchToCorrections"):_l("editor.switchToTranslations"))+"</label></td>";content+='<td class="editable_name"><input class="input-medium" tabindex="-1" type="text" value="Tab" disabled /></td>';content+="</tr>";table.find(categoryClassName).last().after(content)}table.find(categoryClassName).last().after(divider)}));if(is_mac){$(selector).find(".input-medium").each((function(){$(this).addClass("text-right")}))}}},{key:"getEditedKeys",value:function getEditedKeys(){var result={};$("#editor_hotkeys_settings input[id]").each((function(){result[this.id]=this.value}));return result}},{key:"hotkeysWasEdited",value:function hotkeysWasEdited(editedHotkeys){for(var i in this.savedHotkeys){var _crowdin$hotkeys4=crowdin.hotkeys,hotkeyHasNumberModifier=_crowdin$hotkeys4.hotkeyHasNumberModifier,getModifiersPartFromHotkey=_crowdin$hotkeys4.getModifiersPartFromHotkey;var savedHotkey=hotkeyHasNumberModifier(this.savedHotkeys[i])?getModifiersPartFromHotkey(this.savedHotkeys[i]):this.savedHotkeys[i];savedHotkey=savedHotkey.replace(/\+$/,"");var editedHotkey=hotkeyHasNumberModifier(editedHotkeys[i])?getModifiersPartFromHotkey(editedHotkeys[i]):editedHotkeys[i];editedHotkey=editedHotkey.replace(/\+$/,"");if(savedHotkey!==editedHotkey){this.savedHotkeys=editedHotkeys;return true}}return false}},{key:"_getButtons",value:function _getButtons(){var self=this;var buttons={};buttons[_l("generic.cancel")]=function(){$("#editor_hotkeys_settings").dialog("close")};buttons[_l("generic.save")]=function(){self.saveEditorSettings()};buttons[_l("editor.setDefaults")]=function(){$("#editor_hotkeys_settings input[id]").each((function(){var _crowdin$hotkeys5=crowdin.hotkeys,hotkeyHasNumberModifier=_crowdin$hotkeys5.hotkeyHasNumberModifier,getModifiersPartFromHotkey=_crowdin$hotkeys5.getModifiersPartFromHotkey;var defaultHotkeyBeforeModify=crowdin.hotkeys.default_hotkeys[this.id];var defaultHotkey=hotkeyHasNumberModifier(defaultHotkeyBeforeModify)?getModifiersPartFromHotkey(defaultHotkeyBeforeModify):defaultHotkeyBeforeModify;defaultHotkey=defaultHotkey.replace(/\+$/,"");var hotkey=is_mac?crowdin.hotkeys.convertToMacView(defaultHotkey):defaultHotkey;var hotkeyInput=$("#"+this.id);hotkeyInput.val(hotkey);if(!hotkey){hotkeyInput.addClass("input-empty")}}));self.checkHotkeysDefault();self.adjustInputHelpers();$("#editor_hotkeys_settings").closest(".ui-dialog").find(".ui-button").eq(1).focus();crowdin.trackEvent("Editor","Editor Hotkeys","Set Default")};return buttons}},{key:"saveEditorSettings",value:function saveEditorSettings(){var self=this;var editedHotkeys=self.getEditedKeys();var save_type=is_mac?crowdin.hotkeys.keyboard_types.MACOS:crowdin.hotkeys.keyboard_types.OTHER;var reset_object=is_mac?{macos:true}:{other:true};var save_hotkeys={};if(!self.hotkeysWasEdited(editedHotkeys)){$("#editor_hotkeys_settings").dialog("close");return}for(var key in editedHotkeys){var hotkeyString=is_mac?crowdin.hotkeys.convertMacIconToTitle(editedHotkeys[key]):editedHotkeys[key];if($("#".concat(key)).hasClass("input-with-modifier")&&$("#".concat(key)).data("modifier")){hotkeyString=hotkeyString+"+".concat($("#".concat(key)).data("modifier"))}crowdin.hotkeys.set(key,hotkeyString)}save_hotkeys=$.extend({},editedHotkeys);if(is_mac){Object.keys(save_hotkeys).forEach((function(hotkeyKey){save_hotkeys[hotkeyKey]=crowdin.hotkeys.convertMacIconToTitle(save_hotkeys[hotkeyKey])}))}var default_hotkeys=true;for(var _key in save_hotkeys){if($("#".concat(_key)).hasClass("input-with-modifier")&&$("#".concat(_key)).data("modifier")){save_hotkeys[_key]=save_hotkeys[_key]+"+".concat($("#".concat(_key)).data("modifier"))}if(save_hotkeys[_key]===crowdin.hotkeys.default_hotkeys[_key]){save_hotkeys[_key]=""}else if(default_hotkeys){default_hotkeys=false}}var save_object={};save_object[save_type]=save_hotkeys;var options={hotkeys:JSON.stringify(save_object)};if(default_hotkeys){options={reset_hotkeys:JSON.stringify(reset_object)}}crowdin.ajax.postData("/user_settings/update",options,(function(response){if(!response.success){crowdin.notify(response.msg||_l("editor.hotkeysSettingsSaveError"),{type:"error"})}else{self.updateEditorHotkeys()}}),null,false,true);$("#editor_hotkeys_settings").dialog("close");crowdin.trackEvent("Editor","Editor Hotkeys","Change")}},{key:"updateEditorHotkeys",value:function updateEditorHotkeys(){crowdin.hotkeys.bindHotkeys()}},{key:"getHotkeysDialog",value:function getHotkeysDialog(){return'<div id="editor_hotkeys_settings" class="hide" title="'+_l("editor.keyboardShortcuts")+'"></div>'}}]);return crowdin_editor_hotkeys}(crowdin_plugin);
