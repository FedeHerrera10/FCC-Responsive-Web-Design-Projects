"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}var crowdin_glossary=function(_CrowdinComponent){_inherits(crowdin_glossary,_CrowdinComponent);var _super=_createSuper(crowdin_glossary);function crowdin_glossary(){var _this;_classCallCheck(this,crowdin_glossary);_this=_super.call(this);_this.words_regexp=/((?!lt;|gt;|quot;|amp;)[a-z0-9-]{2,}|<[a-z]+[^>]+>.*?<\/[a-z]+>)/gi;_this.not_search_in=/(<[a-z]+[^>]+>.*?<\/[a-z]+>)/gi;_this.is_leader=false;_this.glossary_access=false;_this.glossary_url="";_this.phrase_text="";_this.phrase_glossary=[];_this.phrase_terms=[];_this.parsed_forms={};_this.glossary=[];_this.translationMorphologies=[];_this.terms_by_name=[];_this.typing_timer=null;_this.offset=0;_this.masked_terms={};_this.maskBuilder={hash:getRandomHash(7),leftPart:function leftPart(){return";g_".concat(this.hash,"_r;")},rightPart:function rightPart(){return";r_".concat(this.hash,"_g;")},getMask:function getMask(stringHash){return"".concat(this.leftPart()).concat(stringHash).concat(this.rightPart())}};_this.currentTranslation={};_this.current_term={text:"",part_of_speech:""};_this.source_language_name=null;_this.target_language_name=null;_this.pos_mapping={};_this.term_detect_available=null;_this.request_running=false;_this.title_translation_tpl="<div>%translation%</div>";_this.title_pos_tpl="<div style='font-size: 11px; color: #A9A9A9'>%part_of_speech%</div>";_this.title_description_tpl="<div style='color: #bbb'>%description%</div>";_this.term_changes=new storage;_this.bind_events();var self=_assertThisInitialized(_this);crowdin.editor.on("updateLanguage",(function(){self.update_glossary();self.search_terms()}));return _this}_createClass(crowdin_glossary,[{key:"load",value:function load(refresh){var self=this,translation_ids=crowdin.editor.modeTranslate()?[crowdin.translation.translation_id]:crowdin.phrases.get_translation_ids();if(!crowdin.editor.target_language){return}return crowdin.ajax.getData("/glossary",{project_id:crowdin.editor.project.id,source_language_id:crowdin.editor.source_language.id,target_language_id:crowdin.editor.target_language.id,translation_ids:translation_ids},(function(data){if(data.success){for(var i=0;i<data.terms.length;i++){data.terms[i].source_term.forms=data.terms[i].source_term.forms.map((function(form){return htmlspecialchars(form)}))}self.glossary_url=data.glossary_url;self.is_leader=data.is_leader;self.glossary_access=data.glossary_access;for(var i=0;i<data.terms.length;i++){data.terms[i].uid=self.generate_uid(data.terms[i])}self.glossary=data.terms;self.translationMorphologies=data.translation_morphologies;self.source_language_name=data.source_language_name;self.target_language_name=data.target_language_name;self.pos_mapping=data.pos_mapping;self.term_detect_available=data.term_detect_available;if(refresh){self.refresh_phrase_terms()}}}))}},{key:"bind_events",value:function bind_events(){var self=this;$(document).on("click",".action_copy_text",(function(e){e.preventDefault();var inputIdNew="#".concat($(this).data("id-new"));var inputIdOld="#".concat($(this).data("id-old"));$(inputIdNew).val($(inputIdOld).val()).focus().autosize().each((function(){var evt=document.createEvent("Event");evt.initEvent("autosize:update",true,false);this.dispatchEvent(evt)}))}));$(document).on("click",".term_item",(function(e){e.stopPropagation();if(crowdin.editor.modeReviewProofread()){crowdin.phrases_list.select($(this).closest(".proofread-string-wrapper"))}if($(this).hasClass("empty_term")){self.show_edit_term_dialog($(this).attr("data-term-uid"))}else if(crowdin.translation&&$(this).attr("translation")){crowdin.translation.insertValue($(this).attr("translation"))}else{crowdin.panel.select_tab("#terms_tab");crowdin.panel.show()}}));$("#project_glossaries").on("shown",(function(){if(!is_mobile_device.any()){$("#search_terms").focus()}}));$("#terms_tab").on("click","a, button",(function(){var id=this.id;if(id==="add_new_term"){self.show_new_term_dialog();return false}else if(id.indexOf("edit_term_")!==-1){self.show_edit_term_dialog(id.replace("edit_term_",""));return false}else if(id.indexOf("remove_term_")!==-1){self.remove_term(id.replace("remove_term_",""));return false}}));$(document).on("click","#term-restore",(function(){var $el=$(this);self.restore_term($el.data("t-id"),$el.data("a-id"),$el.data("g-id"));$el.closest(".undo-alert").detach();return false}));$(document).on("click","#load_more",(function(event){self.search_terms(true);event.stopPropagation();return false}));$("#other-terms-toggler").click((function(event){$(this).toggleClass("active");var other_terms_list=$("#other-terms-list");var other_terms_loader=$("#other-terms-loader");if($(this).hasClass("active")){other_terms_list.show();other_terms_loader.removeClass("hidden")}else{other_terms_list.hide();other_terms_loader.addClass("hidden")}event.stopPropagation();return false}));$("#search_terms").on("input",(function(){self.offset=0;$(this).parent()[this.value?"addClass":"removeClass"]("has-text");if(!this.value){$("#current-list").show();$("#searched-list").hide();$("#other-terms-list").empty();self.set_other_dictionary_visibility(false)}else{clearTimeout(self.typing_timer);self.typing_timer=setTimeout(self.search_terms,500)}}));$("#search_terms").on("keydown",(function(e){if(e.which===27){if(crowdin.editor.modeTranslate()){crowdin.translation.area.focus()}else if(crowdin.editor.modeReviewProofread()){document.getElementById("phrases").focus()}else if(crowdin.editor.modeAssets()){document.getElementById("suggestions-wrapper").focus()}}}));$(document).on("click","#clear-terms-search",(function(){$("#search_terms").val("").focus().parent().removeClass("has-text");$("#current-list").show();$("#searched-list").hide();$("#other-terms-list").empty();self.set_other_dictionary_visibility(false);return false}));if(IS_MOBILE){self.bind_term_options()}}},{key:"search_terms",value:function search_terms(more){$("#load_more").parent().remove();var self=this==window?crowdin.glossary:this;var name=$.trim($("#search_terms").val());if(name!==""){$("#search_terms").parent().addClass("is-loading");if(typeof more!=="undefined"){self.offset=$("#searched-list .term").length}if(self.offset==0){self.find_wiki_terms(name)}crowdin.ajax.getData("/glossary/get_terms_by_name",{project_id:crowdin.editor.project.id,source_language_id:crowdin.editor.source_language.id,target_language_id:crowdin.editor.target_language.id,name:name,offset:self.offset},(function(data){if(name!=$.trim($("#search_terms").val())){return}$("#current-list").hide();$("#searched-list").show();$("#search_terms").parent().removeClass("is-loading");if(self.offset==0){$("#searched-list").children().remove()}else{$("#searched-list div.term:last").remove()}for(var i=0;i<data.terms.length;i++){data.terms[i].uid=self.generate_uid(data.terms[i])}self.terms_by_name=data.terms;self.render(data.terms,true,data.has_more_terms)}))}else{self.set_other_dictionary_visibility(false);$("#current-list").show();$("#searched-list").hide()}}},{key:"find_wiki_terms",value:function find_wiki_terms(name){var self=this;self.set_other_dictionary_visibility(true);$("#other-terms-loader").show();crowdin.ajax.getData("/glossary/get_wiki_terms_by_name",{project_id:crowdin.editor.project.id,target_language_id:crowdin.editor.target_language.id,name:name},(function(data){if(name!=$.trim($("#search_terms").val())){return}$("#other-terms-loader").hide();self.render_other_terms(data.terms)}))}},{key:"generateMask",value:function generateMask(){return this.maskBuilder.getMask(getRandomHash(7))}},{key:"mask_terms",value:function mask_terms(text){var term=/<span\sdata-term-id="[0-9]+"(?:\s+[\w-]+(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^"'>\s]+))?)*>.+?<\/span>/g;var self=this;return text.replace(term,(function(match){var mask=self.generateMask();self.masked_terms[mask]=match;return mask}))}},{key:"unmask_terms",value:function unmask_terms(text){if($.isEmptyObject(this.masked_terms)){return text}for(var mask in this.masked_terms){text=str_replace(mask,this.masked_terms[mask],text)}return text}},{key:"parse",value:function parse(translation,leave_phrase_terms){if(crowdin.editor.is_glossary_file){return translation.text}if(!leave_phrase_terms){this.phrase_glossary=[];this.phrase_terms=[];this.parsed_forms={};this.masked_terms={}}this.currentTranslation=translation;this.phrase_text=crowdin.highlight.mask(translation.text);this.prepare_glossary();this.phrase_glossary.map((function(term){term.source_term.complexity=term.source_term.lemma?term.source_term.lemma.split(" ").length:term.source_term.text.split(" ").length;return term}));this.phrase_glossary.sort((function(a,b){return b.source_term.complexity-a.source_term.complexity}));this._mark_duplicates_terms();this._mask_terms_in_phrase();for(var i in this.phrase_terms){var term_id=this.phrase_terms[i].term_id;for(var k=0;k<this.parsed_forms[term_id].length;k++){var light=sprintf('<span data-term-id="%s" class="term_item%s" data-term-uid="%s" title="%s" translation="%s">%s</span>',term_id,!this.phrase_terms[i].source_term.description&&!this.phrase_terms[i].target_term.text?" empty_term":"",this.phrase_terms[i].uid,this.get_title(this.phrase_terms[i],this.parsed_forms[term_id][k].text),htmlspecialchars(this.phrase_terms[i].target_term.text||""),this.parsed_forms[term_id][k].text);var maskRegex=new RegExp(this.parsed_forms[term_id][k].mask);this.phrase_text=this.phrase_text.replace(maskRegex,(function(){return light}))}}this.phrase_text=crowdin.highlight.unmask(this.phrase_text);return this.phrase_text}},{key:"getMaskedTermContent",value:function getMaskedTermContent(maskedTerm){var term=/<span\sdata-term-id="[0-9]+"(?:\s+[\w-]+(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^"'>\s]+))?)*>/g;var startSpan=maskedTerm.match(term)[0];return maskedTerm.slice(startSpan.length,-7)}},{key:"replaceMaskedTermContent",value:function replaceMaskedTermContent(maskedTerm,newContent){var term=/<span\sdata-term-id="[0-9]+"(?:\s+[\w-]+(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^"'>\s]+))?)*>/g,startSpan=maskedTerm.match(term)[0],endSpan=maskedTerm.slice(-7);return startSpan+newContent+endSpan}},{key:"prepare_glossary",value:function prepare_glossary(){for(var i in this.glossary){if(!this.glossary[i].source_term.text){continue}this.parse_terms(this.glossary[i])}}},{key:"_mask_terms_in_phrase",value:function _mask_terms_in_phrase(){var indexes=[];if(this.phrase_glossary.length===0){return}var current_complexity=this.phrase_glossary[0].source_term.complexity;for(var i in this.phrase_glossary){if(this.phrase_glossary[i].source_term.complexity===current_complexity){indexes.push(i)}else{this.mask_terms_in_phrase(indexes);indexes=[i];current_complexity=this.phrase_glossary[i].source_term.complexity}}this.mask_terms_in_phrase(indexes)}},{key:"mask_terms_in_phrase",value:function mask_terms_in_phrase(indexes){var self=this;var wordTerms=this.phrase_glossary.filter((function(term,index){return indexes.indexOf(index.toString())!==-1&&term.source_term.complexity===1}));[false,true].forEach((function(checkForms){[true,false].forEach((function(checkPartOfSpeech){[true,false].forEach((function(matchCase){self.maskTermsByToken(wordTerms,checkPartOfSpeech,matchCase,checkForms)}))}))}));var translationTerms=this.phrase_glossary.filter((function(term,index){return indexes.indexOf(index.toString())!==-1}));translationTerms.forEach((function(phraseTerm){self.maskTermByPhrase(phraseTerm,0,false,true)}));[true,false].forEach((function(matchCase){translationTerms.forEach((function(phraseTerm){self.maskFormsInPhrase(phraseTerm,matchCase)}))}))}},{key:"maskFormsInPhrase",value:function maskFormsInPhrase(term,match_case){for(var i=0;i<term.source_term.forms.length;i++){this.maskTermByPhrase(term,0,i,match_case)}}},{key:"maskTermsByToken",value:function maskTermsByToken(terms,checkPartOfSpeech,matchCase,checkForms){var self=this,offset=0;var key=this.currentTranslation.plural_id!==undefined?this.currentTranslation.id+"_"+this.currentTranslation.plural_id:this.currentTranslation.id;var tokens=self.translationMorphologies[key]!==undefined?self.translationMorphologies[key].tokens:[],postags=self.translationMorphologies[key]!==undefined?self.translationMorphologies[key].postags:[];tokens.forEach((function(token,key){token=htmlspecialchars(token);var length=token.length;var position=self.phrase_text.indexOf(token,offset);if(position===-1){return}for(var i=0;i<terms.length;i++){var term=terms[i];var forms=(checkForms?term.source_term.forms:[term.source_term.text]).map((function(form){return htmlspecialchars(form)}));var index=matchCase?forms.indexOf(token):forms.map((function(form){return form.toLowerCase()})).indexOf(token.toLowerCase());if(index===-1){continue}if(postags[key]!==term.source_term.part_of_speech&&checkPartOfSpeech===true){continue}if(crowdin.helpers.translation.is_whole_word(self.phrase_text,position,length)){self._add_duplicates_terms(term.term_id,self.phrase_glossary,self.phrase_terms);var mask=self.generateMask();self.parsed_forms[term.term_id].push({text:self.phrase_text.substr(position,length),mask:mask});self.phrase_terms.push(term);self.phrase_text=self.phrase_text.substr(0,position)+mask+self.phrase_text.substr(position+length);break}}offset+=length}))}},{key:"maskTermByPhrase",value:function maskTermByPhrase(term,offset,index,match_case){var form=index===false?htmlspecialchars(term.source_term.text):term.source_term.forms[index],length=form.length,position=-1;if(match_case){position=this.phrase_text.indexOf(form,offset)}else{position=this.phrase_text.toLowerCase().indexOf(form.toLowerCase(),offset)}if(position!==-1){if(crowdin.helpers.translation.is_whole_word(this.phrase_text,position,length)){this.phrase_terms.push(term);this._add_duplicates_terms(term.term_id,this.phrase_glossary,this.phrase_terms);var mask=this.generateMask();this.parsed_forms[term.term_id].push({text:this.phrase_text.substr(position,length),mask:mask});this.phrase_text=this.phrase_text.substr(0,position)+mask+this.phrase_text.substr(position+length);position+=mask.length-1}this.maskTermByPhrase(term,position+1,index,match_case)}}},{key:"parse_terms",value:function parse_terms(term){var forms=!term.source_term.forms?[htmlspecialchars(term.source_term.text)]:term.source_term.forms;forms_loop:for(var i=0;i<forms.length;i++){var offset=0,length=forms[i].length;while(true){var position=term.source_term.part_of_speech==="PROPN"?this.phrase_text.indexOf(forms[i],offset):this.phrase_text.toLowerCase().indexOf(forms[i].toLowerCase(),offset);if(position===-1){break}if(crowdin.helpers.translation.is_whole_word(this.phrase_text,position,length)){if(this.phrase_glossary.indexOf(term)===-1){this.phrase_glossary.push(term)}this.parsed_forms[term.term_id]=[];break forms_loop}else{offset=position+length}}}}},{key:"get_title",value:function get_title(term,text){var title="",part_of_speech=term.source_term.part_of_speech in POS_MAPPING?POS_MAPPING[term.source_term.part_of_speech]:"";if(term.source_term.text!==text){var term_text=term.source_term.text;if(term.target_term.text){term_text+=" â†’ "+term.target_term.text}title+=this.title_translation_tpl.replace("%translation%",(function(){return nl2br(htmlspecialchars(htmlspecialchars(term_text)))}))}else{if(term.target_term.text){title+=this.title_translation_tpl.replace("%translation%",(function(){return nl2br(htmlspecialchars(htmlspecialchars(term.target_term.text)))}))}}if(part_of_speech){title+=this.title_pos_tpl.replace("%part_of_speech%",(function(){return nl2br(htmlspecialchars(htmlspecialchars(part_of_speech)))}))}if(term.source_term.description||term.target_term.description){title+=this.title_description_tpl.replace("%description%",(function(){return nl2br(htmlspecialchars(htmlspecialchars(term.target_term.description||term.source_term.description)))}))}return title}},{key:"render",value:function render(terms,is_searched,has_more){if(!terms){terms=this.phrase_glossary}if(!is_searched){terms=this.sort_terms_by_apperance(terms)}var terms_html=terms.length>0?ReactDOMServer.renderToStaticMarkup(React.createElement(GlossaryView,{terms:terms,is_leader:this.is_leader,glossary_access:this.glossary_access,action:"render"})):"";if(has_more){terms_html+='<div style="padding: 15px;"><a id="load_more" class="btn btn-small btn-block" href="#">'+_l("generic.showMore")+"</a></div>"}var element=$("div#current-list");if(is_searched){element=$("div#searched-list");terms_html=element.html()+terms_html}if(terms_html){element.html(terms_html)}else{var terms_not_found_msg=$("#search_terms").val().length?_l("editor.glossaryNoMatchesForTerm"):_l("editor.noGlossaryTermsForString");element.html('<div class="no-terms muted">'+terms_not_found_msg+"</div>")}if(this.glossary_access){$("#add_new_term").parent().removeClass("hidden");if(this.glossary_url.length!==0){$("#manage-terms-link").removeClass("hidden").attr("href",this.glossary_url)}}else{$("#add_new_term").parent().addClass("hidden")}}},{key:"render_other_terms",value:function render_other_terms(terms){var element=$("div#other-terms-list");var terms_html=terms?ReactDOMServer.renderToStaticMarkup(React.createElement(GlossaryView,{terms:terms,action:"render_other"})):null;if(terms_html){element.html(terms_html)}else{element.html('<div class="no_suggestions_yet">'+_l("editor.noInfoAboutTerm")+"</div>")}}},{key:"update_glossary",value:function update_glossary(){$("#terms_editor .target-term-language").text(crowdin.editor.target_language.name);this.load(true)}},{key:"show_new_term_dialog",value:function show_new_term_dialog(init_text){var data={url:"/glossary/add_term",term_id:0,source_term:{text:init_text||"",part_of_speech:"",description:""},target_term:{text:"",description:""},dialog_title:_l("editor.addTermTitle"),button_title:_l("generic.add"),success_msg:_l("editor.addTermSuccess")};crowdin.glossary.show_dialog(data,"new_term")}},{key:"show_edit_term_dialog",value:function show_edit_term_dialog(uid){var terms=this.terms_by_name.length>0?this.glossary.concat(this.terms_by_name):this.glossary,term=this.get_term_by_uid(uid,terms),data={uid:term.uid,url:"/glossary/edit_term",glossary_id:term.glossary_id,glossary_name:term.glossary_name,show_name_of_glossary:term.show_name_of_glossary,is_project_glossary:term.is_project_glossary,term_id:term.term_id,source_term:term.source_term,target_term:term.target_term,editable:term.editable,dialog_title:_l("editor.editTerm"),button_title:_l("generic.save"),success_msg:_l("editor.editTermSuccess")};crowdin.glossary.show_dialog(data,"edit_term")}},{key:"show_update_term_dialog",value:function show_update_term_dialog(uid){var terms=this.terms_by_name.length>0?this.glossary.concat(this.terms_by_name):this.glossary;var term=this.get_term_by_uid(uid,terms);var oldTermData={uid:term.uid,url:"/glossary/edit_term",glossary_id:term.glossary_id,glossary_name:term.glossary_name,show_name_of_glossary:term.show_name_of_glossary,is_project_glossary:term.is_project_glossary,term_id:term.term_id,editable:term.editable,source_term:$.extend({},term.source_term,{description_old:term.source_term.description}),target_term:$.extend({},term.target_term,{text_old:term.target_term.text,description_old:term.target_term.description}),dialog_title:_l("editor.updateTerm"),button_title:_l("termsPopup.reviewChanges.update"),success_msg:_l("editor.updateTermSuccess")};var newTermData=this.term_changes.get(term.uid);crowdin.glossary.show_dialog($.extend(true,{},oldTermData,newTermData),"update_term")}},{key:"show_dialog",value:function show_dialog(data,type){this.refreshEditorTermDialog(data,type);var sourceTerm=data.source_term,targetTerm=data.target_term,dialogTitle=data.dialog_title;var showSourceDescriptionOld=Boolean(sourceTerm.description_old);var showTargetTextOld=Boolean(targetTerm.text_old);var showTargetDescriptionOld=Boolean(targetTerm.description_old);$("#editor-source-term-text").val(sourceTerm.text);$("#editor-source-term-pos").val(sourceTerm.part_of_speech);$("#editor-source-term-description").val(sourceTerm.description);$("#editor-source-term-description-old").val(sourceTerm.description_old||"").parents(".control-group").toggle(showSourceDescriptionOld).parent().find(".badge").toggle(showSourceDescriptionOld);$("#editor-target-term-text").val(targetTerm.text||"");$("#editor-target-term-text-old").val(targetTerm.text_old||"").parents(".control-group").toggle(showTargetTextOld).parent().find(".badge").toggle(showTargetTextOld);$("#editor-target-term-description").val(targetTerm.description||"");$("#editor-target-term-description-old").val(targetTerm.description_old||"").parents(".control-group").toggle(showTargetDescriptionOld).parent().find(".badge").toggle(showTargetDescriptionOld);$("#terms_editor").dialog({title:dialogTitle,autoOpen:true,width:500,resizable:false,draggable:!IS_MOBILE,modal:true,open:function open(e,ui){crowdin.editor.fit_dialog($(this));$("#editor-source-term-text").focus();$("#terms_editor textarea").autosize().each((function(){var evt=document.createEvent("Event");evt.initEvent("autosize:update",true,false);this.dispatchEvent(evt)}))},buttons:this._getButtons(data)});$("#terms_editor form").crowdinValidator({rules:{editor_source_term_text:{name:"editor-source-term-text"},editor_source_term_pos:{name:"editor-source-term-pos"},editor_source_term_description:{name:"editor-source-term-description",required:false,require_from_group:[1,".term_required"]},editor_target_term_text:{name:"editor-target-term-text",required:false,require_from_group:[1,".term_required"]},editor_target_term_description:{name:"editor-target-term-description",required:false,require_from_group:[1,".term_required"]}},onkeyup:true}).data("validator").resetForm()}},{key:"_getButtons",value:function _getButtons(data){var self=this;var buttons={};buttons[_l("generic.cancel")]=function(){$(this).dialog("close")},buttons[data.button_title]=function(){if(self.request_running)return;if($("#terms_editor form").valid()){var _getSourceTerm=function _getSourceTerm(){var term=$("#editor-source-term-text").val();return $.extend({},data.source_term,{text:term,part_of_speech:$("#editor-source-term-pos").val(),description:$("#editor-source-term-description").val()})};var _getTargetTerm=function _getTargetTerm(){return $.extend({},data.target_term,{text:$("#editor-target-term-text").val(),description:$("#editor-target-term-description").val()})};var _editTerm=function _editTerm(restore){var $item=$("#term_"+data.uid);if($item.length){var term_obj={uid:data.uid,term_id:data.term_id,glossary_id:data.glossary_id,glossary_name:data.glossary_name,show_name_of_glossary:data.show_name_of_glossary,is_project_glossary:data.is_project_glossary,editable:data.editable,source_term:restore?data.source_term:_getSourceTerm(),target_term:restore?data.target_term:_getTargetTerm()};$item.replaceWith(ReactDOMServer.renderToStaticMarkup(React.createElement(GlossaryView,{terms:[term_obj],is_leader:self.is_leader,glossary_access:self.glossary_access,action:"edit"})))}};var _notifyAboutDuplicate=function _notifyAboutDuplicate(text,partOfSpeech){_editTerm(true);crowdin.notify(_l("editor.duplicateTermDetectedAndCannotBeEdited",{text:text,partOfSpeech:partOfSpeech}))};var _confirmUpdateTerm=function _confirmUpdateTerm(text,partOfSpeech,uid){var msg=_l("editor.reviewTermConfirm",{text:text,partOfSpeech:partOfSpeech});confirm_action(msg,[{title:_l("termsPopup.reviewChanges.review"),class_name:""}],(function(confirmed){if(confirmed){$("#terms_editor").dialog("close");self.show_update_term_dialog(uid);self.term_changes.remove(uid)}}))};var _makeRequest=function _makeRequest(forceCreate){self.request_running=true;var requestData={project_id:crowdin.editor.project.id,target_language_id:crowdin.editor.target_language.id,glossary_id:data.glossary_id,term_id:data.term_id,source_term:JSON.stringify(_getSourceTerm()),target_term:JSON.stringify(_getTargetTerm())};var isCreate=parseInt(data.term_id)===0;if(isCreate&&forceCreate){requestData.force=forceCreate}crowdin.ajax.postData(data.url,requestData,(function(response){self.request_running=false;if(response.success){if(response.already_existing_terms.length>0){var existingTerm=response.already_existing_terms[0];if(!isCreate){_notifyAboutDuplicate(existingTerm.text,existingTerm.part_of_speech_full)}if(isCreate){var uid="".concat(existingTerm.glossary_id,"_").concat(existingTerm.term_id,"_0");self.term_changes.set(uid,{source_term:_getSourceTerm(),target_term:_getTargetTerm()});_confirmUpdateTerm(existingTerm.text,existingTerm.part_of_speech_full,uid)}}else{crowdin.notify(data.success_msg);self.load(true)}$("#terms_editor").dialog("close")}else{_editTerm(true);var message=response.msg||_l("error.internalError");crowdin.notify(message,{type:"error"})}}))};_editTerm();_makeRequest()}};return buttons}},{key:"remove_term",value:function remove_term(uid){var self=this;var terms=this.terms_by_name.length>0?this.glossary.concat(this.terms_by_name):this.glossary;var term=this.get_term_by_uid(uid,terms);crowdin.ajax.getData("/glossary/remove_terms",{project_id:crowdin.editor.project.id,target_language_id:crowdin.editor.target_language.id,glossary_id:term.glossary_id,term_ids:term.term_id},(function(data){if(data.success){var notifyOptions={};if(data.term_id){var message=_l("editor.deleteTermSuccess")+" "+sprintf('<a href="#" id="term-restore" data-t-id="%d" data-a-id="%d" data-g-id="%d">%s</a>',data.term_id,data.activity_id,data.glossary_id,_l("activity.undo"));notifyOptions.sticky=true;notifyOptions.beforeOpen=function(e){$("#jGrowl").find(".undo-alert").detach();e.addClass("undo-alert")};crowdin.notify(message,notifyOptions)}self.load(true);self.search_terms()}else{crowdin.notify(data.msg||_l("error.internalError"),{type:"error"})}}))}},{key:"restore_term",value:function restore_term(term_id,activity_id,glossary_id){var self=this;crowdin.ajax.getData("/glossary/restore_term",{project_id:crowdin.editor.project.id,target_language_id:crowdin.editor.target_language.id,term_id:term_id,glossary_id:glossary_id,activity_id:activity_id},(function(response){if(response.success){self.load(true);self.search_terms()}}))}},{key:"refresh_phrase_terms",value:function refresh_phrase_terms(){crowdin.editor.view.setState({updatePhrases:true});if(crowdin.editor.modeTranslate()){this.render()}if(crowdin.editor.modeReviewProofread()){crowdin.translation.refresh_glossaries()}}},{key:"sort_terms_by_apperance",value:function sort_terms_by_apperance(terms){var self=this,result=[],$html=$("#source_phrase_container .term_item, #source_plural_container .plurals .term_item, .proofread-string-wrapper.checked .term_item");$html.each((function(){if($(this).attr("data-term-uid")){var term=self.get_term_by_uid($(this).attr("data-term-uid"),terms);if(term&&result.indexOf(term)===-1){result.push(term);self._add_duplicates_terms(term.term_id,terms,result);terms.splice(terms.indexOf(term),1)}}}));return result.concat(terms)}},{key:"set_other_dictionary_visibility",value:function set_other_dictionary_visibility(visible){if(visible){$("#other-terms-toggler").parent().show();if($("#other-terms-toggler").hasClass("active")){$("#other-terms-list").show()}}else{$("#other-terms-toggler").parent().hide();$("#other-terms-list").hide()}crowdin.panel.force_fit()}},{key:"get_phrase_glossary",value:function get_phrase_glossary(translation){this.phrase_glossary=[];var text=crowdin.helpers.translation.prepareText(translation,false);this.phrase_text=crowdin.highlight.mask(text);this.prepare_glossary();if(translation.has_plurals){for(var i in translation.plurals){this.phrase_text=crowdin.highlight.mask(translation.plurals[i]);this.prepare_glossary()}}return this.phrase_glossary}},{key:"_mark_duplicates_terms",value:function _mark_duplicates_terms(){var unique_terms=[],current_term,key;for(var i in this.phrase_glossary){current_term=this.phrase_glossary[i];key=unique_terms.indexOf(current_term.source_term.text);if(key===-1){unique_terms[current_term.uid]=current_term.source_term.text}else{this.phrase_glossary[i].parent_term=key}}}},{key:"_add_duplicates_terms",value:function _add_duplicates_terms(term_id,terms,result){for(var i in terms){if(terms[i].parent_term==term_id){result.push(terms[i])}}}},{key:"bind_term_options",value:function bind_term_options(){var self=this;$("#terms-list").on("click",".term[id]",(function(e){if(self.glossary_access){var uid=this.id.replace("term_","");var term=self.get_term_by_uid(uid,self.terms_by_name.length>0?self.glossary.concat(self.terms_by_name):self.glossary);if(!term.is_external_glossary){$(this).addClass("tap");self.show_term_options(uid)}}}));$(document).on("click","a.mobile-term-option",(function(e){crowdin.editor.layout.hideModalMenu();var uid=$(this).closest(".modal-menu").data("id");switch($(this).data("action")){case"edit":self.show_edit_term_dialog(uid);break;case"delete":self.remove_term(uid);break}e.preventDefault()}))}},{key:"show_term_options",value:function show_term_options(uid){if(!uid){return}var html="";var getItem=function getItem(text,action){return""+"<li>"+'<a href="javascript:void(0)" tabindex="-1" class="mobile-term-option" data-uid = "'+uid+'" data-action="'+action+'">'+text+"</a>"+"</li>"};html+=getItem(_l("generic.edit"),"edit");html+=this.is_leader?getItem('<span class="text-danger-red">'+_l("generic.delete")+"</span>","delete"):"";$("#terms_options").data({id:uid}).html(html);crowdin.editor.layout.showModalMenu("#terms_options")}},{key:"refreshEditorTermDialog",value:function refreshEditorTermDialog(termData,dialogType){var editTermDialogData={source_language_name:crowdin.glossary.source_language_name,target_language_name:crowdin.glossary.target_language_name,term_detect_available:crowdin.glossary.term_detect_available,pos_mapping:crowdin.glossary.pos_mapping,term_data:termData,dialog_type:dialogType};crowdin.editor.view.setState({editTermDialogData:editTermDialogData,updatePhrases:false})}},{key:"generate_uid",value:function generate_uid(term){return term.glossary_id+"_"+term.term_id+"_"+ +term.is_external_glossary}},{key:"get_term_by_uid",value:function get_term_by_uid(uid,terms){return terms.filter((function(term){return term.uid===uid}))[0]}},{key:"toggle_glossary_tab",value:function toggle_glossary_tab(){if(!crowdin.editor.layout.isOpened("right")){crowdin.panel.toggle_panel()}$("#project_glossaries").tab("show");$("#search_terms").focus()}}]);return crowdin_glossary}(CrowdinComponent);
