"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}var crowdin_highlight=function(_CrowdinComponent){_inherits(crowdin_highlight,_CrowdinComponent);var _super=_createSuper(crowdin_highlight);function crowdin_highlight(){var _this;_classCallCheck(this,crowdin_highlight);_this=_super.call(this);_this.pattern='<span dir="auto" class="crowdin_highlight %s" title="%s">%s</span>';_this.pattern_icu='<span class="crowdin_highlight icu_light %s">%s</span>';_this.default_class_selector=".crowdin_highlight";_this.rules=[];_this.ICU_TYPE="icu";_this.PLACEHOLDERS_TYPE="placeholders";_this.mask_number=0;_this.masks={icu:[],placeholders:[]};_this.maskBuilder={hash:getRandomHash(7),leftPart:function leftPart(){return";h_".concat(this.hash,"_t;")},rightPart:function rightPart(){return";t_".concat(this.hash,"_h;")},getMask:function getMask(stringHash){return"".concat(this.leftPart()).concat(stringHash).concat(this.rightPart())}};_this.mapping=[];_this.init_regexps();_this.activate_symbol();return _this}_createClass(crowdin_highlight,[{key:"init_regexps",value:function init_regexps(){if(this.rules.length){this.rules=[]}for(var type in HIGHLIGHT){this[type]=HIGHLIGHT[type];if(type==="icu"){continue}var rule={exp:new RegExp(HIGHLIGHT[type].join("|"),type==="spaces"?"gm":"g"),type:type,title:this._get_title(type),light:this._get_light(type),replace:this._get_replace(type)};if(type===this.PLACEHOLDERS_TYPE){this.rules.unshift(rule)}else{this.rules.push(rule)}}if(crowdin.editor.check_show_placeholders()){this.rules.push({exp:/(&lt;[a-z0-9\/]+[\s\S]*?&gt;)/gim,type:"replaced_markup",title:"",light:"tag_light",replace:""})}}},{key:"activate_symbol",value:function activate_symbol(){var self=this;$(document).off("click",this.default_class_selector).on("click",this.default_class_selector,(function(e){e.stopPropagation();if(crowdin.editor.modeReviewProofread()){crowdin.phrases_list.select($(this).closest(".proofread-string-wrapper"))}if($(this).hasClass("br_light")){crowdin.translation.insertValue("\n");return}var placehoderText=$(this).text(),placeholderNode=$(e.target);while(placeholderNode.parent(self.default_class_selector).length){placehoderText=placeholderNode.parent(self.default_class_selector).text();placeholderNode=placeholderNode.parent(self.default_class_selector)}crowdin.translation.insertValue(placehoderText)}))}},{key:"light",value:function light(text,markup_tags){var self=this;var rules=this.rules;text=this.light_cdata(text);self.addElementsFromHighlightedText(text);for(var i=0;i<rules.length;i++){if(this.skip_type(rules[i].type)){continue}text=text.replace(rules[i].exp,(function(match){var replace=rules[i].replace?rules[i].replace:match;var title=rules[i].title;if(rules[i].type==="html_entities"){title=self._getHTMLEntityTitle(title,replace)}if(rules[i].type==="replaced_markup"){var tag={};tag.type=replace.match(/&lt;\d+&gt;/)?"start":replace.match(/&lt;\/\d+&gt;/)?"end":"single";tag.number=parseInt(replace.replace(/[^0-9]/g,""),10);for(var j=0;j<markup_tags.length;j++){if(tag.number===markup_tags[j].number&&tag.type===markup_tags[j].type){title=htmlspecialchars(markup_tags[j].tag)}}}var highlight=htmlEntitiesDecode(replace.replace(self.getHighlightedContentRegex(),""));if(rules[i].type==="spaces"){highlight=rules[i].exp}self.mapping.push({highlight:highlight,className:rules[i].light});return sprintf(self.pattern,rules[i].light,title,replace)}))}return text}},{key:"skip_type",value:function skip_type(type){var skipType=false;if(type==="line_break"&&crowdin.editor.getBaseFileType()!=="html"){skipType=true}if(type==="html_tags"&&crowdin.editor.check_show_placeholders(crowdin.translation.translation_id)){skipType=true}return skipType}},{key:"light_icu",value:function light_icu(text,icu_elements){return this.process_icu(text,icu_elements,this._light_including_icu.bind(this),this._light_icu_element_nested_message.bind(this))}},{key:"process_icu",value:function process_icu(text,icu_elements,mask_icu_function,mask_icu_element_nested_message){var type,type_by_priority=["messageFormatElement","pluralFormatPattern","selectFormatPattern","elementFormat","simpleFormatPattern","offsetFormat"];for(var i=0;i<type_by_priority.length;i++){var type=type_by_priority[i];switch(type){case"messageFormatElement":for(var j in icu_elements[type]){text=mask_icu_function(type,text,icu_elements[type][j])}break;case"pluralFormatPattern":case"selectFormatPattern":for(var k in icu_elements[type]){for(var j in icu_elements[type][k]){text=mask_icu_function(type,text,icu_elements[type][k][j])}}break;case"elementFormat":case"offsetFormat":case"simpleFormatPattern":for(var j in icu_elements[type]){text=mask_icu_element_nested_message(text,type,icu_elements[type][j])}break}}return text}},{key:"_light_including_icu",value:function _light_including_icu(type,text,icu_element){var self=this;var reg=new RegExp(self._get_icu_reg(type,icu_element));var start_postion=text.search(reg);if(start_postion!==-1){var nested_level=0;for(var p=start_postion;p<text.length;p++){if(text[p]==="{"){nested_level++}if(text[p]==="}"){nested_level--;if(nested_level===0){var plural_pattern=text.substring(start_postion,p);text=text.substring(0,p)+sprintf(self.pattern_icu,self._get_icu_light(type),"}")+text.substring(p+1);if(type==="pluralFormatPattern"){plural_pattern=plural_pattern.replace(new RegExp("(\\#)"),sprintf(self.pattern_icu,"icu_placeholder","$1"));text=text.substring(0,start_postion)+plural_pattern+text.substring(p)}break}}}}this.handleTextareaLightIncludingIcu(type,icu_element);this.addElementsFromHighlightedText(text);return text.replace(reg,sprintf(self.pattern_icu,self._get_icu_light(type),"$1"))}},{key:"_light_icu_element_nested_message",value:function _light_icu_element_nested_message(text,type,icu_element){var reg=new RegExp(this._get_icu_reg(type,icu_element));this.mapping.push({highlight:new RegExp("\\b"+icu_element+"\\b|\\B"+icu_element+"\\B","gi"),className:"icu_light "+this._get_icu_light(type)});return text.replace(reg,"$1"+sprintf(this.pattern_icu,this._get_icu_light(type),"$2"))}},{key:"light_cdata",value:function light_cdata(text){var self=this;var light=this._get_light("xml_tags");var title=this._get_title("xml_tags");var CDATA={open:"&lt;![CDATA[",close:"]]&gt;"};return text.replace(/&lt;!\[CDATA\[((.|\n)*?)\]\]&gt;/g,(function(all_match,cdata_content){self.mapping.push({highlight:/<!\[CDATA\[|\n*?(\]\]>)$/g,className:light,type:"cdata"});return sprintf(self.pattern,light,title,CDATA.open)+cdata_content+sprintf(self.pattern,light,title,CDATA.close)}))}},{key:"_get_title",value:function _get_title(type){switch(type){case"html_tags":return _l("highlight.tagsShouldNotBeTranslated");case"xml_tags":return _l("highlight.xmlTagsNoTranslateNotice");case"html_entities":return _l("highlight.htmlTagsNoTranslateNotice");case"line_break":return _l("highlight.thisIsLineBreak");case"placeholders":return _l("highlight.variablesNoTranslateNotice");case"specialchars":return _l("highlight.specSymbolsNoTranslateNotice");case"spaces":return _l("highlight.spaceCharsNoTranslateNotice");case"non_breaking":return _l("highlight.nonBreakingNamespacesNotice");case"tabs":return _l("highlight.tabShouldNotBeTranslated");default:return""}}},{key:"_get_light",value:function _get_light(type){switch(type){case"html_tags":return"tag_light";case"xml_tags":return"tag_light";case"html_entities":return"tag_light";case"line_break":return"br_light";case"placeholders":return"placeholder_light";case"specialchars":return"special_light";case"spaces":return"space_light";case"non_breaking":return"space_light";case"tabs":return"tab_light";default:return""}}},{key:"_get_icu_light",value:function _get_icu_light(type){switch(type){case"messageFormatElement":return"icu_placeholder";case"elementFormat":return"icu_type";case"pluralFormatPattern":return"icu_style";case"selectFormatPattern":return"icu_style";case"simpleFormatPattern":return"icu_style";case"offsetFormat":return"icu_offset";default:return""}}},{key:"_get_icu_reg",value:function _get_icu_reg(type,icu_element){if(typeof icu_element==="string"){icu_element=preg_quote(icu_element,"/")}switch(type){case"messageFormatElement":return"({\\s*"+icu_element+'(?:,\\s*(?=(plural|select|selectordinal|choice|number|date|time|spellout|ordinal|duration))|(?:}|<span class="crowdin_highlight icu_light icu_placeholder">}</span>)))';case"elementFormat":return'(<span class=\\"crowdin\\_highlight icu\\_light(?:.*)\\">(?:.*)</span>)((.*)('.concat(icu_element,",+)(?!(?:<\\/span>|").concat(crowdin.glossary.maskBuilder.rightPart(),"))|(.*)(").concat(icu_element,'(?=<span class=\\"crowdin\\_highlight icu\\_light)))');case"pluralFormatPattern":return"(\\=*-?".concat(icu_element,"\\s*\\{)(?!(?:<\\/span>|").concat(crowdin.glossary.maskBuilder.rightPart(),"))");case"selectFormatPattern":return"(\\=*-?".concat(icu_element,"\\s*\\{)(?!(?:<\\/span>|").concat(crowdin.glossary.maskBuilder.rightPart(),"))");case"simpleFormatPattern":return'(<span class=\\"crowdin\\_highlight icu\\_light(?:.*)\\">(?:.*))('.concat(icu_element,")(?!(?:<\\/span>|").concat(crowdin.glossary.maskBuilder.rightPart(),"))");case"offsetFormat":return'(<span class=\\"crowdin\\_highlight icu\\_light(?:.*)\\">(?:.*))('.concat(icu_element,")(?!(?:<\\/span>|").concat(crowdin.glossary.maskBuilder.rightPart(),"))");default:return""}}},{key:"_get_replace",value:function _get_replace(type){switch(type){case"line_break":return"&nbsp;&nbsp;";default:return""}}},{key:"_getHTMLEntityTitle",value:function _getHTMLEntityTitle(title,entity){var result=entity.replace("&amp;","&");result=htmlEntitiesDecode(result);var suggestedTitle=this._checkHTMLEntity(result);if(suggestedTitle){return suggestedTitle}if(result.length===1){return entity}return title}},{key:"_checkHTMLEntity",value:function _checkHTMLEntity(entity){switch(entity){case"":return _l("highlight.startOfHeading");case"":return _l("highlight.startOfText");case"":return _l("highlight.endOfText");case"":return _l("highlight.endOfTransmission");case"":return _l("generic.enquiry");case"":return _l("generic.acknowledge");case"":return _l("generic.bell");case"\b":return _l("generic.backspace");case"\t":return _l("highlight.horizontalTabulation");case"\n":return _l("highlight.newLine");case"\v":return _l("highlight.verticalTabulation");case"\f":return _l("highlight.formFeed");case"\r":return _l("highlight.carriageReturn");case"":return _l("highlight.shiftOut");case"":return _l("highlight.shiftIn");case"":return _l("highlight.dataLinkEscape");case"":return _l("highlight.deviceControlN",{num:1});case"":return _l("highlight.deviceControlN",{num:2});case"":return _l("highlight.deviceControlN",{num:3});case"":return _l("highlight.deviceControlN",{num:4});case"":return _l("highlight.negativeAcknowledge");case"":return _l("highlight.synchronousIdle");case"":return _l("highlight.endOfTransmissionBlock");case"":return _l("generic.cancel");case"":return _l("highlight.endOfMedium");case"":return _l("generic.substitute");case"":return _l("generic.escape");case"":return _l("highlight.fileSeparator");case"":return _l("highlight.groupSeparator");case"":return _l("highlight.recordSeparator");case"":return _l("highlight.unitSeparator");case" ":return _l("generic.space");case"":return _l("generic.delete");case" ":return _l("highlight.noBreakSpace");case"­":return _l("highlight.softHyphen");default:return""}}},{key:"mask",value:function mask(text){text=this.mask_icu(text);return this.mask_placeholders(text)}},{key:"mask_icu",value:function mask_icu(text){if(text.match(new RegExp(sprintf(this.pattern_icu,"\\w+","(.*?)")))===null){return text}var complete;while(complete=text.match(new RegExp(sprintf(this.pattern_icu,"\\w+","(.*?)")))){var matches=complete[0].match(new RegExp(sprintf(this.pattern_icu,"\\w+","(.*?)"),"g"));if(!matches){break}text=this.mask_matches(text,matches,this.ICU_TYPE,complete[0])}return text}},{key:"mask_placeholders",value:function mask_placeholders(text){var unmasked=["icu","tabs","spaces"];for(var i in this.rules){var type=this.rules[i].type;var regExp=this.rules[i].exp;if(unmasked.indexOf(type)===-1){var pattern=regExp;var matches=text.match(pattern);text=this.mask_matches(text,matches,this.PLACEHOLDERS_TYPE)}}return text}},{key:"mask_matches",value:function mask_matches(text,matches,type,complete_match){var tmp_text=type===this.ICU_TYPE?complete_match:text,masked_text=type===this.ICU_TYPE?complete_match:text;if(!matches){return text}for(var i=0;i<matches.length;i++){var mask=this._get_mask();masked_text=str_replace(matches[i],mask,masked_text);this.masks[type][mask]=matches[i]}return type===this.ICU_TYPE?str_replace(tmp_text,masked_text,text):masked_text}},{key:"_get_mask",value:function _get_mask(){return this.maskBuilder.getMask(this.mask_number++)}},{key:"unmask",value:function unmask(text){var types=Object.keys(this.masks).reverse();for(var type in types){var type_keys=Object.keys(this.masks[types[type]]).reverse();for(var key in type_keys){text=str_replace(type_keys[key],this.masks[types[type]][type_keys[key]],text)}}this.resetMasks();return text}},{key:"resetMasks",value:function resetMasks(){this.mask_number=0;this.masks={icu:[],placeholders:[]}}},{key:"addElementsFromHighlightedText",value:function addElementsFromHighlightedText(text){var div=document.createElement("div");div.innerHTML=text;var spans=div.getElementsByClassName("crowdin_highlight");var skipList=["}","]]>"];for(var i=0;i<spans.length;i++){if(in_array(spans[i].textContent,skipList)){continue}var _text=spans[i].textContent;try{_text=new RegExp("\\b"+_text+"\\b","gi")}catch(e){}this.mapping.push({highlight:_text,className:spans[i].getAttribute("class")})}}},{key:"handleTextareaLightIncludingIcu",value:function handleTextareaLightIncludingIcu(type,icuElement){var icuReg=this._get_icu_reg(type,icuElement);var regExp=new RegExp(icuReg,"gi");this.mapping.push({highlight:function highlight(input){if(!input){return false}var m;var res=[];while((m=regExp.exec(input))!==null){if(m.index===regExp.lastIndex){regExp.lastIndex++}if(in_array(m.index,res)){break}res.push(m.index)}var positions=[];for(var startIndex in res){var startPos=res[startIndex];var nestLvl=0;for(var position=startPos;position<input.length;position++){if(input[position]==="{"){nestLvl++}if(input[position]==="}"){nestLvl--;if(nestLvl===0){positions.push([position,position+1])}}}}return positions},className:"icu_light "+this._get_icu_light(type),icu_type:type});this.mapping.push({highlight:new RegExp("\\#","gi"),className:"icu_light icu_placeholder"});this.mapping.push({highlight:new RegExp(htmlEntitiesDecode(icuReg).replace(this.getHighlightedContentRegex(),""),"gi"),className:"icu_light "+this._get_icu_light(type)})}},{key:"getHighlightedContentRegex",value:function getHighlightedContentRegex(){return/<\/?span[^>]*>|<?span class="crowdin_highlight[^>]*>/g}}]);return crowdin_highlight}(CrowdinComponent);
