"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}));keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach((function(key){_defineProperty(target,key,source[key])}))}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source))}else{ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}}return target}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}var IcuPreview=function(_React$Component){_inherits(IcuPreview,_React$Component);var _super=_createSuper(IcuPreview);function IcuPreview(props){var _this;_classCallCheck(this,IcuPreview);_this=_super.call(this,props);_this.state={id:null,value:null,cache:{}};_this.icuParamsMapping=[];_this.shouldFormatIcuElements=false;return _this}_createClass(IcuPreview,[{key:"componentDidMount",value:function componentDidMount(){crowdin.editor.icu_preview=this}},{key:"getSuggestion",value:function getSuggestion(){var suggestion=$(this.props.area_selector).val()||"";suggestion=sanitizer.tags(suggestion,["meta","base","iframe","object","embed","script","style","isindex","applet","form"]);suggestion=sanitizer.attributes(suggestion);return suggestion}},{key:"getTranslation",value:function getTranslation(){return crowdin.translation}},{key:"render",value:function render(){var _this2=this;if(!this.props.translation.is_icu){return ReactCompile(["div",{key:"empty-div"}])}var targetLanguageCode=crowdin.editor.modeReview()?crowdin.editor.source_language.code:crowdin.editor.target_language.code;this.icuParser=new MessageFormatLight(targetLanguageCode);var translation=this.getTranslation();var ast=this.icuParser.checkErrorIcuFormat(this.getSuggestion());translation.icu_error={};return ReactCompile(["div",{key:"icu-preview",id:"icu_preview",style:{marginBottom:crowdin.editor.modeReviewProofread()?7:0}},["div.clearfix editor-pane-title-and-buttons",{style:{paddingTop:crowdin.editor.modeReviewProofread()?0:7}},["div.pull-left icu_header",_l("generic.preview")],ast.name==="SyntaxError"?["div.pull-right",{id:"icu_error"},["a.icu_error_button",{href:"#",onClick:function onClick(e){e.preventDefault();$(_this2.props.area_selector).get(0).setSelectionRange(translation.icu_error.offset,translation.icu_error.offset);$(_this2.props.area_selector).focus();return false}},_l("editor.icuError")]]:null],["div",{id:"content_preview"},this.syntaxErrorTpl(ast),this.emptyPreviewTpl(ast),this.icuPreviewTpl(ast)]])}},{key:"syntaxErrorTpl",value:function syntaxErrorTpl(ast){if(ast.name==="SyntaxError"){this.getTranslation().icu_error=ast;return["div.icu-preview-message",["pre",_l("editor.syntaxError2D"),["br"],ast.message]]}return null}},{key:"emptyPreviewTpl",value:function emptyPreviewTpl(ast){if(ast.messageFormatElement===false){var message=typeof ast.string!=="undefined"?ast.string[0]:_l("editor.enterTranslationToSeePreview");return["div.icu-preview-message",["pre",message]]}return null}},{key:"icuPreviewTpl",value:function icuPreviewTpl(ast){var result=["div.inline-block"];if(ast.name==="SyntaxError"||ast.messageFormatElement===false){return result}if(this.shouldFormatIcuElements){this.formatIcuElements(this.getSuggestion());this.shouldFormatIcuElements=false}if(crowdin.editor.modeReviewProofread()){var translation=this.getTranslation();if(!translation.icu_params.icu_elements){return result}}result.push(["div.icu-preview-message",{id:"preview_place",style:{direction:crowdin.editor.target_language.text_direction}},this.getIcuPreviewMessage(this.state.id,this.state.value,ast)],["hr.line-break"],["div.icu-inputs-block",{style:{direction:crowdin.editor.target_language.text_direction}},this.getInputsBlock()]);return result}},{key:"getInputsBlock",value:function getInputsBlock(){var _this3=this;var icuParams=this.getTranslation().icu_params;var result=[];var onChange=function onChange(e){_this3.setState({id:e.target.id,value:e.target.value,cache:_objectSpread(_objectSpread({},_this3.state.cache),{},_defineProperty({},e.target.id,e.target.value))})};for(var i=0;i<icuParams.icu_elements.pairs.length;i++){var pairsValue=icuParams.icu_elements.pairs[i][0];var pairsType=icuParams.icu_elements.pairs[i][1];result.push(["div.inline-block",{key:"icu_elements"}]);var inputValue=void 0;switch(pairsType){case"plural":case"number":result[i].push(["label.icu_placeholder",{for:pairsValue},this.icuParser.unmask(pairsValue)]);inputValue=this.state.cache.hasOwnProperty(pairsValue)?this.state.cache[pairsValue]:this.getInputValueByPairsType(icuParams,pairsType,pairsValue);result[i].push(["input",{onChange:onChange,type:"number",id:pairsValue,placeholder:pairsType,step:"any",value:inputValue}]);break;case"date":result[i].push(["label.icu_placeholder",{for:pairsValue},this.icuParser.unmask(pairsValue)]);inputValue=this.state.cache.hasOwnProperty(pairsValue)?this.state.cache[pairsValue]:this.getInputValueByPairsType(icuParams,pairsType,pairsValue);result[i].push(["input",{onChange:onChange,type:"date",id:pairsValue,placeholder:moment().format("YYYY-MM-DD"),value:inputValue}]);break;case"time":result[i].push(["label.icu_placeholder",{for:pairsValue},this.icuParser.unmask(pairsValue)]);inputValue=this.state.cache.hasOwnProperty(pairsValue)?this.state.cache[pairsValue]:this.getInputValueByPairsType(icuParams,pairsType,pairsValue);result[i].push(["input",{onChange:onChange,type:"time",id:pairsValue,placeholder:moment().format("hh:mm"),value:inputValue}]);break;default:result[i].push(["label.icu_placeholder",{for:pairsValue},this.icuParser.unmask(pairsValue)]);var selectOptions=[];for(var j=0;j<icuParams.icu_elements["".concat(pairsType,"FormatPattern")][pairsValue].length;j++){var optionValue=icuParams.icu_elements["".concat(pairsType,"FormatPattern")][pairsValue][j];var attribute=icuParams.temp_data_pairs.get("".concat(pairsType,"_").concat(pairsValue))==icuParams.icu_elements["".concat(pairsType,"FormatPattern")][pairsValue][j]?"selected":"";var value=icuParams.icu_elements["".concat(pairsType,"FormatPattern")][pairsValue][j];selectOptions.push(["option",{key:optionValue,value:optionValue,selected:attribute==="selected"},value])}result[i].push(["select",{onChange:onChange,id:pairsValue,placeholder:pairsType},selectOptions]);break}}for(var _i=0;_i<icuParams.icu_elements.placeholders.length;_i++){var onlyPlaceholder=true;var placeholder=icuParams.icu_elements.placeholders[_i];for(var _j=0;_j<icuParams.icu_elements.pairs.length;_j++){if(icuParams.icu_elements.pairs[_j][0]===placeholder){onlyPlaceholder=false}}if(onlyPlaceholder){var _inputValue=icuParams.temp_data_placeholders.get(placeholder)||this.icuParser.unmask(placeholder);_inputValue=this.state.cache.hasOwnProperty(placeholder)?this.state.cache[placeholder]:_inputValue;result.push(["div.inline-block",{key:"only-placeholder-key"},["label.icu_placeholder",{for:placeholder},this.icuParser.unmask(placeholder)],["input",{onChange:onChange,type:"text",id:placeholder,placeholder:this.icuParser.unmask(placeholder),value:_inputValue}]])}}return result}},{key:"getInputValueByPairsType",value:function getInputValueByPairsType(icuParams,pairsType,pairsValue){var mapping={plural:function plural(){return icuParams.temp_data_pairs.get("".concat(pairsType,"_").concat(pairsValue))||0},number:function number(){return icuParams.temp_data_pairs.get("".concat(pairsType,"_").concat(pairsValue))||0},date:function date(){return icuParams.temp_data_pairs.get("".concat(pairsType,"_").concat(pairsValue))||moment().format("YYYY-MM-DD")},time:function time(){return icuParams.temp_data_pairs.get("".concat(pairsType,"_").concat(pairsValue))||moment().format("hh:mm")},select:function select(){return icuParams.temp_data_pairs.get("".concat(pairsType,"_").concat(pairsValue))||null}};if(mapping.hasOwnProperty(pairsType)){return mapping[pairsType]()}return null}},{key:"getIcuPreviewMessage",value:function getIcuPreviewMessage(id,value,ast){var icuParams=this.getTranslation().icu_params;if(ast.messageFormatElement===false){return null}var obj={};if(!id&&!value){for(var i in icuParams.elementFormat){for(var j=0;j<icuParams.icu_elements.pairs.length;j++){var pairsValue=icuParams.icu_elements.pairs[j][0];var pairsType=icuParams.icu_elements.pairs[j][1];if(icuParams.icu_elements.pairs[j][1]===icuParams.elementFormat[i]){var _value=this.getInputValueByPairsType(icuParams,pairsType,pairsValue);if(null===_value){_value=$("#"+jquery_quote(icuParams.icu_elements.pairs[j][0],"\\")).val()}icuParams.icu_elements.pairs[j].data=_value}}}}else{for(var _i2=0;_i2<icuParams.icu_elements.pairs.length;_i2++){if(icuParams.icu_elements.pairs[_i2][0]===id){icuParams.icu_elements.pairs[_i2].data=value;icuParams.temp_data_pairs.set(icuParams.icu_elements.pairs[_i2][1]+"_"+icuParams.icu_elements.pairs[_i2][0],value)}}}if(icuParams.icu_elements.placeholders!=="undefined"){for(var _i3=0;_i3<icuParams.icu_elements.placeholders.length;_i3++){var text="",$placeholder=$("#"+jquery_quote(icuParams.icu_elements.placeholders[_i3],"\\"));if(!$placeholder.get(0)){text=icuParams.temp_data_placeholders.get(icuParams.icu_elements.placeholders[_i3])||this.icuParser.unmask(icuParams.icu_elements.placeholders[_i3])}else{if($placeholder.val()==icuParams.icu_elements.placeholders[_i3]){text="{"+$placeholder.val()+"}"}else{text=$placeholder.val()}}obj[this.icuParser.unmask(icuParams.icu_elements.placeholders[_i3])]=text;icuParams.temp_data_placeholders.set(icuParams.icu_elements.placeholders[_i3],text)}}for(var _i4=0;_i4<icuParams.icu_elements.pairs.length;_i4++){obj[this.icuParser.unmask(icuParams.icu_elements.pairs[_i4][0])]=icuParams.icu_elements.pairs[_i4].data}var suggestion=this.getSuggestion();var mf=this.icuParser.compile(suggestion);return["pre",mf(obj)]}},{key:"formatIcuElements",value:function formatIcuElements(text){var targetLanguage=crowdin.editor.modeReview()?crowdin.editor.source_language.code:crowdin.editor.target_language.code;var icu_parser=new MessageFormatLight(targetLanguage);var translation=this.getTranslation();translation.icu_params.icu_elements=icu_parser.getIcuElements(icu_parser.parse(text));translation.icu_params.elementFormat=[];translation.icu_params.variables=[];if(typeof translation.icu_params.icu_elements.elementFormat==="undefined"){return false}for(var i=0;i<translation.icu_params.icu_elements.elementFormat.length;i++){if(translation.icu_params.elementFormat.indexOf(translation.icu_params.icu_elements.elementFormat[i])===-1){translation.icu_params.elementFormat.push(translation.icu_params.icu_elements.elementFormat[i])}}if(typeof translation.icu_params.icu_elements.messageFormatElement==="undefined"){return false}for(var _i5=0;_i5<translation.icu_params.icu_elements.messageFormatElement.length;_i5++){if(translation.icu_params.variables.indexOf(translation.icu_params.icu_elements.messageFormatElement[_i5])===-1){translation.icu_params.variables.push(translation.icu_params.icu_elements.messageFormatElement[_i5])}}return true}}]);return IcuPreview}(React.Component);
