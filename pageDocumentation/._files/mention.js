"use strict";function initMention(textarea,participants){textarea.atwho({at:"@",data:participants,maxLen:30,alias:textarea.attr("id"),searchKey:["login","name"],displayTpl:'<li class="clearfix">'+'<img src="${avatar_url}" alt="" style="width: 24px; margin-top: 4px; border-radius: 50%;" class="pull-left s-margin-right">'+'<div style="overflow: hidden;"><div class="text-overflow">${login}</div><small style="display: block" class="text-overflow">${name}<small></div>'+"</li>",insertTpl:"@${login}",limit:5,callbacks:{matcher:function matcher(flag,subtext,should_startWithSpace,acceptSpaceBar){var _a,_y,match,regexp,space,searched_text=null;flag=flag.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");if(should_startWithSpace){flag="(?:^|\\s)"+flag}_a=decodeURI("%C3%80");_y=decodeURI("%C3%BF");space=acceptSpaceBar?" ":"";regexp=new RegExp(flag+"([A-Za-z"+_a+"-"+_y+"0-9_"+space+"\\-!%^&*()_+|~=`{}[\\]:\";'<>?,./\\@]*)$|"+flag+"([^\\x00-\\xff]*)$","gi");match=regexp.exec(subtext);if(match){searched_text=match[2]||match[1];var textarea_value=this.$inputor.val();var caret_position=this.$inputor.textareaHelper("getOriginalCaretPos");var text_after_caret=textarea_value.slice(caret_position);var regexp=new RegExp("[^\\s]*");var word_ending=regexp.exec(text_after_caret);if(word_ending){searched_text=searched_text+word_ending[0]}}return searched_text},beforeInsert:function beforeInsert(value,$li){var textarea_value=this.$inputor.val();var caret_position=this.$inputor.textareaHelper("getOriginalCaretPos");var text_after_caret=textarea_value.slice(caret_position);var regexp=new RegExp("[^\\s]*");var word_ending=regexp.exec(text_after_caret);if(word_ending){var new_textarea_value=textarea_value.substr(0,caret_position)+textarea_value.substr(caret_position+word_ending[0].length+1);this.app.$inputor.val(new_textarea_value)}return value},beforeReposition:function beforeReposition(offset){var caret_offset,input_offset,overflowOffset,_window;_window=this.app.iframeAsRoot?this.app.window:window;var textarea_value=this.app.$inputor.val();var caret_position=this.$inputor.textareaHelper("getOriginalCaretPos");var text_before_caret=textarea_value.slice(0,caret_position);var regexp_before_caret=new RegExp("@[^\\s]*$");var word_start=regexp_before_caret.exec(text_before_caret);if(word_start){caret_position=caret_position-word_start[0].replace("@","").length}caret_offset=textarea.textareaHelper("caretPos",caret_position);input_offset=this.app.$inputor.offset();offset.top=caret_offset.top+input_offset.top-this.view.$el.height()-2;offset.left=caret_offset.left+input_offset.left-15;if(offset.left>(overflowOffset=$(_window).width()-this.view.$el.outerWidth()-5)){offset.left=overflowOffset}return offset},filter:function filter(query,data,search_keys){var _results,i,j,item,key,data_len,keys_len;_results=[];for(i=0,data_len=data.length;i<data_len;i++){item=data[i];for(j=0,keys_len=search_keys.length;j<keys_len;j++){key=search_keys[j];if(item[key].toLowerCase().indexOf(query.toLowerCase())>-1){_results.push(item);break}}}if(_results.length==1){var textarea_value=this.$inputor.val();var caret_position=this.$inputor.textareaHelper("getOriginalCaretPos");var text_before_caret=textarea_value.slice(0,caret_position);var text_after_caret=textarea_value.slice(caret_position);var regexp_before_caret=new RegExp("@[^\\s]*$");var regexp_after_caret=new RegExp("[^\\s]*");var word_start=regexp_before_caret.exec(text_before_caret);var word_end=regexp_after_caret.exec(text_after_caret);var word="";if(word_start&&word_end){word=word_start[0].replace("@","")+word_end[0]}if(query.length>0&&_results[0]["login"]===word){return null}}return _results},sorter:function sorter(query,items,search_keys){var _results,multiplier,i,j,item,key,items_len,keys_len;if(!query){return items}_results=[];for(i=0,items_len=items.length;i<items_len;i++){item=items[i];for(j=0,keys_len=search_keys.length;j<keys_len;j++){multiplier=Math.pow(j+1,3);key=search_keys[j];if(new String(item[key]).toLowerCase().indexOf(query.toLowerCase())>-1){item.atwho_order=(new String(item[key]).toLowerCase().indexOf(query.toLowerCase())+1)*multiplier;_results.push(item);break}}}return _results.sort((function(a,b){return a.atwho_order-b.atwho_order}))},highlighter:function highlighter(li,query){var regexp;if(!query){return li}query=htmlspecialchars(query);regexp=new RegExp(">([^<]*?)("+query.replace(/[\(\)\[\]\*\+\.\&\/\\]/gi,"\\$&")+")([^<]*)<","ig");return li.replace(regexp,(function(str,$1,$2,$3){return"> "+$1+'<span class="match">'+$2+"</span>"+$3+" <"}))}}})}
