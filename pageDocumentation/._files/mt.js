"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}var crowdin_mt_model=function(_CrowdinComponent){_inherits(crowdin_mt_model,_CrowdinComponent);var _super=_createSuper(crowdin_mt_model);function crowdin_mt_model(){var _this;_classCallCheck(this,crowdin_mt_model);_this=_super.call(this);_this.storage=new storage;_this.mtSuggestionsTemplate={mts:{}};_this.tmSuggestionsTemplate={tm:[],global_tm:[],external_tm:[]};var self=_assertThisInitialized(_this);crowdin.models.phrases.on("load",(function(id){self.refresh(id)}));crowdin.editor.on("clearModels",(function(render){self.storage.clear();if(render){self.invoke("load",crowdin.translation.translation_id)}}));return _this}_createClass(crowdin_mt_model,[{key:"getProviders",value:function getProviders(){return{google:{logo:"google-translate",user:_l("generic.googleTranslate")},deepl:{logo:"deepl-translator",user:_l("generic.deeplTranslator")},watson:{logo:"watson-translator",user:_l("generic.watsonTranslator")},amazon:{logo:"amazon-translate",user:_l("generic.amazonTranslate")},yandex:{logo:"yandex-translator",user:_l("generic.poweredBy")+" "+_l("generic.yandexTranslate")},crowdin:{logo:"crowdin-translate",user:_l("generic.crowdinTranslate")},bing:{logo:"microsoft-translator",user:_l("generic.microsoftTranslator")},google_automl:{logo:"google-automl-translate",user:_l("generic.googleAutoMLTranslate")}}}},{key:"getProvider",value:function getProvider(provider){var providers=this.getProviders();return providers[provider]}},{key:"phrases",value:function phrases(id,target_plural_id,fields){var plural_id=target_plural_id;if(typeof fields==="undefined"){return this._get_phrases(id,plural_id)}else{return this.addPhrases(id,plural_id,fields)}}},{key:"_get_phrases",value:function _get_phrases(id,plural_id){var data=this.storage.get(id);var phrases=data&&data[plural_id]?data[plural_id]:{};return $.extend({},this.mtSuggestionsTemplate,this.tmSuggestionsTemplate,phrases)}},{key:"addPhrases",value:function addPhrases(id,plural_id,fields){if($.isEmptyObject(fields)){return}var self=this,phrases=this._get_phrases(id,plural_id);if(fields.mts){phrases["mts"]=$.extend({},phrases.mts,fields.mts)}else{$.extend(phrases,fields)}var data=this.storage.get(id)||{};data[plural_id]=phrases;this.storage.set(id,data);this.invoke("load",parseInt(id));var intersectKeys=Object.keys(fields).filter((function(provider){return Object.keys(self.tmSuggestionsTemplate).indexOf(provider)>-1}));if(intersectKeys.length!==0){this.invoke("loadTmSuggestions",parseInt(id))}}},{key:"_plurals_to_load",value:function _plurals_to_load(){return crowdin.editor.target_language.plural_ids}},{key:"refresh",value:function refresh(id){var self=this;var plural_ids=[];var translation=crowdin.translation.get_translation(id);this.invoke("load.start",parseInt(id));if(translation.has_plurals){plural_ids=this._plurals_to_load()}else{plural_ids.push(-1)}this.refresh_plural(id,plural_ids[0],translation);var index=1;var total=plural_ids.length;var _preloadInterval=setInterval((function(){if(index>=total){clearInterval(_preloadInterval)}else{self.refresh_plural(id,plural_ids[index++],translation)}}),400)}},{key:"getTmSuggestionByUid",value:function getTmSuggestionByUid(uid,translationId,pluralId){var mtSuggestions=this.phrases(translationId,pluralId);for(var tmType in crowdin.models.mt.tmSuggestionsTemplate){for(var i=0;i<mtSuggestions[tmType].length;i++){if(mtSuggestions[tmType][i].uid===uid){return mtSuggestions[tmType][i]}}}return null}},{key:"updateTmSuggestion",value:function updateTmSuggestion(suggestion,translationId,pluralId){var mtSuggestions=this.phrases(translationId,pluralId);pointer:for(var tmType in crowdin.models.mt.tmSuggestionsTemplate){for(var i=0;i<mtSuggestions[tmType].length;i++){if(mtSuggestions[tmType][i].uid===suggestion.uid){mtSuggestions[tmType][i]=suggestion;break pointer}}}var data=this.storage.get(translationId)||{};data[pluralId]=mtSuggestions;this.storage.set(translationId,data);this.invoke("load",parseInt(translationId));this.invoke("loadTmSuggestions",parseInt(translationId))}},{key:"_get_text",value:function _get_text(translation,plural_id){var text=translation.text;if(plural_id!==-1&&translation.has_plurals&&Object.keys(translation.plurals).length){var source_plural_id=crowdin.editor.target_language.plurals_mapping[plural_id];if(translation.plurals[source_plural_id]){text=translation.plurals[source_plural_id]}}return text}},{key:"refresh_plural",value:function refresh_plural(id,plural_id,translation){var self=this;var loaded=this.storage.has(id)&&this.storage.get(id)[plural_id]?true:false;var text=self._get_text(translation,plural_id);var raw_text=htmlspecialchars_decode(strip_tags(text));var is_icu=translation.translation_type=="2";if(!text.length){return}var tmParams={source_language:crowdin.editor.source_language.internal_code,target_language:crowdin.editor.target_language.internal_code,target_language_id:crowdin.editor.target_language.id,project_id:crowdin.editor.project.id,user_id:crowdin.editor.project.owner.id,metadata:translation.metadata,translation_id:id,plural_id:plural_id,text:raw_text};crowdin.ajax.postData("/tm/tm_suggestions",tmParams,(function(response){if(response.data){for(var i=0;i<response.data.length;i++){response.data[i].uid="uid1"+i;response.data[i].provider_id=response.data[i].tm_id;response.data[i].provider_type="tm"}self.addPhrases(id,plural_id,{tm:response.data})}}));if(loaded===true){return}if(crowdin.editor.project.use_global_tm){crowdin.ajax.postData("/tm/global_tm_suggestions",tmParams,(function(response){if(response.data){for(var i=0;i<response.data.length;i++){response.data[i].uid="uid2"+i;response.data[i].provider_type="global_tm"}self.addPhrases(id,plural_id,{global_tm:response.data})}}))}if(crowdin.editor.project.use_external_tm){crowdin.ajax.postData("/tm/external_tm_suggestions",tmParams,(function(response){if(response.data){for(var i=0;i<response.data.length;i++){response.data[i].uid="uid3"+i;response.data[i].provider_id=response.data[i].tm_id;response.data[i].provider_type="tm"}self.addPhrases(id,plural_id,{external_tm:response.data})}}))}if(window.IS_MT_ALLOWED&&crowdin.editor.modeTranslateProofread()){var checkShowPlaceholders=crowdin.editor.check_show_placeholders(id);var markupReplacer=checkShowPlaceholders?crowdin.phrases.markup_replacer(id):null;var mtParams={source_language:crowdin.editor.source_language.code,target_language:crowdin.editor.target_language.code,project_id:crowdin.editor.project.id,source_plural_id:plural_id,translation_id:id};if(window.GOOGLE_TRANSLATE_ENABLED){crowdin.ajax.getData("/gt/translate",mtParams,(function(data){if(data.status==true){var _translation=markupReplacer?markupReplacer.mask(data.translations[0]):data.translations[0];self.extend_with_mt_suggestions(id,plural_id,"google",data.id,_translation,is_icu)}}))}if(window.GOOGLE_AUTOML_TRANSLATE_ENABLED){crowdin.ajax.getData("/gaml/translate",mtParams,(function(data){if(data.status==true){var _translation2=markupReplacer?markupReplacer.mask(data.translations[0]):data.translations[0];self.extend_with_mt_suggestions(id,plural_id,"google_automl",data.id,_translation2,is_icu)}}))}if(window.YANDEX_TRANSLATE_ENABLED){crowdin.ajax.getData("/yt/translate",mtParams,(function(data){if(data.status==true){var _translation3=markupReplacer?markupReplacer.mask(data.translations[0]):data.translations[0];self.extend_with_mt_suggestions(id,plural_id,"yandex",data.id,_translation3,is_icu)}}))}if(window.DEEPL_TRANSLATE_ENABLED){crowdin.ajax.getData("/dt/translate",mtParams,(function(data){if(data.status==true){var _translation4=markupReplacer?markupReplacer.mask(data.translations[0]):data.translations[0];self.extend_with_mt_suggestions(id,plural_id,"deepl",data.id,_translation4,is_icu)}}))}if(window.WATSON_TRANSLATOR_ENABLED){crowdin.ajax.getData("/wt/translate",mtParams,(function(data){if(data.status==true){var _translation5=markupReplacer?markupReplacer.mask(data.translations[0]):data.translations[0];self.extend_with_mt_suggestions(id,plural_id,"watson",data.id,_translation5,is_icu)}}))}if(window.AMAZON_TRANSLATE_ENABLED){crowdin.ajax.getData("/at/translate",mtParams,(function(data){if(data.status==true){var _translation6=markupReplacer?markupReplacer.mask(data.translations[0]):data.translations[0];self.extend_with_mt_suggestions(id,plural_id,"amazon",data.id,_translation6,is_icu)}}))}if(window.CROWDIN_TRANSLATE_ENABLED){this._load_crowdin_translate_suggestions(id,plural_id,is_icu)}if(window.BING_TRANSLATE_ENABLED){crowdin.ajax.getData("/bt/translate",mtParams,(function(data){if(data.status==true){var _translation7=markupReplacer?markupReplacer.mask(data.translations[0]):data.translations[0];self.extend_with_mt_suggestions(id,plural_id,"bing",data.id,_translation7,is_icu)}}))}}}},{key:"_load_crowdin_translate_suggestions",value:function _load_crowdin_translate_suggestions(id,plural_id,is_icu,additionalParams){if(!additionalParams){additionalParams={}}var self=this;var params={source_language:crowdin.editor.source_language.code,target_language:crowdin.editor.target_language.code,project_id:crowdin.editor.project.id,source_plural_id:plural_id,translation_id:id};Object.assign(params,additionalParams);crowdin.ajax.getData("/ct/translate",params,(function(data){if(data.status==true){var translations=data.translations;if(crowdin.editor.check_show_placeholders(id)){var markupReplacer=crowdin.phrases.markup_replacer(id);for(var i in translations){translations[i]=markupReplacer.mask(translations[i])}}self.extend_with_mt_suggestions_bulk(id,plural_id,"crowdin",data.id,translations,is_icu,data.translation_attributes.scores||null);if(params.target_text&&crowdin.translation.translation_id===id){var $crowdinSuggestions=$('div[data-provider="crowdin"]',"#suggestions");$crowdinSuggestions.addClass("interactive-suggestion");$crowdinSuggestions.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",(function(){$(this).removeClass("interactive-suggestion")}))}}}))}},{key:"extend_with_mt_suggestions",value:function extend_with_mt_suggestions(translationId,pluralId,providerName,providerId,translationText,is_icu){var mt={};if(translationText){is_icu&&(translationText=this.extendICU(translationText));mt[providerName]={translation:translationText,provider_id:providerId,provider_type:"mt",provider_name:providerName};this.addPhrases(translationId,pluralId,{mts:mt})}}},{key:"extend_with_mt_suggestions_bulk",value:function extend_with_mt_suggestions_bulk(translationId,pluralId,providerName,providerId,translations,is_icu,scores){var mts={};for(var i in translations){if(!translations[i]){continue}is_icu&&(translations[i]=this.extendICU(translations[i]));mts[providerName+i]={translation:translations[i],provider_id:providerId,provider_type:"mt",provider_name:providerName,score:scores[i]||0}}this.addPhrases(translationId,pluralId,{mts:mts})}},{key:"extendICU",value:function extendICU(icuText){try{var icuHelper=new IcuHelper(icuText);icuText=icuHelper.getModifiedString()}catch(e){}return icuText}},{key:"interactive_suggestion",value:function interactive_suggestion(translationValue){if(!crowdin.user.features.interactive_suggestions||!window.CROWDIN_TRANSLATE_ENABLED){return}if(crowdin.translation.interactive_suggestion_timeout){clearTimeout(crowdin.translation.interactive_suggestion_timeout)}var translationId=crowdin.translation.translation_id;if(crowdin.translation.target_text!==translationValue){if(!in_array(translationValue,crowdin.translation.suggestion_texts)){var regexp=new RegExp("[^p{L}d]+$","gm");var shouldSendToBot=regexp.test(translationValue);if(shouldSendToBot||!translationValue){crowdin.translation.target_text=translationValue;var interactiveSuggestion=function interactiveSuggestion(){var params={target_text:translationValue};var is_icu=crowdin.translation.is_icu;crowdin.models.mt._load_crowdin_translate_suggestions(translationId,crowdin.translation.plural_id,is_icu,params)};crowdin.translation.interactive_suggestion_timeout=setTimeout(interactiveSuggestion,750)}}}}},{key:"updateCrowdinTranslateEngineAccess",value:function updateCrowdinTranslateEngineAccess(crowdinTranslateEnabled){if(!window.IS_MT_ALLOWED){return}window.CROWDIN_TRANSLATE_ENABLED=+crowdinTranslateEnabled}}]);return crowdin_mt_model}(CrowdinComponent);
