"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}var crowdin_phrases_model=function(_CrowdinComponent){_inherits(crowdin_phrases_model,_CrowdinComponent);var _super=_createSuper(crowdin_phrases_model);function crowdin_phrases_model(){var _this;_classCallCheck(this,crowdin_phrases_model);_this=_super.call(this);_this.preloadInterval=null;_this.ws_server_was_down=false;var self=_assertThisInitialized(_this);_this.storage=new storage({onSet:function onSet(id){self.subscribe(id)},onRemove:function onRemove(id){self.unsubscribe(id)}});crowdin.editor.on("clearModels",(function(render){self.storage.clear();if(render){var id=crowdin.translation.translation_id;self.invoke("changed.translation",id);self.invoke("changed.suggestions",id);self.invoke("changed.discussions",id)}}));return _this}_createClass(crowdin_phrases_model,[{key:"refresh",value:function refresh(id,callback){var skipCache=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var self=this;if(!id||!crowdin.editor.target_language){return}var afterLoad=function afterLoad(phrase){if(crowdin.editor.modeTranslate()){crowdin.translation.markup_replacer=crowdin.phrases.markup_replacer()}if(callback){callback(id,phrase)}self.invoke("load",id)};self.invoke("load.start",parseInt(id));var phrase=skipCache?null:self.storage.get(id);if(phrase&&crowdin.websocket.subscribed(self._get_ws_event_name(id))){self.clear_removed_data(id,phrase);afterLoad(phrase);return}var url="/translation/phrase";if(crowdin.editor.modeAssets()){url="/asset/phrase"}crowdin.ajax.getData(url,{project_id:crowdin.editor.project.id,workflow_step_id:crowdin.editor.workflow_step.id,target_language_id:crowdin.editor.target_language.id,translation_id:id,filter:crowdin.user.get_texts_sort_order()},(function(data){if(!data.success){if(crowdin.editor.modeAssets()||data.file_excluded&&crowdin.plugins.open_file){crowdin.plugins.open_file.selected_file_exist=false;crowdin.plugins.open_file.files_outdated=true;crowdin.plugins.open_file.hideClosingDialogButtons();crowdin.plugins.open_file.run();$("#editor_layout_west").unmask()}return}if(!crowdin.editor.target_language){return}var phrase={translation:data.translation,suggestions:data.suggestions,discussions:data.discussions};if(crowdin.editor.modeTranslate()){crowdin.phrases.update_qa_issues_info(id,data.qa_issues);crowdin.phrases.update_translation_status(id,data.top_suggestion,data.translation_status);crowdin.phrases.mark_as_hidden(id,data.translation.hidden);$(document).trigger("update_translation",data)}if(crowdin.editor.modeReviewProofread()){crowdin.phrases.refresh_single_phrase(id)}self.storage.set(id,phrase);afterLoad(phrase)}))}},{key:"clear_removed_data",value:function clear_removed_data(id,phrase){for(var i in phrase.suggestions){for(var j=0;j<phrase.suggestions[i].length;j++){if(phrase.suggestions[i][j].deleted){phrase.suggestions[i].splice(j,1);j--}}}for(var i in phrase.discussions){if(phrase.discussions[i].deleted){delete phrase.discussions[i]}}this.storage.set(id,phrase)}},{key:"subscribe",value:function subscribe(translation_id){var self=this;if(crowdin.websocket.connected()){var event=self._get_ws_event_name(translation_id);var suggestions_event=self._get_ws_event_name(translation_id,true);if(!crowdin.websocket.subscribed(event)){crowdin.websocket.subscribe(event,(function(data){self._on_change.call(self,data)}))}if(!crowdin.websocket.subscribed(suggestions_event)){crowdin.websocket.subscribe(suggestions_event,(function(data){self._on_change.call(self,data)}))}}}},{key:"unsubscribe",value:function unsubscribe(translation_id){if(crowdin.websocket.connected()){crowdin.websocket.unsubscribe(this._get_ws_event_name(translation_id));crowdin.websocket.unsubscribe(this._get_ws_event_name(translation_id,true))}}},{key:"preload",value:function preload(translation_ids){if(!crowdin.websocket.connected()){return}var self=this;var index=0;var needs_preload=[];var storage_size=self.storage._stack_limit;var check_actuality=function check_actuality(id){return crowdin.websocket.subscribed(self._get_ws_event_name(id))&&self.storage.get(id)};for(var i in translation_ids){if(i>storage_size-1){break}if(!check_actuality(translation_ids[i])){needs_preload.push(translation_ids[i])}}var total=needs_preload.length;clearInterval(this.preloadInterval);this.preloadInterval=setInterval((function(){if(index>=total||self._check_preload_error()){clearInterval(self.preloadInterval);return}for(;index<total;index++){if(!check_actuality(needs_preload[index])){if(crowdin.ajax.active()>4){break}self.refresh(needs_preload[index++]);break}}}),500)}},{key:"_check_preload_error",value:function _check_preload_error(){return crowdin.ajax.aclError}},{key:"_on_change",value:function _on_change(data){var id=data.translation_id;switch(data.type){case"translation":if(data.action==="change_status"){if(data.workflow_step_id===crowdin.editor.workflow_step.id){this.edit_translation(id,data.translation)}}else{this.edit_translation(id,data.translation)}if(crowdin.editor.modeTranslate()){crowdin.phrases.mark_as_hidden(id,data.translation.hidden);crowdin.translation.bindTooltips()}$(document).trigger("update_phrase",data);break;case"suggestions":var suggestions=this.suggestions(id,data.plural_id)||{};var suggestion=crowdin.suggestions.get_suggestion(data.suggestion_id,suggestions)||{};if(data.action==="delete"&&suggestion.deleted){break}if(data.action==="approve"||crowdin.suggestions.is_approved(data.suggestion)){for(var i in suggestions){if(suggestions[i].id!==data.suggestion_id){crowdin.suggestions.update_approved_status(suggestions[i].validations,{approved:false},data.workflow_step_id)}}this.suggestions(id,data.plural_id,suggestions)}this.edit_suggestion(id,data.plural_id,data.suggestion_id,data.suggestion);if(crowdin.editor.modeTranslate()){crowdin.phrases.update_translation_status(data.translation_id,data.top_suggestion,data.translation_status);crowdin.phrases.update_qa_issues_info(data.translation_id,data.qa_issues);$(document).trigger("update_translation",data);if(data.translation_id===crowdin.translation.translation_id){if(data.plural_id===crowdin.translation.plural_id){crowdin.translation.highlight_save_btn()}else{crowdin.translation.update_unsaved_storage(data.top_suggestion,data.translation_id,data.plural_id)}if(crowdin.editor.jipt_mode&&crowdin.helpers.translation.has_unsaved()){crowdin.jipt.sendEditTranslationMessage()}}}break;case"discussions":var message=this.discussions(id)[data.message_id]||{};if(data.action==="delete"&&message.deleted){break}if(data.action==="add"){this.edit_discussion(id,-1,null)}this.edit_discussion(id,data.message_id,data.message);break}if(crowdin.editor.modeReviewProofread()){crowdin.phrases.refresh_single_phrase(id)}}},{key:"_get_ws_event_name",value:function _get_ws_event_name(translation_id,is_language_specific){var parts=[crowdin.editor.project.wshash,crowdin.editor.project.id,translation_id];if(is_language_specific){parts.push(crowdin.editor.target_language.id)}return parts.join(":")}},{key:"translation",value:function translation(id,object){var data=this.storage.get(id);if(typeof object==="undefined"){return data?data["translation"]:{}}else if(data){data["translation"]=object;this.storage.set(id,data);this.invoke("changed.translation",parseInt(id))}}},{key:"suggestions",value:function suggestions(id,plural_id,array){var data=this.storage.get(id);if(typeof plural_id==="undefined"){return data?data["suggestions"]||[]:[]}else if(typeof array==="undefined"){return data?data["suggestions"][plural_id]||[]:[]}else if(data){data["suggestions"][plural_id]=array;this.storage.set(id,data);this.invoke("changed.suggestions",parseInt(id))}}},{key:"getAppropriateSuggestions",value:function getAppropriateSuggestions(id,plural_id){var suggestions=this.suggestions(id);var hasOwnSuggestions=crowdin.helpers.translation.hasOwnSuggestions(id,suggestions);var filteredSuggestions=[];for(var i in suggestions[plural_id]){if(!hasOwnSuggestions||suggestions[plural_id][i].translation_id==id){filteredSuggestions.push(suggestions[plural_id][i])}}return filteredSuggestions.sort(crowdin.suggestions._sort_suggestions)}},{key:"discussions",value:function discussions(id,object){var data=this.storage.get(id);if(typeof object==="undefined"){return data?data["discussions"]:{}}else if(data){data["discussions"]=object;this.storage.set(id,data);this.invoke("changed.discussions",parseInt(id))}}},{key:"get_translation",value:function get_translation(id){return this.translation(id)}},{key:"edit_translation",value:function edit_translation(id,fields){this.translation(id,$.extend({},this.translation(id),fields))}},{key:"edit_suggestion",value:function edit_suggestion(id,plural_id,suggestion_id,fields){var suggestions=this.suggestions(id,plural_id);var old=null;for(var i in suggestions){if(suggestions[i].id==suggestion_id){old=$.extend(true,{},suggestions[i]);if(fields){$.extend(suggestions[i],fields)}else{suggestions.splice(i,1)[0]}break}}if(old===null&&fields){suggestions.push(fields)}this.suggestions(id,plural_id,suggestions);return old}},{key:"edit_discussion",value:function edit_discussion(id,message_id,fields){var discussions=this.discussions(id);var old=null;for(var i in discussions){if(i==message_id){old=$.extend(true,{},discussions[i]);if(fields){$.extend(discussions[i],fields)}else{delete discussions[i]}break}}if(old===null&&fields){discussions[message_id]=fields}this.discussions(id,discussions);return old}},{key:"_sort_suggestions",value:function _sort_suggestions(suggestion1,suggestion2){var id=crowdin.translation.translation_id;if(suggestion1.translation_id===id&&suggestion2.translation_id!==id)return-1;if(suggestion2.translation_id===id&&suggestion1.translation_id!==id)return 1;if(crowdin.suggestions.is_approved(suggestion1))return-1;if(crowdin.suggestions.is_approved(suggestion2))return 1;if(this._highest_approve(suggestion1.validations).id>this._highest_approve(suggestion2.validations).id)return-1;if(this._highest_approve(suggestion1.validations).id<this._highest_approve(suggestion2.validations).id)return 1;if(suggestion1.rating>suggestion2.rating)return-1;if(suggestion1.rating<suggestion2.rating)return 1;return suggestion2.id-suggestion1.id}},{key:"_highest_approve",value:function _highest_approve(validations){var highest_step=1;var result={id:highest_step};var steps=crowdin.editor.workflow_proofread_steps;for(var i in validations){if(validations[i].approved&&i>highest_step){result["id"]=+i;result["user"]=validations[i].approver;result["approved_date_iso"]=validations[i].approved_date_iso}}for(var j in steps){if(steps[j].id==result["id"]){result["name"]=steps[j].name;break}}return result}},{key:"is_suggestion_deletable",value:function is_suggestion_deletable(suggestion){if(suggestion.user.id===crowdin.user.id){return true}if(!crowdin.user.is_leader){return false}var highest_approve=this._highest_approve(suggestion.validations);if(highest_approve.id==1){return true}var workflow_step_id=crowdin.user.get_workflow_proofread_step_id();return $.inArray(workflow_step_id,crowdin.editor.workflow_step_ids)>=$.inArray(highest_approve.id,crowdin.editor.workflow_step_ids)}},{key:"_is_suggestion_approved",value:function _is_suggestion_approved(suggestion){if(!suggestion||!suggestion.validations){return null}var stepId=crowdin.editor.workflow_step.id||crowdin.user.get_workflow_proofread_step_id();return suggestion.validations[stepId]?suggestion.validations[stepId].approved:false}},{key:"_update_suggestion_approved_status",value:function _update_suggestion_approved_status(validations,step_validations,workflow_step_id){var stepId=workflow_step_id?workflow_step_id:crowdin.editor.workflow_step.id||crowdin.user.get_workflow_proofread_step_id();var approved=step_validations.approved;validations[stepId]={approved:approved};if(approved){validations[stepId].approved_by=step_validations.approver.id;validations[stepId].approved_date_iso=step_validations.approved_date_iso;validations[stepId].approver=step_validations.approver}return validations}}]);return crowdin_phrases_model}(CrowdinComponent);
