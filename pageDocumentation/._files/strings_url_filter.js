"use strict";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}));keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach((function(key){_defineProperty(target,key,source[key])}))}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source))}else{ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}}return target}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}var StringsUrlFilter=function(){function StringsUrlFilter(){_classCallCheck(this,StringsUrlFilter);this.BASIC_FILTER="basic";this.ADVANCED_FILTER="advanced";this.urlFilterInitialization=false;this.resetAdvancedFilter=false}_createClass(StringsUrlFilter,[{key:"setFilterInitialization",value:function setFilterInitialization(){var flag=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.urlFilterInitialization=flag}},{key:"setResetAdvancedFilter",value:function setResetAdvancedFilter(){var flag=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.resetAdvancedFilter=flag}},{key:"apply",value:function apply(currentFilterValue){var searchParams=crowdin.helpers.url.getSearchParamsObj();var filter;var filterValue;var saveFilter=0;if(this.urlFilterInitialization){filterValue=searchParams.value?+searchParams.value:currentFilterValue;if(!searchParams.value){saveFilter=1}}else{saveFilter=1;filterValue=currentFilterValue}if(searchParams.save_filter){saveFilter=parseInt(searchParams.save_filter);if(isNaN(saveFilter)){saveFilter=0}}crowdin.phrases.save_filter=saveFilter;if(filterValue!=12){filter=this.BASIC_FILTER}else{filter=this.ADVANCED_FILTER}searchParams.filter=filter;searchParams.value=filterValue;switch(filter){case this.BASIC_FILTER:this._processBasicFilter(searchParams);break;case this.ADVANCED_FILTER:this._processAdvancedFilter(searchParams)}this.setFilterInitialization(false);this.setResetAdvancedFilter(false)}},{key:"getBasicFilterSchema",value:function getBasicFilterSchema(info){return{value:function value(){var value=parseInt(info.value);if(isNaN(value)){return null}return value},buildUrl:function buildUrl(value){var queryParams=info;queryParams["value"]=value;queryParams=_.pickBy(queryParams,(function(value,key){return!in_array(key,Object.keys(crowdin.user._default_custom_filter))}));var taskHash=crowdin.editor.getTaskHash();if(taskHash){queryParams=_objectSpread({task:crowdin.editor.getTaskHash()},queryParams)}var url=crowdin.helpers.url.build(crowdin.helpers.url.buildEditorPath({options:{preserve_search_query:false,preserve_hash:false}}),queryParams,crowdin.helpers.url.getQueryFromUrl(true));crowdin.user.set_texts_sort_order(value);setHistory(history.state,url,"replace")}}}},{key:"getAdvancedFilterSchema",value:function getAdvancedFilterSchema(info){var _this=this;var advancedFilterList=$.extend({},crowdin.user.get_custom_filter());var defaultAdvancedFilter=crowdin.user.get_default_custom_filter();var validator=this._advancedFilterValidator(advancedFilterList);return{value:function value(){var result;if(_this.urlFilterInitialization){result=_.pickBy(info,(function(value,key){return defaultAdvancedFilter.hasOwnProperty(key)}));if(Object.keys(info).length===2){result=advancedFilterList}_.map(result,(function(value,key){try{var v=validator[key](value);if(null===v||typeof v=="undefined"){delete result[key]}else{result[key]=v}}catch(e){delete result[key]}}));if($.isEmptyObject(result)){crowdin.user.reset_custom_filter()}else{_.map(result,(function(value,key){defaultAdvancedFilter[key]=value}));crowdin.user.set_custom_filter(defaultAdvancedFilter)}}else{result=_this.resetAdvancedFilter?defaultAdvancedFilter:advancedFilterList;_.map(result,(function(value,key){try{var v=validator[key](value);if(null===v||typeof v=="undefined"){delete result[key]}else{result[key]=v}}catch(e){delete result[key]}}))}return result},buildUrl:function buildUrl(value){var queryParams=info;queryParams=_.assign(_.omit(queryParams,Object.keys(crowdin.user.get_default_custom_filter())),value);var re=/^[a-zA-Z0-9_.-]+$/;var filtersOrder=[["filter",queryParams.filter],["value",+queryParams.value],queryParams.added_from&&["added_from",queryParams.added_from],queryParams.added_to&&["added_to",queryParams.added_to],queryParams.updated_from&&["updated_from",queryParams.updated_from],queryParams.updated_to&&["updated_to",queryParams.updated_to],queryParams.changed_from&&["changed_from",queryParams.changed_from],queryParams.changed_to&&["changed_to",queryParams.changed_to],queryParams.labels&&["labels",queryParams.labels],queryParams.translations&&["translations",queryParams.translations],queryParams.tm_and_mt&&["tm_and_mt",queryParams.tm_and_mt],queryParams.approvals&&["approvals",queryParams.approvals],queryParams.comments&&["comments",queryParams.comments],queryParams.screenshots&&["screenshots",queryParams.screenshots],queryParams.visibility&&["visibility",queryParams.visibility],queryParams.qa_issues&&["qa_issues",queryParams.qa_issues],queryParams.string_type&&["string_type",queryParams.string_type],queryParams.votes&&queryParams.votes_count>=0&&["votes",queryParams.votes],queryParams.votes&&queryParams.votes_count>=0&&["votes_count",queryParams.votes_count],queryParams.sort_method&&["sort_by",queryParams.sort_method],queryParams.sort_ascending&&["sort_ascending",queryParams.sort_ascending],queryParams.translated_by_user&&re.test(queryParams.translated_by_user)?["translated_by_user",queryParams.translated_by_user]:null,queryParams.not_translated_by_user&&re.test(queryParams.approved_by_user)?["not_translated_by_user",queryParams.not_translated_by_user]:null,queryParams.approved_by_user&&re.test(queryParams.approved_by_user)?["approved_by_user",queryParams.approved_by_user]:null,queryParams.not_approved_by_user&&re.test(queryParams.not_approved_by_user)?["not_approved_by_user",queryParams.not_approved_by_user]:null,queryParams.approved_by_step&&["approved_by_step",queryParams.approved_by_step],queryParams.approved_step&&["approved_step",queryParams.approved_step]];var queryParamsMap=new Map(_.compact(filtersOrder));var queryP={};queryParamsMap.forEach((function(value,key){queryP[key]=value}));var taskHash=crowdin.editor.getTaskHash();if(taskHash){queryP=_objectSpread({task:crowdin.editor.getTaskHash()},queryP)}var url=crowdin.helpers.url.build(crowdin.helpers.url.buildEditorPath({options:{preserve_search_query:false,preserve_hash:false}}),queryP,crowdin.helpers.url.getQueryFromUrl(true));crowdin.user.set_texts_sort_order(info.value);setHistory(history.state,url,"replace")}}}},{key:"_processBasicFilter",value:function _processBasicFilter(info){var schema=this.getBasicFilterSchema(info);var urlFilterValue=schema.value();var currentFilterValue=crowdin.user.get_texts_sort_order();if(null===urlFilterValue){schema.buildUrl(currentFilterValue);return}if(currentFilterValue!=urlFilterValue){if(crowdin.helpers.filter.isCustomQaCheckCategory(urlFilterValue)&&!in_array(urlFilterValue,crowdin.editor.active_qa_categories)){urlFilterValue=18}schema.buildUrl(urlFilterValue);return}schema.buildUrl(currentFilterValue)}},{key:"_processAdvancedFilter",value:function _processAdvancedFilter(info){var schema=this.getAdvancedFilterSchema(info);schema.buildUrl(schema.value())}},{key:"_advancedFilterValidator",value:function _advancedFilterValidator(filterList){var dateValidationFn=function dateValidationFn(date){return moment(decodeURIComponent(date)).isValid()?decodeURIComponent(date):null};return{added_from:dateValidationFn,added_to:dateValidationFn,updated_from:dateValidationFn,updated_to:dateValidationFn,changed_from:dateValidationFn,changed_to:dateValidationFn,translations:function translations(value){return["untranslated","partially_translated","translated","duplicate_source_string"].indexOf(value)!==-1?value:null},tm_and_mt:function tm_and_mt(value){return["by_mt","by_tm","by_mt_or_tm"].indexOf(value)!==-1?value:null},approvals:function approvals(value){return["translated_not_approved","partially_approved","approved","have_translations_after_approval"].indexOf(value)!==-1?value:null},comments:function comments(value){return["have_comments","have_unresolved_issues","do_not_have_comments"].indexOf(value)!==-1?value:null},screenshots:function screenshots(value){return["without_screenshots","with_screenshots"].indexOf(value)!==-1?value:null},visibility:function visibility(value){return["visible","hidden"].indexOf(value)!==-1?value:null},qa_issues:function qa_issues(value){var availableQaIssues=crowdin.helpers.filter.getFilterOptionsDataBySubCategory(crowdin.helpers.filter.WITH_QA_ISSUES).map((function(option){return option.option}));if(availableQaIssues.indexOf(+value)!==-1){return value}return null},translated_by_user:function translated_by_user(username){return username||null},not_translated_by_user:function not_translated_by_user(username){return username||null},approved_by_user:function approved_by_user(username){return username||null},not_approved_by_user:function not_approved_by_user(username){return username||null},approved_by_step:function approved_by_step(v){var value=parseInt(v);if(value===0||isNaN(value)){return null}return value},approved_step:function approved_step(v){var value=parseInt(v);if(value===0||isNaN(value)){return null}return value},sort_method:function sort_method(v){var value=parseInt(v);if(value===0||isNaN(value)){return null}return value},sort_ascending:function sort_ascending(v){var value=parseInt(v);if(isNaN(value)){return 1}return value},labels:function labels(v){var arr=Array.isArray(v)?v:v.split(",");arr=arr.filter((function(label){var value=parseInt(label);return!isNaN(value)&&value>0}),arr).map((function(i){return parseInt(i)}));if(!arr.length){return null}return arr},string_type:function string_type(v){return["string_type_simple","string_type_plurals","string_type_icu"].indexOf(v)!==-1?v:null},votes:function votes(v){var votesCount=parseInt(filterList.votes_count);if(isNaN(votesCount)){return null}return["votes_greater_than","votes_less_than"].indexOf(v)!==-1?v:null},votes_count:function votes_count(v){var value=parseInt(v);if(!filterList.votes){return null}if(!isNaN(value)){return value}return null}}}}]);return StringsUrlFilter}();
