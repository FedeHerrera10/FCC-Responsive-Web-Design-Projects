"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}var tag_screenshot=function(_CrowdinComponent){_inherits(tag_screenshot,_CrowdinComponent);var _super=_createSuper(tag_screenshot);function tag_screenshot(project_id,screenshot_id){var _this;_classCallCheck(this,tag_screenshot);_this=_super.call(this);_this.screenshot_loaded=false;_this.src=null;_this.url=null;_this.name=null;_this.tags=null;_this.retina_scale_pattern=/^.+@([2-3])x(?:\.[a-zA-Z]+)?$/;_this.dialog=null;_this.project_id=project_id;_this.screenshot_id=screenshot_id;return _this}_createClass(tag_screenshot,[{key:"init_dialog",value:function init_dialog(title){var width=$(window).width()-40;var height=$(window).height()-40;if($("#tag_screenshot_dialog").length===0){$("body").append('<div id="tag_screenshot_dialog"></div>')}this.dialog=$("#tag_screenshot_dialog");var html='\n      <div id="screenshot-container">\n        <div id="position_box" style="visibility: hidden">\n           <img id="tag_screenshot" class="fit-size" src="" alt="" />\n        </div>\n      </div>\n      <div class="screenshot-switcher prev hidden"><div>&lsaquo;</div></div>\n      <div class="screenshot-switcher next hidden"><div>&rsaquo;</div></div>\n      <div class="tag_screenshot_scale_toggler hidden"><i class="static-icon static-icon-zoom-in"></i></div>';this.dialog.html(html);this.dialog.dialog({autoOpen:true,width:width,height:height,zIndex:1e5,resizable:false,modal:true,title:title,draggable:IS_MOBILE?false:true,closeOnEscape:true,beforeClose:function beforeClose(){$(document).off(".crowdin_screenshots");$(window).off("resize.screenshot")}});if(IS_MOBILE){this.dialog.css("height",height-12)}this.dialog.mask("")}},{key:"window_resize",value:function window_resize(){var width=$(window).width()-40;var height=$(window).height()-40;this.dialog.dialog("option","width",width);this.dialog.dialog("option","height",height);if(IS_MOBILE){this.dialog.css("height",height-12)}this.toggle_scale_switcher();this.center_image();this.rebuild_tags()}},{key:"load_screenshot",value:function load_screenshot(translation_id){var self=this;var options={id:self.screenshot_id,project_id:self.project_id,translation_id:translation_id};var url="/project_actions/tag_screenshot_dialog";crowdin.ajax.getData(url,options,(function(response){if(response.success){self.tags=response.tags;self.url=response.url;self.name=response.name;self.display_image_and_tags()}else{self.dialog.dialog("close");if(check_acl(response)){$.jGrowl(response.msg||_l("error.internalError"),{theme:"jGrowl-error"})}}}),null,false,true)}},{key:"get_screenshot_scale",value:function get_screenshot_scale(){var match=this.retina_scale_pattern.exec(this.name);return match?match[1]:1}},{key:"toggle_scale_switcher",value:function toggle_scale_switcher(){var img=$("#tag_screenshot");var screenshot_width=img[0].naturalWidth/this.scale;var screenshot_height=img[0].naturalHeight/this.scale;var overflow=screenshot_width>$("#screenshot-container").width()||screenshot_height>$("#screenshot-container").height();img.css("max-height",img.hasClass("fit-size")?$("#screenshot-container").height()+"px":"none");$(".tag_screenshot_scale_toggler",this.dialog)[overflow?"removeClass":"addClass"]("hidden")}},{key:"display_image_and_tags",value:function display_image_and_tags(){var self=this;var img=$("#tag_screenshot");self.scale=self.get_screenshot_scale();img.attr({src:self.url+"&"+Date.now(),alt:self.name}).load((function(){self.screenshot_loaded=true;img.css("max-width",img.hasClass("fit-size")?"100%":img[0].naturalWidth/self.scale);self.toggle_scale_switcher();self.center_image();$("#position_box").css("visibility","visible");self.dialog.unmask();self.dialog.dialog("option","position","center");self.rebuild_tags()})).error((function(){self.dialog.dialog("close");$.jGrowl(_l("tagScreenshot.cantLoadThisScreenshot"),{theme:"jGrowl-error"})}))}},{key:"rebuild_tags",value:function rebuild_tags(){var self=this;var img=$("#tag_screenshot")[0];var multiplier=img.width/img.naturalWidth;$("#position_box .tag_positioner").remove();for(var id in self.tags){var tag_group=self.tags[id];for(var i=0;i<tag_group.length;i++){if(parseInt(tag_group[i].positioned)){self._create_tag_positioner(tag_group[i].x*multiplier,tag_group[i].y*multiplier,tag_group[i].w*multiplier,tag_group[i].h*multiplier)}}}}},{key:"center_image",value:function center_image(){var container=$("#screenshot-container");var top=Math.round((container.get(0).clientHeight-$("#tag_screenshot").height())/2);var left=Math.round((container.get(0).clientWidth-$("#tag_screenshot").width())/2);$("#position_box").css({left:left>0?left:0,top:top>0?top:0});container.scrollTop(top>0?0:Math.abs(top));container.scrollLeft(left>0?0:Math.abs(left))}},{key:"scale_screenshot",value:function scale_screenshot(){var img=$("#tag_screenshot");img.toggleClass("fit-size");img.css("max-height",img.hasClass("fit-size")?$("#screenshot-container").height()+"px":"none");img.css("max-width",img.hasClass("fit-size")?"100%":img[0].naturalWidth/this.scale);this.center_image();this.rebuild_tags();$(".tag_screenshot_scale_toggler i",this.dialog).toggleClass("static-icon-zoom-in static-icon-zoom-out")}},{key:"show_screenshot_for_translators",value:function show_screenshot_for_translators(translation_id,name){var self=this;self.init_dialog(name);if(self.screenshot_loaded){self.display_image_and_tags(true)}else{self.load_screenshot(translation_id)}if(!IS_MOBILE){$("#screenshot-container").dragscrollable({dragSelector:"#position_box",acceptPropagatedEvent:true})}$("#position_box").on("dblclick.crowdin_screenshots",(function(){if(!$(".tag_screenshot_scale_toggler",self.dialog).hasClass("hidden")){self.scale_screenshot()}}));$(".tag_screenshot_scale_toggler",self.dialog).on("click.crowdin_screenshots",(function(){self.scale_screenshot()}));$(window).on("resize.screenshot",(function(){self.window_resize()}))}},{key:"_create_tag_positioner",value:function _create_tag_positioner(x,y,w,h){var div=$("<div>");div.addClass("tag_positioner");div.width(parseInt(w));div.height(parseInt(h));div.css("top",parseInt(y));div.css("left",parseInt(x));div.css({opacity:"1",background:"transparent"});div.appendTo("#position_box")}}]);return tag_screenshot}(CrowdinComponent);
