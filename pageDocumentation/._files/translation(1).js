"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}var crowdin_translation=function(_CrowdinComponent){_inherits(crowdin_translation,_CrowdinComponent);var _super=_createSuper(crowdin_translation);function crowdin_translation(){var _this;_classCallCheck(this,crowdin_translation);_this=_super.call(this);_this.translation_id=0;_this.has_plurals=false;_this.plural_id=-1;_this.block_suggest=false;_this.input_timeout=null;_this.interactive_suggestion_timeout=null;_this.target_text="";_this.is_icu=false;_this.icu_params={};_this.icu_error={};_this.tagScreenshots={};_this.area=null;_this.autofix=null;_this.markup_replacer=null;_this.area_selector="#translation";_this.suggestion_texts=[];_this.suggestionTextsSorted={};_this.area=new area(_this.area_selector);_this.textarea_highlight=new crowdin_textarea_highlight;_this.area.$container.autocomplete({source:[]});_this.area.$container.autosize();_this.area.container.addEventListener("autosize.resized",(function(){crowdin.editor.layout.resizeSuggestions()}));_this.area.updateHeight();_this.autofix=new autofix(_assertThisInitialized(_this));_this.bindEvents();var self=_assertThisInitialized(_this);crowdin.phrases.on("load",(function(){self._next_translation()}));_this.initIcuParamsTempData();crowdin.editor.on("updateLanguage",(function(){self.initIcuParamsTempData()}));return _this}_createClass(crowdin_translation,[{key:"initIcuParamsTempData",value:function initIcuParamsTempData(){if(crowdin.editor.target_language){this.icu_params.temp_data_pairs=new storage({key:"icu_pairs_"+crowdin.editor.project.id+"_"+crowdin.editor.target_language.code,limit:500});this.icu_params.temp_data_placeholders=new storage({key:"icu_placeholders_"+crowdin.editor.project.id+"_"+crowdin.editor.target_language.code,limit:500})}}},{key:"set_translation_id",value:function set_translation_id(id){this.translation_id=parseInt(id);this.plural_id=-1;return this}},{key:"get_translation",value:function get_translation(translation_id){return crowdin.models.phrases.translation(typeof translation_id==="undefined"?this.translation_id:translation_id)}},{key:"clear_translation",value:function clear_translation(){this.clear();this.tagScreenshots={}}},{key:"refresh",value:function refresh(last_plural_form){var self=this;crowdin.editor.view.setState({suggestionsLoaded:false,tmAndMtSuggestionsLoaded:false,tms:crowdin.suggestions.getTmSuggestions(),mts:crowdin.suggestions.getMtSuggestions()});self.block_suggest=true;crowdin.models.phrases.refresh(this.translation_id,(function(id,phrase){if(id==self.translation_id){self.block_suggest=false;self.is_icu=phrase.translation.translation_type==="2"?true:false;self.has_plurals=phrase.translation.has_plurals;if(self.has_plurals){self.plural_id=last_plural_form?self.get_last_plural_id():self.get_first_plural_id()}self.clear_translation();jGrowl_close_all();var suggestions=self.plural_id?phrase.suggestions[self.plural_id]:phrase.suggestions[-1];if(suggestions){suggestions=suggestions.sort(crowdin.suggestions._sort_suggestions)}self.render(suggestions);if(suggestions&&crowdin.editor.target_language){crowdin.suggestions.use_top_suggestion()}$.when(crowdin.helpers.alignment.load(),crowdin.glossary.load(false)).then((function(){crowdin.glossary.refresh_phrase_terms();crowdin.translation.textarea_highlight.lightByTranslationId(self.translation_id,crowdin.translation.area.$container);self.focus(true)}));if(!crowdin.editor.jipt_mode){crowdin.models.phrases.preload(crowdin.phrases.get_phrases_ids())}AppEvent.dispatchStringChange()}}));self.disable_prev_translation_arrow()}},{key:"render",value:function render(suggestions){crowdin.editor.view.setState({translation:this.get_translation(),suggestions:suggestions||[],tmAndMtSuggestionsLoaded:false,suggestionsLoaded:suggestions!==undefined,tms:crowdin.suggestions.getTmSuggestions(),mts:crowdin.suggestions.getMtSuggestions()});$("#one-plural-form-help-block").hide();$("#plural_controls_container").hide();$("#plural-examples-link").hide();crowdin.suggestions.suggestions_list.disselect_all();crowdin.user.set_saved_translation(this.translation_id);crowdin.user.set_saved_translation_page(crowdin.user.get_texts_page());this.focus();if(this.has_plurals){if(crowdin.editor.target_language.plurals>1){!IS_MOBILE?this.render_plurals_block():this.render_plurals_block_mobile();this.plural_changed();$("#plural_controls_container").show();$("#plural-examples-link").show()}else{$("#one-plural-form-help-block").show()}$("#icu_preview").addClass("hidden")}else if(this.is_icu){$("#icu_preview").removeClass("hidden");if(this.icu_params.source.elementFormat.indexOf("plural")!==-1){this.show_help_icu_plurals()}}else{$("#icu_preview").addClass("hidden")}this.bindTooltips();this.show_length_ratio();crowdin.editor.layout.resizeSuggestions();if(crowdin.user.settings.enable_autocomplete&&typeof crowdin.translation.closeAutocomplete==="function"){crowdin.translation.closeAutocomplete()}}},{key:"render_plurals_block",value:function render_plurals_block(){var render_to=$("#plurals_tabs");var language=crowdin.editor.target_language;var html="";var plural_name="";var self=this;html+='<li class="disabled"><a href="#">'+_l("editor.form2D")+" </a></li>";for(var i in language.plural_names){if(language.plural_names[i]){plural_name=language.plural_names[i]}else{plural_name=_l("editor.formN",{number:i+1})}html+='<li data-form="'+i+'" class="form"><a href="#">'+plural_name+"</a></li>"}render_to.html(html);render_to.find(".form > a").click((function(e){var num=$(this).parent().data("form");self.open_plural(num);e.preventDefault()}));render_to.find(".disabled > a").click((function(e){e.preventDefault()}))}},{key:"render_plurals_block_mobile",value:function render_plurals_block_mobile(){var render_to=$("#plurals_select");var language=crowdin.editor.target_language;var html="";var plural_name="";var self=this;for(var i in language.plural_names){if(language.plural_names[i]){plural_name=language.plural_names[i]}else{plural_name=_l("editor.formN",{number:i+1})}html+='<option value="'+i+'">'+plural_name+"</option>"}render_to.html(html);render_to.off().on("change",(function(e){var num=$(this).val();self.open_plural(num);e.preventDefault()}))}},{key:"get_first_plural_id",value:function get_first_plural_id(){for(var plural_id in crowdin.editor.target_language.plurals_mapping){return+plural_id}}},{key:"get_last_plural_id",value:function get_last_plural_id(){var result=0;for(var plural_id in crowdin.editor.target_language.plurals_mapping){result=plural_id}return Number(result)}},{key:"show_help_icu_plurals",value:function show_help_icu_plurals(){$("#plural-examples-link").show();var popover=$("#plural-examples-popover");var categoriesString=crowdin.editor.target_language.plural_category_names.join(", ");var categoriesCount=crowdin.editor.target_language.plural_category_names.length;$(".language_plural_form",popover).hide();$(".icu_plural_form",popover).show();$(".icu_plural_form",popover).text(_l("editor.pluralCategoriesInLangPlural",{categories:categoriesString,count:categoriesCount}))}},{key:"plural_changed",value:function plural_changed(){var render_to=!IS_MOBILE?$("#plurals_tabs"):$("#plurals_select");var plural_examples="";var language=crowdin.editor.target_language;if(language.plural_examples[this.plural_id]){plural_examples=language.plural_examples[this.plural_id]}if(!IS_MOBILE){render_to.find("li.form[data-form="+this.plural_id+"]").addClass("active").siblings().removeClass("active")}else{render_to.val(this.plural_id)}var popover=$("#plural-examples-popover");if(plural_examples.length){$(".language_plural_form",popover).show();$(".icu_plural_form",popover).hide();$(".plural-examples",popover).text(plural_examples)}else{$(".language_plural_form",popover).hide()}jGrowl_close_all(true);this.focus()}},{key:"_next_translation",value:function _next_translation(){if(crowdin.editor.jipt_mode==true){$(document).trigger("next_translation");return}var translation_id=crowdin.phrases.next_translation();if(translation_id){this.set_translation_id(translation_id).refresh()}}},{key:"_prev_translation",value:function _prev_translation(){if(crowdin.editor.jipt_mode==true){$(document).trigger("prev_translation");return}var translation_id=crowdin.phrases.prev_translation();if(translation_id){this.set_translation_id(translation_id).refresh(true)}}},{key:"_next_plural",value:function _next_plural(clear_prev_plural){var next_plural_id=crowdin.helpers.translation.get_next_plural_id(this.plural_id);if(next_plural_id>this.get_last_plural_id()){}else{if(clear_prev_plural){this.clear()}this.plural_id=next_plural_id;crowdin.suggestions.refresh();this.plural_changed();if(!clear_prev_plural){crowdin.translation.highlight_save_btn()}}}},{key:"open_plural",value:function open_plural(id){if(id>=0&&id in crowdin.editor.target_language.plurals_mapping){this.clear();this.plural_id=id;crowdin.suggestions.refresh();this.plural_changed()}}},{key:"next",value:function next(clear_plural){if(this.has_plurals&&crowdin.editor.target_language.plurals>1&&crowdin.helpers.translation.get_next_plural_id(this.plural_id)!==-1){this._next_plural(clear_plural)}else{this._next_translation()}this.disable_prev_translation_arrow()}},{key:"prev",value:function prev(){if(this.has_plurals&&crowdin.editor.target_language.plurals>1&&this.plural_id>this.get_first_plural_id()){this._prev_plural()}else{this._prev_translation()}this.disable_prev_translation_arrow()}},{key:"_prev_plural",value:function _prev_plural(){if(crowdin.helpers.translation.get_prev_plural_id(this.plural_id)<0){}else{this.plural_id=crowdin.helpers.translation.get_prev_plural_id(this.plural_id);this.clear();crowdin.suggestions.refresh();this.plural_changed()}}},{key:"disable_prev_translation_arrow",value:function disable_prev_translation_arrow(){var isFirstTranslation=false,hasPlurals=this.plural_id!==-1,firstPlural=this.plural_id===this.get_first_plural_id();if(crowdin.phrases.is_version_basic()){isFirstTranslation=crowdin.phrases.get_phrase_index(this.translation_id)===0}else{isFirstTranslation=crowdin.user.get_texts_index()===1}if(crowdin.user.get_texts_page()===1&&isFirstTranslation){$("#prev_translation").prop("disabled",hasPlurals?firstPlural&&isFirstTranslation:isFirstTranslation)}else{if($("#prev_translation").prop("disabled")){$("#prev_translation").prop("disabled",hasPlurals?firstPlural&&isFirstTranslation:isFirstTranslation)}}}},{key:"bindTooltips",value:function bindTooltips(){if(IS_MOBILE){return}var target_el=$("#source_phrase_container").parent();$("body > .ui-tooltip").remove();var config={track:true,showURL:false,show:150,hide:150,items:"*[title]:not(.align_item),*:not(.term_item)>.align_item[title]"};target_el.uitooltip(config)}},{key:"bindEvents",value:function bindEvents(){var self=this;$("#icu-structure-insert").click((function(){self.show_help_icu_plurals()}));$("body").on("click",(function(e){if(!crowdin.user.settings.enable_autocomplete){return true}if(!$(".ui-autocomplete").is(e.target)&&$(".ui-autocomplete").has(e.target).length===0){self.closeAutocomplete()}}));$(document).mousedown((function(e){if($(e.target).closest("#source_phrase_popup").length===0){self.hideSourcePhrasePopup()}if($(e.target).closest(".popover").length===0&&$(e.target).closest("#plural-examples-link").length===0){self.closePluralExamplesPopover();$("#plural-examples-link").removeClass("active")}}));var context_menu_shown=false;$(document).on("mouseup contextmenu","#source_phrase_container div, #source_plural_container div",(function(e){if(!context_menu_shown&&e.type==="mouseup"){self.showSourcePhrasePopup(e.pageX,e.pageY)}context_menu_shown=e.type==="contextmenu"}));$("#search-concordance-btn").click((function(){crowdin.panel.show();self.searchConcordanceClick($(this).data("selection"));$("#concordance-query").focus();return false}));$("#quick-search-term-btn").click((function(){self.hideSourcePhrasePopup();$("#project_glossaries").tab("show");if(!crowdin.editor.layout.isOpened("left")){crowdin.editor.layout.toggle("right")}$("#search_terms").val($(this).data("selection")).trigger("input");return false}));$(document).on("click","#quick-add-term-btn",(function(){self.quickAddTermClick($(this).data("selection"));return false}));$(document).on("keyup",".jGrowl-default-buttons",(function(e){if(e.keyCode==27){$(this).closest(".jGrowl-notification").remove();self.focus();return false}}));$(document).on("click","#commit-notification-confirm",(function(){self.save_suggestion(true);$(this).closest(".jGrowl-notification").remove();self.focus();return false}));$(document).on("click","#commit-notification-cancel",(function(){$(this).closest(".jGrowl-notification").remove();self.focus();return false}));$(document).on("click","#approve-confirmation-approve",(function(){crowdin.suggestions.approve_suggestion($(this).data("suggestion-id"),true);$(this).closest(".jGrowl-notification").remove();return false}));$(document).on("click","#approve-confirmation-cancel",(function(){self.next(false);$(this).closest(".jGrowl-notification").remove();return false}));$(document).on("click","#approve-confirmation-create-issue",(function(e){var suggestion=crowdin.suggestions.get_suggestion($(this).data("suggestion-id"));var text=_l("editor.approvedTranslationIsNotCorrectReviewMyTranslation",{suggestion:suggestion.text});crowdin.panel.show();crowdin.panel.select_tab("#discussions_tab");crowdin.panel.activate_discussion_control();$("#discussion_create_issue").prop("checked",true);$("#discussion_issue_type").parent().show();$("#discussion_issue_type").val("1");insert_in_textarea("#discussions_control textarea",text);$(this).closest(".jGrowl-notification").remove();return false}));$(document).on("click","#approve-confirmation-not-notify",(function(){self.next(false);$(this).closest(".jGrowl-notification").remove();return false}));crowdin.helpers.alignment.bind()}},{key:"save_suggestion",value:function save_suggestion(force_saving,suggestion){var self=this;var translation_id=self.translation_id;var plural_id=self.plural_id;if(!suggestion){suggestion=this.get_suggest_text()}if(self.block_suggest){return false}if(!force_saving){if(crowdin.editor.jipt_mode&&crowdin.jipt.validation_enabled){return self.invoke_custom_jipt_validator(suggestion)}}var provider=crowdin.suggestions.default_provider;if(crowdin.suggestions.auto_suggestion.translation_id===self.translation_id&&crowdin.suggestions.auto_suggestion.text===self.getValue()){provider=crowdin.suggestions.auto_suggestion.provider}self.block_suggest=true;var request_data={project_id:crowdin.editor.project.id,workflow_step_id:crowdin.editor.workflow_step.id,target_language_id:crowdin.editor.target_language.id,translation_id:translation_id,text:suggestion,plural_id:plural_id,provider:provider,filter:crowdin.user.get_texts_sort_order()};if(!crowdin.phrases.markup_replacer().is_dummy()){var masked_data={};masked_data.text=self.getValue();masked_data.source_text=self.getSourceText();if(self.has_plurals){masked_data.source_plurals=self.getTranslationsPlurals()}request_data.masked=masked_data}if(force_saving){request_data.force_saving=1}if(provider.type!=="default"){crowdin.trackEvent("Editor","Save MT Suggestion",provider.name);crowdin.trackEvent("Editor","Save MT Suggestion ("+crowdin.editor.target_language.code+")",provider.name)}crowdin.ajax.postData("/translation/suggest",request_data,(function(data){self.block_suggest=false;if(data.success){crowdin.suggestions.save_suggestion_provider(false);crowdin.phrases.update_translation_status(data.translation_id,data.top_suggestion,data.translation_status);crowdin.phrases.update_qa_issues_info(data.translation_id,data.qa_issues);crowdin.models.phrases.edit_suggestion(translation_id,plural_id,data.suggestion.id,data.suggestion);crowdin.models.phrases.edit_translation(translation_id,{step_status:data.translation_status.step_status});$(document).trigger("update_translation",data);jGrowl_close_all();self.highlight_save_btn();AppEvent.dispatchSuggestTranslation(data.suggestion);if(data.approve_confirmation){crowdin.suggestions.notify(_l("editor.suggestionWontBeIncludedIntoFileQ"),data.suggestion.id,false)}else if(data.create_issue_confirmation){var message,validations=crowdin.editor.view.state.suggestions[0].validations;var count=Object.keys(validations).length;if(count>1){var approve_info=crowdin.models.phrases._highest_approve(validations);message=_l("editor.translationIsValidatedOnStepQ",{step:approve_info.name})}else{message=_l("editor.stringAlreadyApprovedQ")}crowdin.suggestions.notify_create_issue(message,data.suggestion.id)}else{if(data.translation_id===self.translation_id){self.next(false)}}}else{if(data.validations){self.autofix.save_validations(data.validations);self.autofix.show_validation_notifications()}}}),_l("editor.savingTranslationD"));crowdin.trackEvent("Editor","Commit translation");return true}},{key:"toggle_visibility",value:function toggle_visibility(hidden){var translation_id=crowdin.translation.translation_id;var params=["hide/show",crowdin.editor.project.id,translation_id];if(crowdin.ajax.isLocked(params)){return}crowdin.phrases.mark_as_hidden(translation_id,hidden);crowdin.models.phrases.edit_translation(translation_id,{hidden:hidden});crowdin.ajax.getData("/translation/change_visibility",{project_id:crowdin.editor.project.id,translation_id:translation_id,hidden:Number(hidden),_lockKey:params},(function(data){if(!data.success){crowdin.phrases.mark_as_hidden(translation_id,!hidden);crowdin.models.phrases.edit_translation(translation_id,{hidden:!hidden});crowdin.notify(data.msg,"error")}else{$(document).trigger("update_phrase",{translation_id:translation_id,translation:{hidden:hidden}})}}));crowdin.trackEvent("Editor",hidden?"Hide string (mark invisible)":"Make string visible")}},{key:"notificate",value:function notificate(message,cancel_denied){if(!cancel_denied){message+="\n"+"<div class='jGrowl-default-buttons btn-toolbar text-center'>"+"<button class='btn btn-small' id='commit-notification-confirm'>"+_l("editor.saveAnyway")+"</button>"+"<button class='btn btn-small' id='commit-notification-cancel'>"+_l("generic.cancel")+"</button>"+"</div>"}jGrowl_close_all();crowdin.notify(message,{life:1e4,afterOpen:function afterOpen(e){$("#commit-notification-confirm").focus()}})}},{key:"openAutocomplete",value:function openAutocomplete(hotkey){var self=this;clearTimeout(this.delatAutocomplete);if(crowdin.user.settings.enable_autocomplete&&!IS_MOBILE){this.delatAutocomplete=setTimeout((function(){self.showAutoComplete(hotkey);self.area.$container.autocomplete("search","")}),50)}}},{key:"closeAutocomplete",value:function closeAutocomplete(){if(!IS_MOBILE&&this.area.$container.autocomplete("widget").is(":visible")){clearTimeout(this.delatAutocomplete);this.area.$container.autocomplete({source:[]});this.area.$container.autocomplete("close");this.area.$container.autocomplete("widget").hide()}}},{key:"getWordObject",value:function getWordObject(){var text=this.area.$container.val();var start=this.area.$container[0].selectionStart-1;var end=this.area.$container[0].selectionEnd;var stopCharacters=[" ","\n","\r","\t"];while(start>0){if(stopCharacters.indexOf(text[start])===-1){--start}else{break}}++start;while(end<text.length){if(stopCharacters.indexOf(text[end])===-1){++end}else{break}}var words=text.trim().slice(0,start).split(" ");var index=words.length-words.filter((function(value){return value.length===0})).length;var caretPos=this.area.$container.textareaHelper("getOriginalCaretPos");var startSubText=text.slice(0,caretPos).replace(/\r|\t|\n/g," ");var currentWord=startSubText.slice(startSubText.lastIndexOf(" ")>=0?startSubText.lastIndexOf(" ")+1:0);return{text:text,start:start,index:index,end:end,word:currentWord,caretPos:caretPos}}},{key:"getAutocompleteSources",value:function getAutocompleteSources(wordObj,hotkey){var self=this;var uniqueWords=crowdin.suggestions.uniqeWords;if(!wordObj.word){_response=this.sortResponseWords(uniqueWords,wordObj);var finalResponse=[];for(var i in _response){finalResponse.push(_response[i].word)}return finalResponse}var _response=[];for(var i in uniqueWords){var is_tag=false;if(uniqueWords[i].word.match(/^[{<#%&\\\/]/)){is_tag=true}var regex=new RegExp(self.getAutocompleteRegExp(uniqueWords[i].word.toLowerCase(),is_tag),"g");if(wordObj.text.toLowerCase().slice(0,wordObj.caretPos).replace(/\r\n|\r|\n/g," ").match(regex)){_response.push(uniqueWords[i])}}_response=this.sortResponseWords(_response,wordObj);var finalResponse=[];for(var i in _response){finalResponse.push(_response[i].word)}if(finalResponse.length===0&&hotkey){_response=this.sortResponseWords(uniqueWords,wordObj);var finalResponse=[];for(var i in _response){finalResponse.push(_response[i].word)}}return finalResponse}},{key:"getAutocompleteRegExp",value:function getAutocompleteRegExp(src,is_tag){var specials=["-","[","]","/","{","}","(",")","*","+","?",".","\\","^","$","|"];var regex=RegExp("["+specials.join("\\")+"]","g");var strings=[];$.each(src,(function(index){strings.push(src.slice(0,-1*index).replace(regex,"\\$&"))}));strings[0]=src.replace(regex,"\\$&");var match_letter="[A-Za-zªµºÀ-ÖØ-öø-ˁˆ-ˑˠ-ˤˬˮͰ-ʹͶͷͺ-ͽͿΆΈ-ΊΌΎ-ΡΣ-ϵϷ-ҁҊ-ԯԱ-Ֆՙա-ևא-תװ-ײؠ-يٮٯٱ-ۓەۥۦۮۯۺ-ۼۿܐܒ-ܯݍ-ޥޱߊ-ߪߴߵߺࠀ-ࠕࠚࠤࠨࡀ-ࡘࢠ-ࢴऄ-हऽॐक़-ॡॱ-ঀঅ-ঌএঐও-নপ-রলশ-হঽৎড়ঢ়য়-ৡৰৱਅ-ਊਏਐਓ-ਨਪ-ਰਲਲ਼ਵਸ਼ਸਹਖ਼-ੜਫ਼ੲ-ੴઅ-ઍએ-ઑઓ-નપ-રલળવ-હઽૐૠૡૹଅ-ଌଏଐଓ-ନପ-ରଲଳଵ-ହଽଡ଼ଢ଼ୟ-ୡୱஃஅ-ஊஎ-ஐஒ-கஙசஜஞடணதந-பம-ஹௐఅ-ఌఎ-ఐఒ-నప-హఽౘ-ౚౠౡಅ-ಌಎ-ಐಒ-ನಪ-ಳವ-ಹಽೞೠೡೱೲഅ-ഌഎ-ഐഒ-ഺഽൎൟ-ൡൺ-ൿඅ-ඖක-නඳ-රලව-ෆก-ะาำเ-ๆກຂຄງຈຊຍດ-ທນ-ຟມ-ຣລວສຫອ-ະາຳຽເ-ໄໆໜ-ໟༀཀ-ཇཉ-ཬྈ-ྌက-ဪဿၐ-ၕၚ-ၝၡၥၦၮ-ၰၵ-ႁႎႠ-ჅჇჍა-ჺჼ-ቈቊ-ቍቐ-ቖቘቚ-ቝበ-ኈኊ-ኍነ-ኰኲ-ኵኸ-ኾዀዂ-ዅወ-ዖዘ-ጐጒ-ጕጘ-ፚᎀ-ᎏᎠ-Ᏽᏸ-ᏽᐁ-ᙬᙯ-ᙿᚁ-ᚚᚠ-ᛪᛱ-ᛸᜀ-ᜌᜎ-ᜑᜠ-ᜱᝀ-ᝑᝠ-ᝬᝮ-ᝰក-ឳៗៜᠠ-ᡷᢀ-ᢨᢪᢰ-ᣵᤀ-ᤞᥐ-ᥭᥰ-ᥴᦀ-ᦫᦰ-ᧉᨀ-ᨖᨠ-ᩔᪧᬅ-ᬳᭅ-ᭋᮃ-ᮠᮮᮯᮺ-ᯥᰀ-ᰣᱍ-ᱏᱚ-ᱽᳩ-ᳬᳮ-ᳱᳵᳶᴀ-ᶿḀ-ἕἘ-Ἕἠ-ὅὈ-Ὅὐ-ὗὙὛὝὟ-ώᾀ-ᾴᾶ-ᾼιῂ-ῄῆ-ῌῐ-ΐῖ-Ίῠ-Ῥῲ-ῴῶ-ῼⁱⁿₐ-ₜℂℇℊ-ℓℕℙ-ℝℤΩℨK-ℭℯ-ℹℼ-ℿⅅ-ⅉⅎↃↄⰀ-Ⱞⰰ-ⱞⱠ-ⳤⳫ-ⳮⳲⳳⴀ-ⴥⴧⴭⴰ-ⵧⵯⶀ-ⶖⶠ-ⶦⶨ-ⶮⶰ-ⶶⶸ-ⶾⷀ-ⷆⷈ-ⷎⷐ-ⷖⷘ-ⷞⸯ々〆〱-〵〻〼ぁ-ゖゝ-ゟァ-ヺー-ヿㄅ-ㄭㄱ-ㆎㆠ-ㆺㇰ-ㇿ㐀-䶵一-鿕ꀀ-ꒌꓐ-ꓽꔀ-ꘌꘐ-ꘟꘪꘫꙀ-ꙮꙿ-ꚝꚠ-ꛥꜗ-ꜟꜢ-ꞈꞋ-ꞭꞰ-ꞷꟷ-ꠁꠃ-ꠅꠇ-ꠊꠌ-ꠢꡀ-ꡳꢂ-ꢳꣲ-ꣷꣻꣽꤊ-ꤥꤰ-ꥆꥠ-ꥼꦄ-ꦲꧏꧠ-ꧤꧦ-ꧯꧺ-ꧾꨀ-ꨨꩀ-ꩂꩄ-ꩋꩠ-ꩶꩺꩾ-ꪯꪱꪵꪶꪹ-ꪽꫀꫂꫛ-ꫝꫠ-ꫪꫲ-ꫴꬁ-ꬆꬉ-ꬎꬑ-ꬖꬠ-ꬦꬨ-ꬮꬰ-ꭚꭜ-ꭥꭰ-ꯢ가-힣ힰ-ퟆퟋ-ퟻ豈-舘並-龎ﬀ-ﬆﬓ-ﬗיִײַ-ﬨשׁ-זּטּ-לּמּנּסּףּפּצּ-ﮱﯓ-ﴽﵐ-ﶏﶒ-ﷇﷰ-ﷻﹰ-ﹴﹶ-ﻼＡ-Ｚａ-ｚｦ-ﾾￂ-ￇￊ-ￏￒ-ￗￚ-ￜ]";var match_number="[0-9٠-٩۰-۹߀-߉०-९০-৯੦-੯૦-૯୦-୯௦-௯౦-౯೦-೯൦-൯෦-෯๐-๙໐-໙༠-༩၀-၉႐-႙០-៩᠐-᠙᥆-᥏᧐-᧙᪀-᪉᪐-᪙᭐-᭙᮰-᮹᱀-᱉᱐-᱙꘠-꘩꣐-꣙꤀-꤉꧐-꧙꧰-꧹꩐-꩙꯰-꯹０-９]";if(is_tag){return"("+strings.join("|")+")$"}else{return"((?!"+match_letter+"|"+match_number+").("+strings.join("|")+")|^("+strings.join("|")+"))$"}}},{key:"sortResponseWords",value:function sortResponseWords(words,currentWordObj){if(currentWordObj.caretPos===0){words.sort((function(a,b){if(a.index<b.index){return-1}else if(a.index>b.index){return 1}else if(a.relevance>b.relevance){return-1}else if(a.relevance<b.relevance){return 1}else{return 0}}));return words}var startGroup=[];var midGroup=[];var endGroup=[];for(var i in words){var word=words[i];if(word.index-5<currentWordObj.caretPos&&currentWordObj.caretPos<word.index+5){startGroup.push(word)}else{if(word.index+5<currentWordObj.caretPos){endGroup.push(word)}else{midGroup.push(word)}}}midGroup.sort((function(a,b){if(a.index<b.index){return-1}else if(a.index>b.index){return 1}else if(a.relevance>b.relevance){return-1}else if(a.relevance<b.relevance){return 1}else{return 0}}));return startGroup.concat(midGroup,endGroup)}},{key:"showAutoComplete",value:function showAutoComplete(hotkey){var translationTextarea=this.area.$container;var translationAreaOffest=translationTextarea.offset();var self=this;translationTextarea.bind("keydown",(function(e){if(e.keyCode===$.ui.keyCode.TAB){e.preventDefault()}})).autocomplete({appendTo:"body",delay:0,minLength:0,autoFocus:true,position:{of:"body"},source:function source(request,response){response(self.getAutocompleteSources(self.getWordObject(),hotkey))},focus:function focus(){return false},select:function select(e,ui){if(e.ctrlKey||e.shiftKey||e.altKey||e.metaKey){return false}var currentWord=self.getWordObject();var short_regex=new RegExp(self.getAutocompleteRegExp(ui.item.value.toLowerCase(),true),"g");var string_to_complete=null;var string_to_complete_length=0;if(string_to_complete=currentWord.text.toLowerCase().slice(0,currentWord.caretPos).match(short_regex)){string_to_complete_length=string_to_complete[0].length}else{string_to_complete_length=0}var textEvent=document.createEvent("TextEvent");var textarea=document.getElementById("translation");try{textarea.selectionStart=currentWord.caretPos-string_to_complete_length;textarea.selectionEnd=currentWord.caretPos;var commandSuccess=document.execCommand("insertText",false,ui.item.value);if(!commandSuccess){textEvent.initTextEvent("textInput",true,true,null,ui.item.value);textarea.dispatchEvent(textEvent)}}catch(e){this.value=currentWord.text.slice(0,currentWord.caretPos-string_to_complete_length)+ui.item.value+currentWord.text.slice(currentWord.caretPos)}var newCursorPos=currentWord.text.slice(0,currentWord.caretPos-string_to_complete_length).length+ui.item.value.length;textarea.selectionStart=newCursorPos;textarea.selectionEnd=newCursorPos;return false},open:function open(){var newY=translationTextarea.textareaHelper("caretPos").top+parseInt(translationTextarea.css("font-size"),10)*1.5+translationAreaOffest.top;if(translationTextarea.textareaHelper("caretPos").right){var newX=translationTextarea.width()+translationAreaOffest.left-translationTextarea.textareaHelper("caretPos").right}else{var newX=translationTextarea.textareaHelper("caretPos").left+translationAreaOffest.left}$(".ui-autocomplete").css("position","fixed").css("top",newY).css("left",newX).css("width","auto").css("max-height","200px").css("max-width","calc(100% - 10px)").css("overflow-y","auto");var textarea_right_position=translationTextarea.offset().left+parseInt(translationTextarea.css("width"));var autocomplete_right_position=$(".ui-autocomplete").offset().left+parseInt($(".ui-autocomplete").css("width"));if(autocomplete_right_position>textarea_right_position){$(".ui-autocomplete").css("left",textarea_right_position-parseInt($(".ui-autocomplete").css("width")))}}});var autocomplete_obj=translationTextarea.data("autocomplete");autocomplete_obj._move=function(direction,e){if(!autocomplete_obj.menu.element.is(":visible")){autocomplete_obj.search(null,e);return}if(autocomplete_obj.menu.isFirstItem()&&/^previous/.test(direction)||autocomplete_obj.menu.isLastItem()&&/^next/.test(direction)){autocomplete_obj.menu.blur();if(autocomplete_obj.term){autocomplete_obj._move(direction)}return}this.menu[direction](e)};autocomplete_obj._searchTimeout=function(){}}},{key:"show_length_ratio",value:function show_length_ratio(){if(!crowdin.editor.textareaView||this.isTranslationLoading())return;crowdin.editor.textareaView.setState({suggestionText:this.getValue()})}},{key:"get_suggest_text",value:function get_suggest_text(){return crowdin.phrases.markup_replacer().unmask(this.getValue())}},{key:"invoke_custom_jipt_validator",value:function invoke_custom_jipt_validator(translation){var self=this;var source=self.get_appropriate_source_text("raw_text");var language=crowdin.editor.target_language.code;var context=$("#source_context_container").text();crowdin.jipt.sendValidationRequest({source:source,translation:translation,context:context,language:language},(function(response){if(response.status==="corrected"){translation=response.correction}if(response.status==="error"){var message=response.message?response.message:_l("editor.translationIsNotValid");self.notificate(message,!response.can_commit_anyway)}if(response.status!=="error"){self.save_suggestion(true,translation)}}));return false}},{key:"show_screenshot",value:function show_screenshot(caller){var self=this;if(!caller){return}var id=parseInt(caller.id.replace("string-screenshot-",""));if(!self.tagScreenshots[id]){self.tagScreenshots[id]=new tag_screenshot(crowdin.editor.project.id,id)}$(document).off(".crowdin_screenshots");$(document).on("keyup.crowdin_screenshots keydown.crowdin_screenshots",(function(e){if(e.keyCode===39){if(e.type==="keydown"){$(".screenshot-switcher.next","#tag_screenshot_dialog").addClass("active")}else{self.show_next_screenshot(caller)}}else if(e.keyCode===37){if(e.type==="keydown"){$(".screenshot-switcher.prev","#tag_screenshot_dialog").addClass("active")}else{self.show_prev_screenshot(caller)}}}));$(document).on("click.crowdin_screenshots",".screenshot-switcher",(function(){if($(this).hasClass("next")){self.show_next_screenshot(caller)}else if($(this).hasClass("prev")){self.show_prev_screenshot(caller)}}));self.tagScreenshots[id].show_screenshot_for_translators(self.translation_id,htmlspecialchars($(caller).attr("alt")));if($(caller).next(".string-screenshot").length){$(".screenshot-switcher.next","#tag_screenshot_dialog").removeClass("hidden")}if($(caller).prev(".string-screenshot").length){$(".screenshot-switcher.prev","#tag_screenshot_dialog").removeClass("hidden")}}},{key:"show_next_screenshot",value:function show_next_screenshot(caller){this.show_screenshot($(caller).next(".string-screenshot").get(0))}},{key:"show_prev_screenshot",value:function show_prev_screenshot(caller){this.show_screenshot($(caller).prev(".string-screenshot").get(0))}},{key:"hideSourcePhrasePopup",value:function hideSourcePhrasePopup(){$(window).off(".phrase_popup");var $node=$("#source_phrase_container").parent();if(!IS_MOBILE&&$node.length&&$node.data("uitooltip")){$node.uitooltip("enable")}$("#source_phrase_popup").addClass("hidden").css({top:"-100px",left:"-100px"})}},{key:"showSourcePhrasePopup",value:function showSourcePhrasePopup(x,y){var self=this;var el=$("#source_phrase_popup");setTimeout((function(){var selection=$.trim(self.getSelection());if(selection.length>0&&el.hasClass("hidden")){var $node=$("#source_phrase_container").parent();if(!IS_MOBILE&&$node.length&&$node.data("uitooltip")){$node.uitooltip("disable")}$(window).on("resize.phrase_popup",(function(){self.hideSourcePhrasePopup()}));$("#search-concordance-btn",el).data("selection",selection);$("#quick-search-term-btn",el).data("selection",selection);$("#quick-add-term-btn",el).data("selection",selection);$("#quick-use-btn",el).data("selection",selection);$("#source-phrase-copy-btn",el).data("selection",selection);$("#source-phrase-copy-paste-btn",el).data("selection",selection);el.css({top:y+"px",left:x+"px"}).removeClass("hidden")}}),100)}},{key:"searchConcordanceClick",value:function searchConcordanceClick(selection){this.hideSourcePhrasePopup();crowdin.plugins.concordance.search_concordance(selection)}},{key:"quickAddTermClick",value:function quickAddTermClick(selection){this.hideSourcePhrasePopup();crowdin.glossary.show_new_term_dialog(selection)}},{key:"getSelection",value:function getSelection(){if(window.getSelection){return window.getSelection().toString()}else if(document.getSelection){return document.getSelection().toString()}else{var selection=document.selection&&document.selection.createRange();if(selection.text){return selection.text}return""}}},{key:"closePluralExamplesPopover",value:function closePluralExamplesPopover(){$("#plural-examples-link").popover("hide")}},{key:"get_appropriate_source_text",value:function get_appropriate_source_text(type){var first_plural_id=crowdin.editor.source_language.plural_ids[0];var plural_id=first_plural_id;var text="";if(this.has_plurals){plural_id=crowdin.editor.target_language.plurals_mapping[this.plural_id]}if(type==="raw_text"){var translation=this.get_translation();text=plural_id>first_plural_id&&translation.plurals[plural_id]?translation.plurals[plural_id]:translation.text;text=htmlspecialchars_decode(strip_tags(text))}else{if(plural_id==first_plural_id){text=this.getSourceText()}else{var plural=$("#source_plural_container").find('.plurals[data-plural-id="'+plural_id+'"]');text=plural.length?plural.text():this.getSourceText()}}return text}},{key:"getAppropriateSourceText",value:function getAppropriateSourceText(translation,type,pluralId){var text="";var firstPluralId=crowdin.editor.source_language.plural_ids[0];if(+this.translation_id!==+translation.id){return""}if(pluralId===undefined){pluralId=translation.has_plurals?this.plural_id:firstPluralId}if(translation.has_plurals&&pluralId>firstPluralId){pluralId=crowdin.editor.target_language.plurals_mapping[pluralId]}if(type==="raw_text"){text=pluralId>firstPluralId&&translation.plurals[pluralId]?translation.plurals[pluralId]:translation.text;text=htmlspecialchars_decode(strip_tags(text))}else{if(pluralId===firstPluralId){text=translation.text}else{var $plural=$("div#phrase_"+translation.id).find('.plurals[data-plural-id="'+pluralId+'"]');text=$plural.length?$plural.text():this.get_source_text()}}return text}},{key:"getSourceSkeleton",value:function getSourceSkeleton(){var sourceStringSkeleton="",sourceString=this.get_appropriate_source_text("source");if(this.is_icu||crowdin.editor.modeReviewProofread()&&this.data.is_icu){var icuHelper=new IcuHelper(sourceString);sourceStringSkeleton=icuHelper.getSkeleton(icuHelper.getModifiedString())}else{sourceStringSkeleton=this.getSourceTags().join(" ")}return sourceStringSkeleton}},{key:"highlight_save_btn",value:function highlight_save_btn(e){var text_raw=this.getValue();var plural_id=crowdin.translation.plural_id,translation_id=crowdin.translation.translation_id;var btn=$("#suggest_translation");var has_unsaved=text_raw&&crowdin.helpers.translation.has_unsaved(text_raw,translation_id,plural_id);btn.prop("disabled",!text_raw);btn[has_unsaved?"addClass":"removeClass"]("btn-primary");var isTrigger=e?e.isTrigger:false;if(!(isTrigger&&!text_raw)){this.update_unsaved_storage(text_raw,translation_id,plural_id)}}},{key:"update_unsaved_storage",value:function update_unsaved_storage(text_raw,translation_id,plural_id){var has_unsaved=crowdin.helpers.translation.has_unsaved(text_raw,translation_id,plural_id);if(has_unsaved){crowdin.helpers.translation.update_unsaved_suggestions_storage(text_raw,translation_id,plural_id)}else{crowdin.helpers.translation.remove_unsaved_suggestions_storage(translation_id,plural_id)}}},{key:"clear",value:function clear(){this.area.clear()}},{key:"setValue",value:function setValue(value,option){this.area.setValue(value,option)}},{key:"getValue",value:function getValue(){return this.area.getValue()}},{key:"insertValue",value:function insertValue(value){this.area.insertValue(value)}},{key:"focus",value:function focus(){var alignmentLoad=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(IS_MOBILE||is_mobile_device.any()||$("#editor_search_bar").get(0)===document.activeElement||!$("#editor-center-layout .editor-pane-mask").hasClass("mask-hidden")){return}if(alignmentLoad){this.area.$container.highlightWithinTextarea("focus")}else{this.area.focus()}}},{key:"onEditTranslation",value:function onEditTranslation(e,data){if(crowdin.editor.project.has_distributions){this.publishDraft()}if(crowdin.editor.jipt_mode){crowdin.jipt.sendEditTranslationMessage()}this.show_length_ratio();this.highlight_save_btn(e);if(!data||!data.show_jgrowl){jGrowl_close_all()}if("html"==crowdin.phrases.version&&crowdin.user.settings.html_editor_preview){crowdin.phrases.realtime_html_preview(true)}if(this.is_icu){crowdin.editor.icu_preview.shouldFormatIcuElements=true;crowdin.editor.icu_preview.setState({id:null,value:null});crowdin.editor.layout.resizeSuggestions()}crowdin.models.mt.interactive_suggestion(crowdin.translation.getValue())}},{key:"getSourceText",value:function getSourceText(){var copy_source="";var childNodes=$("#source_phrase_container div").get(0).childNodes;for(var i=0;i<childNodes.length;i++){if($(childNodes[i]).hasClass("br_light")){copy_source+="\n"}else if(childNodes[i].textContent){copy_source+=childNodes[i].textContent}}return copy_source}},{key:"getTranslationsPlurals",value:function getTranslationsPlurals(){var plurals_arr=[];var $plurals=$("#source_plural_container").find(".plurals");if($plurals.length){$plurals.each((function(){plurals_arr.push($(this).text())}))}else{plurals_arr.push(this.getSourceText())}return plurals_arr}},{key:"isTranslationLoading",value:function isTranslationLoading(){return $("#source_phrase_container > div").hasClass("translation_loading")}},{key:"publishDraft",value:function publishDraft(){var request_data={project_id:crowdin.editor.project.id,translation_id:this.translation_id,language_code:crowdin.editor.target_language.code,plural_id:this.plural_id,text:this.area.$container.val()};clearTimeout(this.input_timeout);this.input_timeout=setTimeout((function(){crowdin.ajax.postData("/translation/update_draft",request_data)}),1e3)}},{key:"getSourceTags",value:function getSourceTags(){var firstPluralId=crowdin.editor.source_language.plural_ids[0],pluralId=this.has_plurals?crowdin.editor.target_language.plurals_mapping[this.plural_id]:firstPluralId;var nodesArray=firstPluralId===pluralId?$("#source_phrase_container > div > ".concat(crowdin.highlight.default_class_selector)):$('#source_plural_container > .plurals[data-plural-id="'.concat(pluralId,'"] > ').concat(crowdin.highlight.default_class_selector));return Array.from(nodesArray,(function(tag){return tag.innerText}))}},{key:"getTargetTags",value:function getTargetTags(tags){var translationString=this.getValue();return tags.filter((function(tag){return translationString.indexOf(tag)!==-1}))}},{key:"getNextTag",value:function getNextTag(){var sourceTags=this.getSourceTags();var targetTags=this.getTargetTags(sourceTags);var availableTags=sourceTags.slice(0);if(targetTags.length&&sourceTags.length){availableTags=sourceTags.filter((function(el){return!(targetTags.indexOf(el)!==-1)}))}return availableTags.length?availableTags[0]:null}}]);return crowdin_translation}(CrowdinComponent);
