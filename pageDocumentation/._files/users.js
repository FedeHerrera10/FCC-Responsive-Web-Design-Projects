"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}var crowdin_users_helper=function(){function crowdin_users_helper(){_classCallCheck(this,crowdin_users_helper);this.users={};this.user_types={0:USER_TYPE_DEFAULT,1:USER_TYPE_INTERNAL,2:USER_TYPE_EXTERNAL,3:USER_TYPE_TECHNICAL};this.bindEvents()}_createClass(crowdin_users_helper,[{key:"initUsers",value:function initUsers(){var phrases=[];try{if(crowdin.phrases&&crowdin.phrases.phrases.length>0){phrases=crowdin.phrases.phrases}else if(crowdin.translation&&crowdin.translation.translation_id){phrases=[{id:crowdin.translation.translation_id}]}}catch(e){crowdin.log.error("[JS] can't build users array for popover","warning")}for(var phraseKey in phrases){var phrase=phrases[phraseKey];var phraseId=phrase.id||phrase.translation.id;var suggestions=phrase.suggestions||crowdin.suggestions.get_suggestions(phraseId);var discussions=crowdin.models.phrases.discussions(phraseId);for(var i in suggestions){var suggestion=suggestions[i];crowdin.helpers.users.users[suggestion.user.id]=suggestion.user;for(var j in suggestion.validations){var validation=suggestion.validations[j];if(validation.approved){crowdin.helpers.users.users[validation.approver.id]=validation.approver}}}for(var k in discussions){var discussion=discussions[k];crowdin.helpers.users.users[discussion.user.id]=discussion.user;crowdin.helpers.users.users=Object.assign(crowdin.helpers.users.users,discussion.mentions)}if(crowdin.models.external_suggestions){var externalSuggestions=crowdin.models.external_suggestions.suggestions(phraseId,crowdin.translation.plural_id);for(var l in externalSuggestions){var externalSuggestion=externalSuggestions[l];crowdin.helpers.users.users[externalSuggestion.user.id]=externalSuggestion.user}}}}},{key:"bindEvents",value:function bindEvents(){var _this=this;var addMentionLinksClass=".add-mention";$(document).on("click",addMentionLinksClass,(function(event){var userId=$(event.target).data("id");var cbFunction=IS_MOBILE?crowdin.editor.layout.hideModalMenu.call(crowdin.editor.layout):_this.closeUserPopover;_this.addMention(userId,cbFunction);return false}))}},{key:"showUserInfo",value:function showUserInfo(userInfo){if(!this.users[$(userInfo).data("id")]){return}if(IS_MOBILE){this.showInfoMobile(userInfo)}else{this.showPopover(userInfo)}}},{key:"showInfoMobile",value:function showInfoMobile(userInfo){$("#user_info_options").html('<div class="center">'+this.getContent($(userInfo))+"</div>");crowdin.editor.layout.showModalMenu("#user_info_options")}},{key:"showPopover",value:function showPopover(userInfo){var userLink=$(userInfo);var userPopover=$(".user-popover");if(userPopover.length){var active=userLink.hasClass("active");this.closeUserPopover();if(active){return}}var popover=$('<div class="popover user-popover" data-id="'.concat(userLink.data("id"),'">\n        ').concat(this.getContent(userLink),"\n      </div>"));popover.detach().css({top:0,left:0,display:"block"});popover.appendTo("body");userLink.addClass("active");this.popoverPosition(userInfo,popover,$("body"))}},{key:"getContent",value:function getContent(userInfo){var options="";var userId=+userInfo.data("id");var directMessagesHref="/u/messages/create/";var user=this.users[userId];if(user){if(!IS_ENTERPRISE){directMessagesHref="/messages/create/";options+=""+'<li class="divider"></li>'+'<li class="text-left">'+'<a target="_blank" tabindex="-1" href="/profile/'+user.login+'">'+_l("editor.goToProfile")+"</a>"+"</li>"}if(+crowdin.user.id!==userId&&this.user_types[+user.type]!==USER_TYPE_TECHNICAL){options+=options.length?"":'<li class="divider"></li>';options+=""+'<li class="text-left">'+'<a target="_blank" tabindex="-1" href="'+directMessagesHref+userId+'">'+_l("editor.directMessages")+"</a>"+"</li>";options+=""+'<li class="text-left">'+'<a tabindex="-1" class="add-mention" href="#" data-id="'+userId+'">'+_l("editor.addMention")+"</a>"+"</li>"}var dateOptions={hour12:TIME_AM_PM,hour:"numeric",minute:"numeric"};if(user.timezone){dateOptions.timeZone=user.timezone}return""+'<ul class="nav nav-list margin-top s-margin-bottom">'+'<li class="text-center">'+'<img class="user-avatar img-circle" style="width: 80px; height: 80px;" alt="" src="'+user.avatar_url+'">'+'<h5 class="no-margin-bottom" style="word-wrap: break-word;">'+htmlspecialchars(user.name)+"</h5>"+'<div class="muted">@'+user.login+"</div>"+"</li>"+'<li class="divider"></li>'+'<li class="disabled local-time">'+'<a href="#">'+(new Date).toLocaleString([],dateOptions)+" "+_l("editor.localTime")+"</a>"+"</li>"+options+"</ul>"}}},{key:"closeUserPopover",value:function closeUserPopover(){$(".user-popover").detach();$(".user-info").removeClass("active")}},{key:"popoverPosition",value:function popoverPosition(userInfo,popover,container){var minLength=10;var containerHeight=container.height();var containerWidth=container.width();var popoverWidth=popover.width();var popoverHeight=popover.height();var position=userInfo.getBoundingClientRect();var popoverOffset={top:position.top+position.height/2-popoverHeight/2,left:position.left+position.width};if(popoverOffset.left<0){popoverOffset.left=0}else if(popoverOffset.left+popoverWidth>containerWidth){popoverOffset.left=containerWidth-(popoverWidth+minLength)}if(popoverOffset.top<minLength){popoverOffset.top=minLength}else if(popoverOffset.top+popoverHeight>containerHeight){popoverOffset.top=containerHeight-(popoverHeight+minLength)}popover.offset(popoverOffset)}},{key:"addMention",value:function addMention(userId,callback){if(!crowdin.editor.layout.isOpened("right")){crowdin.panel.toggle_panel()}$("#comments_section").tab("show");$("#discussions_control textarea").focus();var user=this.users[userId];var text="@".concat(user.login," ");insert_in_textarea("#discussions_control textarea",text);if(callback&&typeof callback==="function"){callback()}}}]);return crowdin_users_helper}();
