"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}var crowdin_websocket=function(_CrowdinComponent){_inherits(crowdin_websocket,_CrowdinComponent);var _super=_createSuper(crowdin_websocket);function crowdin_websocket(){var _this;_classCallCheck(this,crowdin_websocket);_this=_super.call(this);_this.debug=false;_this.socket=null;_this.uri=null;_this.reconnectRetries=0;_this.reconnectTimeout=null;_this.subscriptions={};_this.pendingMessages=[];_this.uri=WEBSOCKETS_HOST;_this._connect();return _this}_createClass(crowdin_websocket,[{key:"supported",value:function supported(){return"WebSocket"in window}},{key:"connected",value:function connected(){return this.socket&&this.socket.readyState===WebSocket.OPEN}},{key:"subscribed",value:function subscribed(event){return!!this.subscriptions[event]}},{key:"subscribe",value:function subscribe(event,callback){if(!this.subscriptions[event]){this.subscriptions[event]=[]}this.subscriptions[event].push(callback);this._send({action:"subscribe",event:event})}},{key:"unsubscribe",value:function unsubscribe(event){delete this.subscriptions[event];this._send({action:"unsubscribe",event:event})}},{key:"_connect",value:function _connect(){if(!this.supported()){this._debug("websockets not supported");return}if(this.socket===null||this.socket.readyState===WebSocket.CLOSING||this.socket.readyState===WebSocket.CLOSED){var self=this;this.socket=new WebSocket(this.uri);this.socket.onopen=function(e){self._onopen(e)};this.socket.onclose=function(e){self._onclose(e)};this.socket.onerror=function(e){self._onerror(e)};this.socket.onmessage=function(e){self._onmessage(e.data)}}}},{key:"_reconnect",value:function _reconnect(){if(this.reconnectTimeout!==null){return}var reconnectIntervals=[2,3,5,8,13,21,34,55];var randomMultiplier=Math.random()*3;var interval=reconnectIntervals[this.reconnectRetries++]*randomMultiplier;if(!interval){interval=600}var self=this;this.reconnectTimeout=setTimeout((function(){self._connect();self.reconnectTimeout=null}),interval*1e3)}},{key:"_onopen",value:function _onopen(e){this._debug("websocket connection established!");this.reconnectRetries=0;while(this.pendingMessages.length){this._send(this.pendingMessages.shift())}this._trigger("onopen")}},{key:"_onclose",value:function _onclose(e){this._debug("websocket connection closed");for(var event in this.subscriptions){if(event!=="onopen"&&event!=="onclose"){delete this.subscriptions[event]}}this._trigger("onclose");if(e.code===1002){crowdin.trackEvent("Editor","Websockets","Protocol Error");return}this._reconnect()}},{key:"_onerror",value:function _onerror(e){this._debug("websocket error")}},{key:"_onmessage",value:function _onmessage(json){this._debug("websocket received message "+json);var data=JSON.parse(json);if(data&&data.event){this._trigger(data.event,data.data)}}},{key:"_trigger",value:function _trigger(event,data){if(this.subscriptions[event]){for(var i=0;i<this.subscriptions[event].length;i++){this.subscriptions[event][i](data)}}}},{key:"_send",value:function _send(payload){if(!this.supported()||payload.event==="onopen"||payload.event==="onclose"){return}var message=JSON.stringify(payload);if(this.socket!==null&&this.socket.readyState===WebSocket.OPEN){this.socket.send(message);this._debug("websocket sended message "+message)}else{this.pendingMessages.push(payload);this._reconnect()}}},{key:"_debug",value:function _debug(message){if(this.debug){console.log(message)}}}]);return crowdin_websocket}(CrowdinComponent);
